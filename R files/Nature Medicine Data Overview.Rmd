---
title: "<center>Characterizing the Physiology of Circulatory Arrest in Humans</center>"
author:
- "Jordan D. Bird^[jordan.bird@alumni.ubc.ca] & Mypinder S. Sekhon^[mypindersekhon@gmail.com] on behalf of the EVALUATE team"
date: "Last compiled on *`r format(Sys.time(), '%c')`*"
output: 
  html_document:
    highlight: monochrome
    theme: journal
    toc: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: FALSE
    number_sections: TRUE
    toc_depth: 5
    fig_width: 7
    fig_height: 6
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 6,
                      fig.width = 8.5,
                      fig.align = "center",
                      comment = NA, 
                      fig.show = "asis",
                      results = "asis",
                      collapse = FALSE,
                      echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```


# Introduction {-}
This document is meant to provide rationale for performing data analysis and statistical analysis for all data presented in [Characterizing the Physiology of Circulatory Arrest in Humans](https://www.nature.com/articles/s41591-025-03889-z). The code presented here is meant to be a single file that with the 3 data file dependencies ***(main_data.xlsx, time_series_signals.csv, timing.csv)***, which will provide all logic behind how figures were created and how all statistics were run. As this code was developed by JDB from 2023 onwards, some library dependencies in R may alter the output of the data. As such, all library versions are herein reported to be able to hopefully provide readers an easy avenue to replicate the supported data as shared on figshare. Please let  [Dr. Mypinder Sekhon](mypindersekhon@gmail.com) or [myself](jordan.bird@alumni.ubc.ca) know if you have any questions or concerns.

## Dependencies {-}
|R Library| Version Number|
|:-|:-|
|$R$                |v4.3.1|
|$tidyverse$        |v2.0.0|
|$rstatix$          |v0.7.2|
|$lme4$             |v1.1-34|
|$ggplot2$          |v3.5.1|
|$ggrepel$          |v0.9.6|
|$ggpubr$           |v0.6.0|
|$markdown$         |v1.13|
|$readxl$           |v1.4.3|
|$kableExtra$       |v1.4.0|
|$dplyr$            |v1.1.3|

```{r Load required packages, include = FALSE}
x <- c("tidyverse", "ggpubr", "knitr", "kableExtra", "rstatix", "latex2exp", "plotly",
       "rlang", "broom", "broom.mixed", "RColorBrewer", "ggsci", "readxl",
       "lubridate", "lme4", "magick", "cowplot", "markdown", "viridis", "ggrepel", "ggExtra", "smplot2")
lapply(x, library, character.only = TRUE)
rm(x)


# The data will be accessible from Figshare
DATA_REPOSITORY_PATH <- "../data_input/main_data.xlsx"
DATA_TIMING_PATH <- "../data_input/timing.csv"
DATA_SIGNALS_PATH <- "../data_input/time_series_signals.csv"
```

# Demographics
```{r}
# Reading in the demographics data tab
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "demographics",
                 skip = 1)

# Renaming and mutating data
df <- df %>%
  rename(pH_a = pH_art,
         PaCO2 = PaCO2_art,
         PaO2 = PaO2_art,
         pH_jv = pH_JB,
         PjvCO2 = PvCO2_JB,
         PjvO2 = PvO2_JB) %>%
  mutate(Sex = factor(Sex, levels = c("Male", "Female")),
         SO2_av = ifelse(!is.na(SaO2) & !is.na(SjvO2), SaO2 - SjvO2, NA),
         pH_av = ifelse(!is.na(pH_a) & !is.na(pH_jv), pH_a - pH_jv, NA),
         PCO2_av = ifelse(!is.na(PaCO2) & !is.na(PjvCO2), PaCO2 - PjvCO2, NA),
         PO2_av = ifelse(!is.na(PaO2) & !is.na(PjvO2), PaO2 - PjvO2, NA),
         HCO3_a = ifelse(!is.na(PaCO2) & !is.na(pH_a), 0.03*PaCO2*10^(pH_a - 6.1), NA),
         HCO3_jv = ifelse(!is.na(PjvCO2) & !is.na(pH_jv), 0.03*PjvCO2*10^(pH_jv - 6.1), NA),
         HCO3_av = ifelse(!is.na(HCO3_a) & !is.na(HCO3_jv), HCO3_a - HCO3_jv, NA))

# Sex
df %>% select(ID, Sex, Diagnosis) %>%
  group_by(Sex) %>%
  summarize(Count = n()) %>%
  mutate(Prevalence = paste0(round(Count/sum(Count)*100,2), "%")) %>%
  kable(., caption = "Sex of the Critically Ill Patient Cohort (N = 32) & Medical Assistance in Dying Cohort (N=3)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  print()

# Etiology
df %>% filter(Cohort == 1) %>%
  select(ID, Sex, Diagnosis) %>%
  group_by(Diagnosis) %>%
  summarize(Count = n()) %>%
  mutate(Prevalence = paste0(round(Count/sum(Count)*100,2), "%")) %>%
  arrange(desc(Count)) %>%
  kable(., caption = paste0("Diagnosis Prevalence in the Critically Ill Patient Cohort (N = ", df%>%filter(Cohort == 1)%>%nrow(), ")")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  print()

# Continuous Variables
df %>% filter(Cohort == 1) %>%
  # filter(Diagnosis == "HIBI") %>%   # Only looking at hypoxic ischemic brain injury patients.
  filter(ID != "HIBI 25", ID != "HIBI 32") %>%
  select(ID, Age, pH_a:last_col()) %>%
  relocate(ID, Age,
           SaO2, SjvO2, SO2_av,
           PaO2, PjvO2, PO2_av,
           PaCO2, PjvCO2, PCO2_av,
           HCO3_a, HCO3_jv, HCO3_av,
           pH_a, pH_jv, pH_av) %>%
  get_summary_stats(type = "full") %>%
  kable(., caption = "Continuous Variables for Critically Ill Patient Cohort") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  add_footnote(c("HCO3- values were calculated from the Henderson-Hasselbach equation using PCO2 and pH values.",
                 "Physiologic Dead Space was calculated as per Bohr's Method from West's Respiratory Physiology 11th Edition.",
                 "av is for arterial-to-jugular venous gradients denoting changes that occur across the brain.")) %>%
  print()
```

# Main Text Data {.tabset}

## FIGURES {- .tabset}

### Figure 1 {-}
```{r Preparation of Data}
# Reading in the timing data
df <- read_csv(file = DATA_TIMING_PATH) 

# Factoring data to display as {Etiology IDn+Organ Donation Status, Biological Sex}
# Data was organized based on the length of time by individual etiology to reach pulseless electrical activity (PEA)
TIMINGS_GRAPH <- df %>%
  mutate(ID = factor(ID,
                     levels = c("HIBI 16", "HIBI 8", "HIBI 10", "HIBI 29", "HIBI 24",
                                "HIBI 4", "HIBI 3", "HIBI 21",
                                "HIBI 11", "HIBI 2", "HIBI 32", "HIBI 5", "HIBI 12", "HIBI 7",
                                "Sepsis 14", "Sepsis 9", "Sepsis 31", "Sepsis 19", "Sepsis 1", "Sepsis 22",
                                "TBI 6", "TBI 15", "TBI 18", "TBI 27", "TBI 28", "TBI 30",
                                "ICH 20", "ICH 26", "ICH 17",
                                "SAH 23", "HIBI 25", "ICH 13",
                                "MAID 1", "MAID 2", "MAID 3"),
                     labels = c("HIBI 16*, M", "HIBI 8, F", "HIBI 10, M", "HIBI 29, F", "HIBI 24, M",
                                "HIBI 4*, M", "HIBI 3, F", "HIBI 21*, M",
                                "HIBI 11, M", "HIBI 2, M", "HIBI 32*, M", "HIBI 5*, M", "HIBI 12, M", "HIBI 7, M",
                                "Sepsis 14, M", "Sepsis 9, F", "Sepsis 31, M", "Sepsis 19*, M", "Sepsis 1, M", "Sepsis 22, F",
                                "TBI 6, M", "TBI 15*, M", "TBI 18, M", "TBI 27, M", "TBI 28, M", "TBI 30, M",
                                "ICH 20, F", "ICH 26*, M", "ICH 17, M",
                                "SAH 23, F", "HIBI 25, M", "ICH 13, M",
                                "MAID 1, M", "MAID 2, M", "MAID 3, M")))

timing <- df
```

```{r Figure 1A, fig.height=4.5, fig.width=8.6}
Figure1 <- TIMINGS_GRAPH %>%
  filter(!is.na(ID)) %>%
  filter(!is.na(WLST_to_PEA)) %>%
  select(ID,
         WLST_to_SBP60,
         WLST_to_MCA,
         WLST_to_PCA,
         WLST_to_PEA,
         WLST_to_VE,
         WLST_to_EA) %>%
  pivot_longer(WLST_to_SBP60:last_col()) %>%
  mutate(value = as.integer(seconds(value))) %>%
  pivot_wider(names_from = name, values_from = value) %>%
  rename(`SBP <60 mmHg` = WLST_to_SBP60,
         `Last Breath` = WLST_to_VE,
         `WLST to MCA` = WLST_to_MCA,
         `WLST to PCA` = WLST_to_PCA,
         `WLST to PP <5 mmHg` = WLST_to_PEA,
         `Electrical Asystole` = WLST_to_EA) %>%
  pivot_longer(`SBP <60 mmHg`:last_col(),
               names_to = "Timepoint",
               values_to = "Time") %>%
  mutate(Timepoint = factor(Timepoint, levels = c("WLST to PP <5 mmHg",
                                                  "Electrical Asystole",
                                                  "WLST to MCA",
                                                  "WLST to PCA",
                                                  "SBP <60 mmHg",
                                                  "Last Breath"),
                            ordered = TRUE))

fig1a <- Figure1 %>%
  ggplot(., aes(y = fct_rev(ID))) +
  annotate(geom = "rect", xmin = 0, xmax = 60*60*7, ymin = 0, ymax = 3.5, alpha = 0.1, fill = "#7E6148", color = NA) +
  geom_vline(xintercept = seq(from = 0, to = 60*60*6.5, by = 30*60), color = "grey", alpha = 0.5, linewidth = 0.5) +
  geom_text(aes(x = 7*60*60*0.95,
                y = 3,
                label = "Controls"),
            hjust = 1,
            vjust = 1,
            fontface = 4,
            size = 3,
            color = "black") +
  geom_col(data = . %>% filter(Timepoint == "Electrical Asystole"),
           aes(x = Time, fill = Timepoint),
           color = "white",
           width = 0.8,
           position = position_dodge(width = 0.9),
           linewidth = 0.3) +
  geom_col(data = . %>% filter(Timepoint == "WLST to PP <5 mmHg"),
           aes(x = Time, fill = Timepoint),
           color = "white",
           width = 0.8,
           position = position_dodge(width = 0.9),
           linewidth = 0.3) +
  geom_col(data = . %>% filter(Timepoint == "WLST to MCA"),
           aes(x = Time, fill = Timepoint),
           color = "black",
           position = position_dodge(width = 0.9),
           width = 0.23,
           just = 0,
           linewidth = 0.3) +
  geom_col(data = . %>% filter(Timepoint == "WLST to PCA"),
           aes(x = Time, fill = Timepoint),
           color = "black",
           position = position_dodge(width = 0.9),
           width = 0.23,
           just = 1,
           linewidth = 0.3) +
  scale_fill_manual(breaks = c("WLST to MCA", "WLST to PCA", "WLST to PP <5 mmHg", "Electrical Asystole"),
                    values = c("#E64B35", "#4DBBD5", "#000000", "#F39B7F"),
                    labels = c("MCAv\nCessation", "PCAv\nCessation", "Pulseless\nElectrical\nActivity", "Electrical\nAsystole")) +
  geom_col(data = . %>% filter(Timepoint == "SBP <60 mmHg"),
           aes(x = Time),
           fill = NA,
           color = "white",
           width = 0.8,
           position = position_dodge(width = 0.9),
           linewidth = 0.3, show.legend = FALSE) +
  geom_point(data = . %>% filter(Timepoint == "SBP <60 mmHg"),
             aes(x = Time),
             position = position_dodge(width = 0.9), color = "black", size = 1.5, shape = 18) +
  geom_point(data = . %>% filter(Timepoint == "SBP <60 mmHg"),
             aes(x = Time, color = "white"),
             position = position_dodge(width = 0.9), size = 1, legend = TRUE, shape = 18) +
  geom_col(data = . %>% filter(Timepoint == "Last Breath"),
           aes(x = Time),
           fill = NA,
           color = "white",
           width = 0.8,
           position = position_dodge(width = 0.9),
           linewidth = 0.3, show.legend = FALSE) +
  geom_point(data = . %>% filter(Timepoint == "Last Breath"),
             aes(x = Time),
             position = position_dodge(width = 0.9), color = "black", size = 1) +
  geom_point(data = . %>% filter(Timepoint == "Last Breath"),
             aes(x = Time, color = "#00A087"),
             position = position_dodge(width = 0.9), size = 0.5, legend = TRUE) +
  geom_label(aes(x = 4.75*60*60, y = 16,
                label = paste0("Median time to MCA: 43 [26, 123] min\n",
                               "Median time to PCA: 41 [19, 125] min\n",
                               "Median time to PEA: 46 [29, 130] min\n",
                               "Median time to EA: 49 [32, 136] min")),
            hjust = 0,
            vjust = 0.5,
            fontface = 4,
            size = 3,
            fill = "lightgrey",
            alpha = 0.7) +
  scale_color_manual(values = c("white", "#00A087"),
                     name = "",
                     labels = c("Systolic\n<60 mmHg", "Last Breath")) +
  xlab("Time from Extubation (hours)") +
  scale_x_continuous(breaks = c(0, 60*60, 120*60, 180*60, 240*60, 300*60, 360*60),
                     labels = c("0", "1", "2", "3", "4", "5", "6"),
                     limits = c(0,60*60*7), expand = c(0,0)) +
  scale_y_discrete(expand = c(0,1)) +
  theme_pubr(legend = "bottom") +
  guides(
    color = guide_legend(title = "Timepoint", order = 1, override.aes = list(size = 3,
                                                                             fill = c("#00A087", "white"),
                                                                             colour= c("black", "black"),
                                                                             pch= c(23, 21))),
    fill = guide_legend(title = NULL, order = 2, override.aes = list(colour = "black",
                                                                     size = 0.5))) +
  theme(plot.title = element_text(face="bold"),
        axis.text.y = element_text(hjust = 0, size = 8, face = "bold"),
        axis.title.y = element_blank(),
        axis.line.y = element_line(color = "black"),
        legend.margin = unit(0.2, "cm"),
        legend.title = element_text(colour="black", size=9, 
                                    face="bold"),
        legend.text = element_text(size = 7, face="bold.italic", vjust = 0.5),
        legend.title.align=0.5,
        legend.key.size = unit(0.7, "cm"))


# Saving Figure 1A into the data_output graphs folder
ggsave(filename = "../data_output/graphs/Figure 1A.pdf", fig1a, width = 8.6, height = 4.5, dpi = 1200)

# Printing Figure 1A in the RMarkdown
fig1a + ggtitle("A")
rm(fig1a)
```

```{r Figure 1B, fig.height=4.2, fig.width=8.6}
Figure1 <- TIMINGS_GRAPH %>% 
  filter(!is.na(ID)) %>%
  filter(!is.na(WLST_to_PEA)) %>%
  select(ID, WLST_to_MCA, WLST_to_PCA, PP_NoCBF) %>%
  pivot_longer(!c(ID, PP_NoCBF)) %>%
  mutate(value = as.integer(seconds(value))) %>%
  pivot_wider(names_from = name, values_from = value) %>%
  mutate(difference = WLST_to_MCA - WLST_to_PCA,
         CESSATION = case_when(
           difference < 0 ~ "MCA",
           difference > 0 ~ "PCA",
           difference == 0 ~ "Same"
         ),
         difference = abs(difference)) %>%
  drop_na() %>%
  rename(Time = difference) %>%
  mutate(Time_diff = if_else(CESSATION == "PCA", Time, -1*Time))

stats <- Figure1 %>% select(Time_diff) %>% get_summary_stats(type = "five_number")

fig1b <- Figure1 %>%
  ggplot(., aes(x = Time, y = fct_rev(ID), fill = CESSATION)) +
  annotate(geom = "rect", xmin = 0, xmax = 57*60, ymin = 0, ymax = 3.5, alpha = 0.1, fill = "#7E6148", color = NA) +
  geom_vline(xintercept = seq(from = 0, to = 57*60, by = 5*60), color = "grey", alpha = 0.5, linewidth = 0.5) +
  geom_text(aes(x = 57*60*0.8,
                y = 3,
                label = "Controls"),
            hjust = 1,
            vjust = 1,
            fontface = 4,
            size = 3,
            color = "black") +
  geom_col(color = "white",
           width = 0.8,
           position = position_dodge(width = 0.9),
           linewidth = 0.3) +
  geom_text(aes(label = PP_NoCBF),
            nudge_x = 3,
            size = 2,
            hjust = 0,
            fontface = 4) +
  geom_label(data = stats,
             aes(x = 36*60, y = 16,
                 label = paste0("Median time difference: ", median, " [", q1, ", ", round(q3, 0), "] sec\n",
                                "Median SBP at cessation: 37 [29, 47] mmHg\n",
                                "Median MAP at cessation: 29 [25, 38] mmHg\n",
                                "Median PP at cessation:  13 [8, 19] mmHg")),
             hjust = 0,
             vjust = 0.5,
             fontface = 4,
             size = 3,
             fill = "lightgrey",
             alpha = 0.7) +
  scale_fill_manual(breaks = c("MCA", "PCA", "Same"),
                    values = c("#4DBBD5", "#E64B35",  "#000000"),
                    labels = c("MCAv ceased after PCAv\nN = 17 (55%)",
                               "PCAv ceased after MCAv\nN = 4 (13%)",
                               "Ceased at the same time\nN = 10 (32%)")) +
  xlab("Time difference between Cessation of Cerebral Blood Velocities (minutes)") +
  scale_x_continuous(breaks = seq(0, 55*60, 5*60),
                     labels = seq(0, 55, 5),
                     limits = c(0, 57*60), expand = c(0,0)) +
  scale_y_discrete(expand = c(0,1)) +
  guides(
    fill = guide_legend(title = NULL, order = 2, override.aes = list(colour = "black",
                                                                     fill = c("#E64B35", "#4DBBD5", "#000000"),
                                                                     size = 0.5))) +
  theme_pubr(legend = "bottom") +
  theme(plot.title = element_text(face="bold"),
        axis.text.y = element_text(hjust = 0, size = 8, face = "bold"),
        axis.title.y = element_blank(),
        axis.line.y = element_line(color = "black"),
        axis.text.x.top = element_blank(),
        axis.ticks.x.top = element_blank(),
        axis.line.x.top = element_blank(),
        legend.position = c(0.85, 0.88),
        legend.text = element_text(size = 9, face="bold.italic"),
        legend.margin = unit(0.3, "cm"),
        legend.key.size = unit(0.6, "cm"),
        legend.key.spacing.y = unit(0.1, "cm")
        )

# Saving Figure 1A into the data_output graphs folder
ggsave(filename = "../data_output/graphs/Figure 1B.pdf", fig1b, width = 8.6, height = 4, dpi = 1200)

# Printing Figure 1A in the RMarkdown
fig1b + ggtitle("B")
rm(fig1b)
```

```{r Figure 1C, fig.height=4.2, fig.width=8.6}
Figure1 <- TIMINGS_GRAPH %>% 
  filter(!is.na(ID)) %>%
  filter(!is.na(WLST_to_PEA)) %>%
  select(ID, MCA_to_PEA, PCA_to_PEA, MCA_to_EA, PCA_to_EA) %>%
  pivot_longer(MCA_to_PEA:last_col()) %>%
  mutate(value = as.integer(seconds(value))) %>%
  pivot_wider(names_from = name, values_from = value) %>%
  mutate(TCD = ifelse(MCA_to_PEA < PCA_to_PEA, MCA_to_PEA, PCA_to_PEA),
         TCD = ifelse(is.na(MCA_to_PEA), PCA_to_PEA, TCD),
         TCD = ifelse(is.na(PCA_to_PEA), MCA_to_PEA, TCD),
         ASYS = ifelse(MCA_to_EA < PCA_to_EA, MCA_to_EA, PCA_to_EA),
         ASYS = ifelse(is.na(MCA_to_EA), PCA_to_PEA, ASYS),
         ASYS = ifelse(is.na(PCA_to_EA), MCA_to_PEA, ASYS)) %>%
  select(ID, TCD, ASYS) %>%
  pivot_longer(TCD:last_col(), names_to = "Timepoint", values_to = "Time")

fig1c <- Figure1 %>%
  ggplot(., aes(y = fct_rev(ID))) +
  annotate(geom = "rect", xmin = 0, xmax = 38*60, ymin = 0, ymax = 3.5, alpha = 0.1, fill = "#7E6148", color = NA) +
  geom_vline(xintercept = seq(from = 0, to = 60*40, by = 60), color = "grey", alpha = 0.5, linewidth = 0.5) +
  geom_text(aes(x = 38*60*0.95,
                y = 3,
                label = "Controls"),
            hjust = 1,
            vjust = 1,
            fontface = 4,
            size = 3,
            color = "black") +
  geom_col(data = . %>% filter(Timepoint == "ASYS"),
           aes(x = Time, fill = Timepoint),
           color = "white",
           width = 0.8,
           position = position_dodge(width = 0.9),
           linewidth = 0.3) +
  geom_col(data = . %>% filter(Timepoint == "TCD"),
           aes(x = Time, fill = Timepoint),
           color = "white",
           width = 0.8,
           position = position_dodge(width = 0.9),
           linewidth = 0.3) +
  geom_label(aes(x = 37*60*5/7, y = 17,
                 label = paste0("Median time to PEA: 102 [40, 250] sec\n",
                                "Median time to EA: 397 [154, 708] sec")),
             hjust = 0,
             vjust = 0.5,
             fontface = 4,
             size = 3,
             fill = "lightgrey",
             alpha = 0.7) +
  scale_fill_manual(breaks = c("TCD", "ASYS"),
                    values = c("#000000", "#F39B7F"),
                    labels = c("Pulse Pressure <5 mmHg", "Asystole")) +
  xlab("Time from Cessation of Cerebral Blood Velocities (minutes)") +
  scale_x_continuous(breaks = c(0, 5*60, 600, 15*60, 20*60, 25*60, 30*60, 35*60),
                     labels = seq(0, 35, 5),
                     limits = c(0, 38*60), expand = c(0,0)) +
  scale_y_discrete(expand = c(0,1)) +
  theme_pubr(legend = "none") +
  theme(plot.title = element_text(face="bold"),
        axis.text.y = element_text(hjust = 0, size = 8, face = "bold"),
        axis.title.y = element_blank(),
        axis.line.y = element_line(color = "black"),
        axis.text.x.top = element_blank(),
        axis.ticks.x.top = element_blank(),
        axis.line.x.top = element_blank())

# Saving Figure 1A into the data_output graphs folder
ggsave(filename = "../data_output/graphs/Figure 1C.pdf", fig1c, width = 8.6, height = 4, dpi = 1200)

# Printing Figure 1A in the RMarkdown
fig1c + ggtitle("C")
rm(Figure1, fig1c)
```

```{r Figure 1D, fig.height=4.2, fig.width=8.6}
# Reading in the autopsy time data
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "autopsy_brain",
                 skip = 1) %>%
  mutate(TimeToAutopsy = as.numeric(TimeToAutopsy))

# Factoring ID so they are in a consistent order with the other panels
df <- df %>%
  mutate(ID = factor(ID,
                     levels = c("Sepsis 1", "HIBI 2", "HIBI 3", "HIBI 4", "HIBI 5",
                                "TBI 6", "HIBI 7", "HIBI 8", "Sepsis 9", "HIBI 10",
                                "HIBI 11", "HIBI 12", "ICH 13", "Sepsis 14", "TBI 15",
                                "HIBI 16", "ICH 17", "TBI 18", "Sepsis 19", "ICH 20",
                                "HIBI 21", "Sepsis 22", "SAH 23", "HIBI 24", "HIBI 25",
                                "ICH 26", "TBI 27", "TBI 28", "HIBI 29", "TBI 30",
                                "Sepsis 31", "HIBI 32", "MAID 1", "MAID 2", "MAID 3"),
                     labels = c("Sepsis 1, M", "HIBI 2, M", "HIBI 3, F", "HIBI 4, M", "HIBI 5, M",
                                "TBI 6, M", "HIBI 7, M", "HIBI 8, F", "Sepsis 9, F", "HIBI 10, M",
                                "HIBI 11, M", "HIBI 12, M", "ICH 13, M", "Sepsis 14, M", "TBI 15, M",
                                "HIBI 16, M", "ICH 17, M", "TBI 18, M", "Sepsis 19, M", "ICH 20, F",
                                "HIBI 21, M", "Sepsis 22, F", "SAH 23, F", "HIBI 24, M", "HIBI 25, M",
                                "ICH 26, M", "TBI 27, M", "TBI 28, M", "HIBI 29, F", "TBI 30, M",
                                "Sepsis 31, M", "HIBI 32, M", "MAID 1, M", "MAID 2, M", "MAID 3, M"))) %>%
  select(ID, TimeToAutopsy) %>%
  drop_na()

stats <- df %>% select(TimeToAutopsy) %>% drop_na() %>% get_summary_stats(type = "five_number")

fig1d <- df %>%
  ggplot(., aes(y = fct_rev(ID))) +
  annotate(geom = "rect", xmin = 0, xmax = 216, ymin = 0, ymax = 3.5, alpha = 0.1, fill = "#7E6148", color = NA) +
  geom_vline(xintercept = seq(0, 240, 24), color = "grey", alpha = 0.5, linewidth = 0.5) +
  geom_text(aes(x = 216*0.95,
                y = 3,
                label = "Controls"),
            hjust = 0.5,
            vjust = 1,
            fontface = 4,
            size = 3,
            color = "black") +
  geom_col(aes(x = TimeToAutopsy),
           color = "#3C5488",
           fill = "#3C5488",
           width = 0.8,
           position = position_dodge(width = 0.9),
           linewidth = 0.3) +
  xlab("Time from Death Determination to Autopsy (days)") +
  scale_x_continuous(limits = c(0, 216),
                     breaks = seq(0, 216, 24),
                     labels = seq(0, 9, 1),
                     expand = c(0,0)) +
  scale_y_discrete(expand = c(0,1)) +
  geom_label(data = stats,
             aes(x = 6*24, y = 20,
                label = paste0("Median time to Autopsy: ",
                               round(median(df$TimeToAutopsy), 0),
                               " [", round(q1, 0), ", ", round(q3, 0), "]",
                               " hrs\n",
                               "Range of time to Autopsy: [",
                               round(min(df$TimeToAutopsy), 0),
                               "-",
                               round(max(df$TimeToAutopsy), 0),
                               "] hrs")),
             hjust = 0,
             vjust = 0.5,
             fontface = 4,
             size = 3,
             fill = "lightgrey",
             alpha = 0.7) +
  theme_pubr() +
  theme(plot.title = element_text(face="bold"),
        axis.text.y = element_text(hjust = 0, size = 8, face = "bold"),
        axis.title.y = element_blank(),
        axis.line.y = element_line(color = "black"),
        legend.position = c(0.928, 0.5),
        legend.spacing.y = unit(0, "cm"),
        legend.margin = unit(10, "cm"),
        legend.title = element_text(colour="black", size=9, face="bold"),
        legend.text = element_text(size = 7, face="bold.italic"),
        legend.title.align=0.5,
        legend.key.size = unit(1, "cm"))

# Saving Figure 1A into the data_output graphs folder
ggsave(filename = "../data_output/graphs/Figure 1D.pdf", fig1d, width = 8.6, height = 4, dpi = 1200)

# Printing Figure 1A in the RMarkdown
fig1d + ggtitle("D")
rm(fig1d)
```

<center>
> ***Do the MCA and PCAv have a difference in timing from when they give out?***  </center>

```{r}
CESSATION <- timing %>%
  select(ID, WLST_to_MCA, WLST_to_PCA) %>%
  drop_na() %>%
  pivot_longer(WLST_to_MCA:last_col()) %>%
  mutate(value = as.numeric(seconds(value)))

pvalue <- CESSATION %>% rstatix::wilcox_test(data = ., value~name, paired = TRUE)
effect <- CESSATION %>% rstatix::wilcox_effsize(data = ., value ~ name, paired = TRUE)

# Cleaning up R environment
rm(pvalue, effect, CESSATION)
```
The time from WLST to cessation of PCAv was less than the time from WLST to cessation of MCAv (N = 28, r = 0.51, P = 0.01) with a *large* effect size.  

### Figure 2 {-}
```{r fig.width=15, fig.height=4.5}
# Reading in the intraparenchymal neuromonitoring cases
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "invasive", na = "NA")

#### Intraparenchymal Neuromonitoring Case 1 ####
df_temp <- df %>%
  filter(ID == "INV_HIBI_1") %>%
  filter(Variable %in% c("ICP", "CPP", "ABP", "PBTO2", "PP"))

fig2a <- df_temp %>% filter(Variable != "PP") %>%
  ggplot(., aes(x = bin_60s, y = mean, group = Variable)) +
  annotate("rect",
           xmin = 0, xmax = 30,
           ymin = 0, ymax = 150,
           alpha = 0.3,
           fill = "grey") +
  geom_text(x = 15,
                y = 150,
                label = "Baseline",
            hjust = 0.5,
            vjust = 1,
            fontface = 2,
            size = 4,
            color = "black") +
  geom_text(x = 167*0.5,
                y = 150,
                label = "Dying Process",
            hjust = 0.5,
            vjust = 1,
            fontface = 2,
            size = 4,
            color = "black") +
  geom_vline(xintercept = 135, linetype = "dotted", color = "black", alpha = 0.7) +
  geom_vline(xintercept = c(30, 137), linetype = "longdash", color = "black", alpha = 0.7) +
  geom_ribbon(aes(ymin = mean-sd, ymax = mean+sd), fill = "grey", alpha = 0.2) +
  geom_line(aes(color = Variable), linewidth = 1.15) +
  geom_line(data = df_temp %>% filter(bin_60s <= 30) %>% filter(Variable != "PP"), color = "black", linewidth = 1.15) +
  theme_pubr() +
  xlab("Time (minutes)") +
  ylab("Pressure (mmHg)") +
  scale_color_manual(breaks = c("ABP", "ICP", "CPP", "PBTO2"),
                     values = c("#E64B35", "#00A087", "#4DBBD5", "#3C5488"),
                     labels = c("MAP", "ICP", "CPP", expression(paste("PbtO"[2]))),
                     name = "Pressure (mmHg)") +
  scale_x_continuous(breaks = c(0, 30, 60, 90, 120, 137, 150),
                     labels = c("-30", "WLST", "30", "60", "90", "PEA", "120"),
                     limits = c(0, 153),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 150, 30),
                     expand = c(0,0),
                     limits = c(0, 150)) +
  theme(strip.text.x = element_text(size = 10, color = "blue", face = "bold.italic"),
        strip.text.y = element_text(size = 8, color = "black", face = "bold.italic"),
        strip.background = element_blank(),
        axis.text.x = element_text(size = 10, color = "black", face = "bold"),
        axis.text.y = element_text(size = 10, color = "black", face = "bold"), 
        # axis.text.y = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "black"),
        panel.border = element_blank(),
        strip.placement = "outside")

#### Intraparenchymal Neuromonitoring Case 2 ####
df_temp <- df %>%
  filter(ID == "INV_HIBI_2") %>%
  filter(Variable %in% c("ICP", "CPP", "ABP", "PBTO2", "PP"))

fig2b <- df_temp %>% filter(Variable != "PP") %>%
  ggplot(., aes(x = bin_60s, y = mean, group = Variable)) +
  annotate("rect",
           xmin = 0, xmax = 30,
           ymin = 0, ymax = 150,
           alpha = 0.3,
           fill = "grey") +
  geom_text(x = 15,
                y = 150,
                label = "Baseline",
            hjust = 0.5,
            vjust = 1,
            fontface = 2,
            size = 4,
            color = "black") +
  geom_text(x = 195*0.5,
                y = 150,
                label = "Dying Process",
            hjust = 0.5,
            vjust = 1,
            fontface = 2,
            size = 4,
            color = "black") +
  geom_vline(xintercept = 120, linetype = "dotted", color = "black", alpha = 0.7) +
  geom_vline(xintercept = c(30, 165), linetype = "longdash", color = "black", alpha = 0.7) +
  geom_ribbon(aes(ymin = mean-sd, ymax = mean+sd), fill = "grey", alpha = 0.2) +
  geom_line(aes(color = Variable), linewidth = 1.15) +
  geom_line(data = df_temp %>% filter(bin_60s <= 30) %>% filter(Variable != "PP"), color = "black", linewidth = 1.15) +
  theme_pubr() +
  xlab("Time (minutes)") +
  ylab("Pressure (mmHg)") +
  scale_color_manual(breaks = c("ABP", "ICP", "CPP", "PBTO2"),
                     values = c("#E64B35", "#00A087", "#4DBBD5", "#3C5488"),
                     labels = c("MAP", "ICP", "CPP", expression(paste("PbtO"[2]))),
                     name = "Pressure (mmHg)") +
  scale_x_continuous(breaks = c(0, 30, 60, 90, 120, 150, 165, 180),
                     labels = c("-30", "WLST", "30", "60", "90", "120", "PEA", "150"),
                     limits = c(0, 183),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 150, 30),
                     expand = c(0,0),
                     limits = c(0, 150)) +
  theme(strip.text.x = element_text(size = 10, color = "blue", face = "bold.italic"),
        strip.text.y = element_text(size = 8, color = "black", face = "bold.italic"),
        strip.background = element_blank(),
        axis.text.x = element_text(size = 10, color = "black", face = "bold"),
        axis.text.y = element_text(size = 10, color = "black", face = "bold"), 
        # axis.text.y = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "black"),
        panel.border = element_blank(),
        strip.placement = "outside")

#### Intraparenchymal Neuromonitoring Case 3 ####
df_temp <- df %>%
  filter(ID == "INV_HIBI_3") %>%
  filter(Variable %in% c("ICP", "CPP", "ABP", "PBTO2", "PP"))

fig2c <- df_temp %>% filter(Variable != "PP") %>%
  ggplot(., aes(x = bin_60s, y = mean, group = Variable)) +
  annotate("rect",
           xmin = 0, xmax = 30,
           ymin = 0, ymax = 150,
           alpha = 0.3,
           fill = "grey") +
  geom_text(x = 15,
                y = 150,
                label = "Baseline",
            hjust = 0.5,
            vjust = 1,
            fontface = 2,
            size = 4,
            color = "black") +
  geom_text(x = 204*0.5,
                y = 150,
                label = "Dying Process",
            hjust = 0.5,
            vjust = 1,
            fontface = 2,
            size = 4,
            color = "black") +
  geom_vline(xintercept = 180, linetype = "dotted", color = "black", alpha = 0.7) +
  geom_vline(xintercept = c(30, 184), linetype = "longdash", color = "black", alpha = 0.7) +
  geom_ribbon(aes(ymin = mean-sd, ymax = mean+sd), fill = "grey", alpha = 0.2) +
  geom_line(aes(color = Variable), linewidth = 1.15) +
  geom_line(data = df_temp %>% filter(bin_60s <= 30) %>% filter(Variable != "PP"), color = "black", linewidth = 1.15) +
  theme_pubr() +
  xlab("Time (minutes)") +
  ylab("Pressure (mmHg)") +
  scale_color_manual(breaks = c("ABP", "ICP", "CPP", "PBTO2"),
                     values = c("#E64B35", "#00A087", "#4DBBD5", "#3C5488"),
                     labels = c("MAP", "ICP", "CPP", expression(paste("PbtO"[2]))),
                     name = "Pressure (mmHg)") +
  scale_x_continuous(breaks = c(0, 30, 60, 90, 120, 150, 180, 184),
                     labels = c("-30", "WLST", "30", "60", "90", "120", "", "PEA"),
                     limits = c(0, 200),
                     expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 150, 30),
                     expand = c(0,0),
                     limits = c(0, 150)) +
  theme(strip.text.x = element_text(size = 10, color = "blue", face = "bold.italic"),
        strip.text.y = element_text(size = 8, color = "black", face = "bold.italic"),
        strip.background = element_blank(),
        axis.text.x = element_text(size = 10, color = "black", face = "bold"),
        axis.text.y = element_text(size = 10, color = "black", face = "bold"), 
        # axis.text.y = element_blank(),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "black"),
        panel.border = element_blank(),
        strip.placement = "outside")

# Arranging the data into Figure 2
fig <- ggarrange(fig2a, fig2b, fig2c,
                 nrow = 1, align = "hv",
                 labels = c("A", "B", "C"),
                 legend = "bottom",
                 common.legend = TRUE)

# Saving the first part of Figure 2 to the graph directory
ggsave(filename = "../data_output/graphs/Figure 2A-C.pdf",
       fig,
       width = 17,
       height = 4.5,
       dpi = 1200)

# Print the figure to the RMarkdown
fig
```

```{r Microdialysis Data, fig.width=3.5, fig.height=8.5}
# Reading in microdialysis data
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "microdialysis", na = "NA")

# Pivoting data longer
df <- df %>%
  pivot_longer(!Timepoint, names_to = "Microdialysis", values_to = "value") %>%
  mutate(Microdialysis = factor(Microdialysis,
                                levels = c("GLUCOSE",
                                           "LACTATE",
                                           "PYRUVATE",
                                           "LP_RATIO",
                                           "GLUTAMATE"),
                                labels = c("Glucose (mmol/L)",
                                           "Lactate (µmol/L)",
                                           "Pyruvate (mmol/L)",
                                           "LP Ratio",
                                           "Glutamate (µmol/L)"),
                                ordered = TRUE),
         ID = "1",
         Timepoint = factor(Timepoint,
                            levels = c("Pre-WLST", "During", "Post-Mortem"),
                            ordered = TRUE))

# Function for graphing the micodialysis data
micro <- function(df, variable = "Glucose (mmol/L)"){
  df <- df %>% filter(Microdialysis == variable)
  
  fig <- df %>%
    ggplot(., aes(x = Timepoint, y = value, group = ID)) +
    ylab(variable) +
    geom_point(size = 2, shape = 18, color = "black") +
    geom_line(linewidth = 1) +
    theme_pubr() +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.text.y = element_text(size = 11, color = "black"),
          axis.text.x = element_text(size = 11, color = "black", face = "bold.italic"),
          axis.title.y = element_text(face = "bold"),
          axis.title.x = element_blank())
}

# Glucose
figa <- micro(df) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 1.5), breaks = seq(0, 1.5, 0.5)) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

# Lactate
figb <- micro(df, "Lactate (µmol/L)") +
  scale_y_continuous(expand = c(0,0), limits = c(0, 16), breaks = seq(0, 16, 4)) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

# Pyruvate
figc <- micro(df, "Pyruvate (mmol/L)") +
  scale_y_continuous(expand = c(0,0), limits = c(0, 160), breaks = seq(0, 160, 40)) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

# Lactate:Pyruvate Ratio
figd <- micro(df, "LP Ratio") +
  scale_y_continuous(expand = c(0,0), limits = c(0, 800), breaks = seq(0, 800, 200)) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

# Glutamate
fige <- micro(df, "Glutamate (µmol/L)") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 170), breaks = seq(0, 150, 50))

# Arranging the panels into a figure
fig <- ggarrange(figa, figb, figc, figd, fige,
                 ncol = 1,
                 nrow = 5,
                 align = "hv")

# Saving the panel to the folder
ggsave(filename = "../data_output/graphs/Figure 2J.pdf",
       fig,
       width = 3.5,
       height = 8.5,
       dpi = 1200)

# Print the figure to the RMarkdown
fig
```

### Figure 3 {-}
```{r Preparation of df_signals needed for most figures}
# Preparation of df_signals which will be used for many of the following figures
df_signals <- read_csv(file = DATA_SIGNALS_PATH) 

df_signals <- df_signals %>% filter(Cohort == 1) %>% select(!Cohort)

# Creating nested dataframes that will be used for various purposes with the following data
df_signals <- df_signals %>%
  group_by(ID) %>%
  nest() %>%
  mutate(WLST = map(data, ~.x %>%
                      filter(TIME >= subset(.x$TIME,
                                                .x$Comment == "WLST") & TIME <= subset(.x$TIME, .x$Comment == "PP_5"))),
         TRUNC = map(data, ~.x %>%
                       filter(TIME >= subset(.x$TIME, .x$Comment == "DROP_OFF") & TIME <= subset(.x$TIME, .x$Comment == "PP_5"))))

# Resetting of row numbers and making a normalized time column for the WLST and TRUNC data as baseline data will not always be needed
df_signals <- df_signals %>%
  mutate(WLST = map(WLST, ~.x %>% mutate(RowN = row_number(),
                                         Rel_Time = RowN*10,
                                         Norm_Time = RowN/nrow(.x))),
         TRUNC = map(TRUNC, ~.x %>% mutate(RowN = row_number(),
                                           Rel_Time = RowN*10))
  )
```

```{r Figure 3B - rSO2 vs MAP, fig.width=8.5, fig.height=6}
# Selecting the truncated data for when signals start to change
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

df_temp <- df_temp %>% select(ID, ABP, RSO2_R, RSO2_L) %>% drop_na() %>%
  mutate(rSO2 = (RSO2_R + RSO2_L)/2) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

#### Selecting linear mixed effects model ####
# Random intercept
MODEL1 <- df_temp %>%
  lmer(rSO2 ~ ABP + (1 | ID), REML = TRUE, data = .)
# Random slope
MODEL2 <- df_temp %>%
  lmer(rSO2 ~ ABP + (0 + ABP | ID), REML = TRUE, data = .)
# Random slopes, random intercept
MODEL3 <- df_temp %>%
  lmer(rSO2 ~ ABP + (1 + ABP | ID), REML = TRUE, data = .)
output <- anova(MODEL1, MODEL2, MODEL3)

# Displaying the Linear Mixed Model selections used
output %>%
  kable(., caption = "Selection of Linear Mixed Effects Models after Comparison for rSO2.") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  add_footnote(c("Model 1 - Random Intercept",
                 "Model 2 - Random Slope",
                 "Model 3 - Random Slope and Random Intercept (Correlated)")) %>%
  print()

# The selected linear mixed model
LMM <- df_temp %>%
  ungroup() %>%
  nest() %>%
  mutate(model = map(data, ~lmer(rSO2 ~ ABP + (1 + ABP | ID), REML = TRUE, data = .x, weight = percent)),
         anova = map(model, anova),
         anova = map(anova, tidy),
         glance = map(model, tidy),
         augment = map(model, broom.mixed::augment)
  )

fig <- LMM %>% select(augment) %>% unnest(augment) %>%
  ggplot(., aes(x = ABP, y = rSO2)) +
  geom_point(size = 0.05, alpha = 0.1, show.legend = FALSE) +
  geom_line(aes(x = ABP, y = .fitted, group = ID),
            inherit.aes = FALSE, size = 1, alpha = 0.3, color = "#374e5570", linewidth = 0.7) +
  geom_smooth(method = lm, se = FALSE, aes(x = ABP, y = .fixed), color = "black", inherit.aes = FALSE, size = 1.2, alpha = 0.5) +
  xlab("MAP (mmHg)") +
  ylab(expression(paste("rSO"[2], " (%)"))) +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,115), expand = c(0,0)) +
  theme_pubr() +
  scale_color_jama() + 
  theme(plot.title = element_text(face="bold"))

# Adding in the marginal density plot to the right axis
fig <- ggMarginal(fig, colour = "black", fill = "#00A087", alpha = 0.8, size = 10)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/Figure 3B.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

```{r Figure 3C - rSO2 vs MAP (Etiology), fig.width=8.5, fig.height=6}
# This is Etiological comparisons of rSO2 vs MAP
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

df_temp <- df_temp %>% select(ID, ABP, RSO2_R, RSO2_L) %>% drop_na() %>%
  mutate(rSO2 = (RSO2_R + RSO2_L)/2) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

# Adding in an additional etiology factor based on what the ID tag was
df_temp <- df_temp %>%
  mutate(Etiology = if_else(str_detect(ID, "Sepsis"), "Sepsis", NA),
         Etiology = if_else(str_detect(ID, "HIBI"), "HIBI", Etiology),
         Etiology = if_else(str_detect(ID, "TBI"), "TBI", Etiology)) %>%
  drop_na()

# Linear Mixed Effects Model - MCAv vs MAP with an interaction term of patient etiology
LMM <- df_temp %>%
  ungroup() %>%
  nest() %>%
  mutate(model = map(data, ~lmer(rSO2 ~ ABP*Etiology + (1 + ABP | ID), REML = TRUE, data = .x, weight = percent)),
         anova = map(model, anova),
         anova = map(anova, tidy),
         glance = map(model, tidy),
         augment = map(model, broom.mixed::augment)
  )

# Creation of Figure 3C
fig <- LMM %>% select(augment) %>% unnest(augment) %>%
  ggplot(., aes(x = ABP, y = rSO2, color = Etiology)) +
  geom_point(size = 0.2, alpha = 0.1, show.legend = FALSE) +
  geom_line(aes(x = ABP, y = .fitted, group = interaction(ID, Etiology), color = Etiology), inherit.aes = FALSE, size = 1, alpha = 0.3) +
  geom_smooth(method = lm,
              se = FALSE,
              aes(x = ABP, y = .fixed, group = Etiology, color = Etiology),
              inherit.aes = FALSE, size = 1.5, alpha = 0.8) +
  xlab("MAP (mmHg)") +
  ylab(expression(paste("rSO"[2], " (%)"))) +
  guides(color = guide_legend(title = NULL, direction = "horizontal", order = 2, override.aes = list(size = 2.5))) +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,115), expand = c(0,0)) +
  theme_pubr(legend = "none") +
  scale_color_manual(breaks = c("HIBI", "TBI", "Sepsis"),
                     values = c("#8491B4", "#91D1C2",  "#F39B7F")) +
  theme(plot.title = element_text(face="bold"),
        legend.position = c(0.5, 1),
        legend.background = element_rect(fill= NA,
                                         size = 0.5, linetype = "solid",
                                         colour = NA),
        legend.title = element_text(colour="black", size=9,
                                    face="bold"),
        legend.text = element_text(face = "bold.italic", size = 8),
        legend.title.align=0.5)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/Figure 3C.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

> **Data Processing Notes**:  
> For linear mixed-effects models, we can choose either random intercepts (Model 1), random slopes (Model 2), or random slopes and random intercepts (Model 3). Visually, by just plotting the data we see that there is heterogeneity of slopes which is not surprising from a physiologic perspective so Model 2 and Model 3 seem more likely that they would fit. We also don't necessarily think that the intercepts will be identical between patients as perhaps cerebral blood velocities cease while there is still some presence of MAP (which we did eventually find). As such, Model 3 was the intuitively most accurate from a physiologic perspective when we first started considering this data.  

```{r Figure 3E - MCAv vs MAP, fig.width=8.5, fig.height=6}
# Selecting the truncated data for when signals start to change
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

df_temp <- df_temp %>% select(ID, ABP, MCA) %>% drop_na() %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

#### Selecting linear mixed effects model ####
# Random intercept
MODEL1 <- df_temp %>%
  lmer(MCA ~ ABP + (1 | ID), REML = TRUE, data = .)
# Random slope
MODEL2 <- df_temp %>%
  lmer(MCA ~ ABP + (0 + ABP | ID), REML = TRUE, data = .)
# Random slopes, random intercept
MODEL3 <- df_temp %>%
  lmer(MCA ~ ABP + (1 + ABP | ID), REML = TRUE, data = .)
output <- anova(MODEL1, MODEL2, MODEL3)

# Displaying the Linear Mixed Model selections used
output %>%
  kable(., caption = "Selection of Linear Mixed Effects Models after Comparison for MCAv.") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  add_footnote(c("Model 1 - Random Intercept",
                 "Model 2 - Random Slope",
                 "Model 3 - Random Slope and Random Intercept (Correlated)")) %>%
  print()
  
# The selected linear mixed model
LMM <- df_temp %>%
  ungroup() %>%
  nest() %>%
  mutate(model = map(data, ~lmer(MCA ~ ABP + (1 + ABP | ID), REML = TRUE, data = .x, weights = percent)),
         anova = map(model, anova),
         anova = map(anova, tidy),
         glance = map(model, tidy),
         augment = map(model, broom.mixed::augment)
  )

# Creation of Figure 3E
fig <- LMM %>% select(augment) %>% unnest(augment) %>%
  ggplot(., aes(x = ABP, y = MCA)) +
  geom_point(size = 0.05, alpha = 0.1, show.legend = FALSE) +
  geom_line(aes(x = ABP, y = .fitted, group = ID),
            inherit.aes = FALSE, size = 1, alpha = 0.3, color = "#374e5570", linewidth = 0.7) +
  geom_smooth(method = lm, se = FALSE, aes(x = ABP, y = .fixed), color = "black", inherit.aes = FALSE, size = 1.2, alpha = 0.5) +
  xlab("MAP (mmHg)") +
  ylab("MCAv (cm/s)") +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,105), expand = c(0,0)) +
  theme_pubr() +
  theme(plot.title = element_text(face="bold"))

# Adding in the marginal density plot to the right axis
fig <- ggMarginal(fig, colour = "black", fill = "#E64B35", alpha = 0.8, size = 10)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/Figure 3E.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

```{r Figure 3F - MCAv vs MAP (Etiology), fig.width=8.5, fig.height=6}
# This is Etiological comparisons of MCAv vs MAP
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

df_temp <- df_temp %>% select(ID, ABP, MCA) %>% drop_na() %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

# Adding in an additional etiology factor based on what the ID tag was
df_temp <- df_temp %>%
  mutate(Etiology = if_else(str_detect(ID, "Sepsis"), "Sepsis", NA),
         Etiology = if_else(str_detect(ID, "HIBI"), "HIBI", Etiology),
         Etiology = if_else(str_detect(ID, "TBI"), "TBI", Etiology)) %>%
  drop_na()

# Linear Mixed Effects Model - MCAv vs MAP with an interaction term of patient etiology
LMM <- df_temp %>%
  ungroup() %>%
  nest() %>%
  mutate(model = map(data, ~lmer(MCA ~ ABP*Etiology + (1 + ABP | ID),
                                 REML = TRUE,
                                 data = .x,
                                 weights = percent)),
         anova = map(model, anova),
         anova = map(anova, tidy),
         glance = map(model, tidy),
         augment = map(model, broom.mixed::augment)
  )

# Creation of Figure 3F
fig <- LMM %>% select(augment) %>% unnest(augment) %>%
  ggplot(., aes(x = ABP, y = MCA, color = Etiology)) +
  geom_point(size = 0.2, alpha = 0.1, show.legend = FALSE) +
  geom_line(aes(x = ABP, y = .fitted, group = interaction(ID, Etiology), color = Etiology),
            inherit.aes = FALSE, size = 1, alpha = 0.3) +
  geom_smooth(method = lm,
              se = FALSE,
              aes(x = ABP, y = .fixed, group = Etiology, color = Etiology),
              inherit.aes = FALSE, size = 1.5, alpha = 0.8) +
  xlab("MAP (mmHg)") +
  ylab("MCAv (cm/s)") +
  guides(color = guide_legend(title = NULL, direction = "horizontal", order = 2, override.aes = list(size = 2.5))) +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,110), expand = c(0,0)) +
  theme_pubr(legend = "none") +
  scale_color_manual(breaks = c("HIBI", "TBI", "Sepsis"),
                     values = c("#8491B4", "#91D1C2",  "#F39B7F")) +
  theme(plot.title = element_text(face="bold"),
        legend.position = c(0.5, 1),
        legend.background = element_rect(fill= NA,
                                         size = 0.5, linetype = "solid",
                                         colour = NA),
        legend.title = element_text(colour="black", size=9,
                                    face="bold"),
        legend.text = element_text(face = "bold.italic", size = 8),
        legend.title.align=0.5)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/Figure 3F.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

```{r Figure 3H - PCAv vs MAP, fig.width=8.5, fig.height=6}
# Selecting the truncated data for when signals start to change
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

df_temp <- df_temp %>% select(ID, ABP, PCA) %>% drop_na() %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

#### Selecting linear mixed effects model ####
# Random intercept
MODEL1 <- df_temp %>%
  lmer(PCA ~ ABP + (1 | ID), REML = TRUE, data = .)
# Random slope
MODEL2 <- df_temp %>%
  lmer(PCA ~ ABP + (0 + ABP | ID), REML = TRUE, data = .)
# Random slopes, random intercept
MODEL3 <- df_temp %>%
  lmer(PCA ~ ABP + (1 + ABP | ID), REML = TRUE, data = .)
output <- anova(MODEL1, MODEL2, MODEL3)

# Displaying the Linear Mixed Model selections used
output %>%
  kable(., caption = "Selection of Linear Mixed Effects Models after Comparison for PCAv.") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  add_footnote(c("Model 1 - Random Intercept",
                 "Model 2 - Random Slope",
                 "Model 3 - Random Slope and Random Intercept (Correlated)")) %>%
  print()

# The selected linear mixed model
LMM <- df_temp %>%
  ungroup() %>%
  nest() %>%
  mutate(model = map(data, ~lmer(PCA ~ ABP + (1 + ABP | ID), REML = TRUE, data = .x, weight = percent)),
         anova = map(model, anova),
         anova = map(anova, tidy),
         glance = map(model, tidy),
         augment = map(model, broom.mixed::augment)
  )

# Creation of Figure 3H
fig <- LMM %>% select(augment) %>% unnest(augment) %>%
  ggplot(., aes(x = ABP, y = PCA)) +
  geom_point(size = 0.05, alpha = 0.1, show.legend = FALSE) +
  geom_line(aes(x = ABP, y = .fitted, group = ID),
            inherit.aes = FALSE, size = 1, alpha = 0.3, color = "#374e5570", linewidth = 0.7) +
  geom_smooth(method = lm, se = FALSE, aes(x = ABP, y = .fixed), color = "black", inherit.aes = FALSE, size = 1.2, alpha = 0.5) +
  # ggtitle("B") +
  xlab("MAP (mmHg)") +
  ylab("PCAv (cm/s)") +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,105), expand = c(0,0)) +
  theme_pubr() +
  scale_color_jama() + 
  theme(plot.title = element_text(face="bold"))

# Adding in the marginal density plot to the right axis
fig <- ggMarginal(fig, colour = "black", fill = "#4DBBD5", alpha = 0.8, size = 10)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/Figure 3H.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

```{r Figure 3I - PCAv vs MAP (Etiology), fig.width=8.5, fig.height=6}
# This is Etiological comparisons of MCAv vs MAP
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

df_temp <- df_temp %>% select(ID, ABP, PCA) %>% drop_na() %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

# Adding in an additional etiology factor based on what the ID tag was
df_temp <- df_temp %>%
  mutate(Etiology = if_else(str_detect(ID, "Sepsis"), "Sepsis", NA),
         Etiology = if_else(str_detect(ID, "HIBI"), "HIBI", Etiology),
         Etiology = if_else(str_detect(ID, "TBI"), "TBI", Etiology)) %>%
  drop_na()

# Linear Mixed Effects Model - MCAv vs MAP with an interaction term of patient etiology
LMM <- df_temp %>%
  ungroup() %>%
  nest() %>%
  mutate(model = map(data, ~lmer(PCA ~ ABP*Etiology + (1 + ABP | ID),
                                 REML = TRUE,
                                 data = .x,
                                 weights = percent)),
         anova = map(model, anova),
         anova = map(anova, tidy),
         glance = map(model, tidy),
         augment = map(model, broom.mixed::augment)
  )

# Creation of Figure 3F
fig <- LMM %>% select(augment) %>% unnest(augment) %>%
  ggplot(., aes(x = ABP, y = PCA, color = Etiology)) +
  geom_point(size = 0.2, alpha = 0.1, show.legend = FALSE) +
  geom_line(aes(x = ABP, y = .fitted, group = interaction(ID, Etiology), color = Etiology),
            inherit.aes = FALSE, size = 1, alpha = 0.3) +
  geom_smooth(method = lm,
              se = FALSE,
              aes(x = ABP, y = .fixed, group = Etiology, color = Etiology),
              inherit.aes = FALSE, size = 1.5, alpha = 0.8) +
  xlab("MAP (mmHg)") +
  ylab("PCAv (cm/s)") +
  guides(
    color = guide_legend(title = NULL, direction = "horizontal", order = 2, override.aes = list(size = 2.5))) +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,105), expand = c(0,0)) +
  theme_pubr(legend = "none") +
  scale_color_manual(breaks = c("HIBI", "TBI", "Sepsis"),
                    values = c("#8491B4", "#91D1C2",  "#F39B7F")) +
  theme(plot.title = element_text(face="bold"),
        legend.position = c(0.5, 1),
        legend.background = element_rect(fill= NA,
                                         size = 0.5, linetype = "solid",
                                         colour = NA),
        legend.title = element_text(colour="black", size=9,
                                    face="bold"),
        legend.text = element_text(face = "bold.italic", size = 8),
        legend.title.align=0.5)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/Figure 3I.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

> As MCAv and PCAv have different starting baselines, is there an interaction effect when baselines are normalized to 100% of CBv going down to 0% CBv?  

```{r Normalized CBv responses to MAP changes}
# Selection of truncated data
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

# Selecting the MCAv and PCAv then pivoting them longer and making them a percentage of resting baselines.
# Data is pivoted longer so that an interaction term of Anterior vs Posterior cerebral circulation can be used in the model
df_temp <- df_temp %>% select(ID, ABP, MCA, PCA) %>%
  pivot_longer(MCA:PCA, names_to = "Vessel", values_to = "CBv") %>%
  drop_na() %>%
  group_by(ID, Vessel) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  mutate(data = map(data, ~.x %>% mutate(CBv_norm = .x$CBv/max(.x$CBv)))) %>%
  unnest(data)

# Calculating the linear mixed effect models for interaction of the cerebral circulation and how they change with MAP
LMM <- df_temp %>%
  ungroup() %>%
  nest() %>%
  mutate(model = map(data, ~lmer(CBv_norm ~ ABP*Vessel + (1 + Vessel*ABP | ID), REML = TRUE, data = .x, weight = percent)),
         anova = map(model, anova),
         anova = map(anova, tidy),
         glance = map(model, tidy),
         augment = map(model, broom.mixed::augment)
  )

# SUMMARY
LMM %>%
  select(anova) %>%
  unnest(anova) %>%
  kable(., caption = "Linear Mixed Models for whether there is an interaction between the MCAv and PCAv for MAP responses.") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  print()
```

```{r Medical Assistance in Dying Panels, fig.width=8.5, fig.height=6}
# Reading in the medical assistance in dying data
df_maid <- read_csv(file = DATA_SIGNALS_PATH) %>% filter(Cohort == 2) %>% select(!Cohort)

# Adding in a combined rSO2 data column
df_maid <- df_maid %>%
  mutate(rSO2 = case_when(
           !is.na(RSO2_L) & !is.na(RSO2_R) ~ ((RSO2_L + RSO2_R)/2),
           !is.na(RSO2_L) & is.na(RSO2_R) ~ RSO2_L,
           is.na(RSO2_L) & !is.na(RSO2_R) ~ RSO2_R,
           is.na(RSO2_L) & is.na(RSO2_R) ~ NA
         ))

# Setting up truncated data to only use the data from the dying process
df_maid <- df_maid %>%
  arrange(ID, TIME) %>%
  group_by(ID) %>%
  nest() %>%
  mutate(TRUNC = map(data,
                     ~.x %>% filter(TIME >= subset(.x$TIME, .x$Comment == "WLST") & TIME <= subset(.x$TIME, .x$Comment == "PEA"))))

#### MCAv vs MAP (MAID) ####
df_temp <- df_maid %>% select(!data) %>% unnest(TRUNC)

figa <- df_temp %>%
  ggplot(., aes(x = ABP, y = MCA, group = ID, color = ID)) +
  geom_point(size = 0.05, alpha = 0.5) +
  geom_smooth(method = lm, se = FALSE, alpha = 0.3, linewidth = 0.7) +
  xlab("MAP (mmHg)") +
  ylab("MCAv (cm/s)") +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,105), expand = c(0,0)) +
  scale_color_npg() +
  guides(
    color = guide_legend(title = NULL, order = 2, override.aes = list(size = 2.5))) +
  theme_pubr() +
  theme(plot.title = element_text(face="bold"),
        legend.position = c(0.12, 0.85),
        legend.background = element_rect(fill=NA,
                                         size=0.5, linetype="solid",
                                         colour =NA),
        legend.title = element_text(colour="black", size=9,
                                    face="bold"),
        legend.text = element_text(face = "bold.italic", size = 8),
        legend.title.align=0.5
        )

# Adding in the distribution of data
figa <- ggMarginal(figa, colour = "black", fill = "#E64B35", alpha = 0.8, size = 10)

# Printing the figure to RMarkdown
figa

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/Figure 3D.pdf",
       figa,
       width = 4,
       height = 3,
       dpi = 1200)

#### PCAv vs MAP (MAID) ####
figb <- df_temp %>%
  ggplot(., aes(x = ABP, y = PCA, group = ID, color = ID)) +
  geom_point(size = 0.05, alpha = 0.5) +
  geom_smooth(method = lm, se = FALSE, alpha = 0.3, linewidth = 0.7) +
  xlab("MAP (mmHg)") +
  ylab("PCAv (cm/s)") +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,105), expand = c(0,0)) +
  scale_color_npg() +
  guides(
    color = guide_legend(title = NULL, order = 2, override.aes = list(size = 2.5))) +
  theme_pubr() +
  theme(plot.title = element_text(face="bold"),
        legend.position = c(0.12, 0.85),
        legend.background = element_rect(fill=NA,
                                         size=0.5, linetype="solid",
                                         colour =NA),
        legend.title = element_text(colour="black", size=9,
                                    face="bold"),
        legend.text = element_text(face = "bold.italic", size = 8),
        legend.title.align=0.5
  )

figb <- ggMarginal(figb, colour = "black", fill = "#4DBBD5", alpha = 0.8, size = 10)

# Printing the figure to RMarkdown
figb

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/Figure 3G.pdf",
       figb,
       width = 4,
       height = 3,
       dpi = 1200)

#### rSO2 vs MAP (MAID) ####
# Note that this panel was never included in the final manuscript but it theoretically could replace Figure 3A
fig <- df_temp %>%
  ggplot(., aes(x = ABP, y = rSO2, group = ID, color = ID)) +
  geom_point(size = 0.05, alpha = 0.5) +
  geom_smooth(method = lm, se = FALSE, alpha = 0.3, linewidth = 0.7) +
  xlab("MAP (mmHg)") +
  ylab(expression(paste("rSO"[2], " (%)"))) +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(50,80), expand = c(0,0)) +
  scale_color_npg() +
  guides(
    color = guide_legend(title = NULL, order = 2, override.aes = list(size = 2.5))) +
  theme_pubr() +
  theme(plot.title = element_text(face="bold"),
        legend.position = c(0.12, 0.85),
        legend.background = element_rect(fill=NA,
                                         size=0.5, linetype="solid",
                                         colour =NA),
        legend.title = element_text(colour="black", size=9,
                                    face="bold"),
        legend.text = element_text(face = "bold.italic", size = 8),
        legend.title.align=0.5
  )

fig <- ggMarginal(fig, colour = "black", fill = "#3C5488", alpha = 0.8, size = 10)
```

### Figure 4 {-}
```{r Figure 4D, fig.width=8.5, fig.height=6}
# Selecting the full WLST data
df_temp <- df_signals %>% select(!data) %>% unnest(WLST)

# Selecting only the oxygen extraction data with the Normalized Time data for the x-axis
df_temp <- df_temp %>% select(ID, BRAIN_O2EF, MV_O2EF, Norm_Time, RowN) %>%
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data) %>%
  pivot_longer(BRAIN_O2EF:MV_O2EF) %>%
  filter(value >= 0) %>%
  mutate(Extraction = factor(name, levels = c("BRAIN_O2EF", "MV_O2EF"),
                             labels = c("Brain", "Systemic")))

# Preparing Figure 4D
fig <- df_temp %>%
  ggplot(., aes(x = Norm_Time,
                y = value,
                group = Extraction,
                color = Extraction,
                fill = Extraction,
                weight = percent)) +
  geom_point(aes(x = Norm_Time, y = value, group = Extraction, fill = Extraction)) +
  geom_rect(aes(xmin = -Inf, xmax = Inf), ymin = -Inf, ymax = Inf, fill = "white", color = "white") +
  geom_smooth(method = "loess", se = TRUE, size = 1, alpha = 0.8, color = "black") +
  xlab("Normalized Time") +
  ylab(expression(paste("O"[2], "EF (%)"))) +
  scale_y_continuous(limits = c(0,102), breaks = seq(0, 100, 20), expand = c(0,0)) +
  scale_x_continuous(breaks = c(0,1), limits = c(0,1.02),
                     labels = c("WLST", "PP <5"),
                     expand = c(0,0)) +
  theme_pubr() +
  scale_color_manual(breaks = c("Brain", "Systemic"),
                     values = c("#E64B35", "#4DBBD5"),
                     name = "Oxygen Extraction") +
  scale_fill_manual(breaks = c("Brain", "Systemic"),
                    values = c("#E64B35", "#4DBBD5"),
                    name = "Oxygen Extraction") +
  theme(plot.title = element_text(face="bold"),
        panel.spacing.x = unit(1, "lines"),
        strip.text.x = element_text(size = 12, color = "white", face = "bold.italic"),
        strip.background = element_rect(color = "white", fill = "#53585F"),
        legend.position = c(0.22, 0.85),
        legend.background = element_rect(fill="white",
                                         size=0.5, linetype="solid", 
                                         colour ="white"),
        legend.title = element_text(colour="black", size=9, 
                                    face="bold"),
        legend.text = element_text(face = "bold", size = 8),
        legend.title.align=0.5)

# Adding in the marginal density plot to the right axis
fig <- ggMarginal(fig, colour = "black", groupFill = TRUE, groupColour = TRUE, margin = "y", alpha = 0.5, size = 10)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/Figure 4D.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

```{r Figure 4E, fig.width=8.5, fig.height=6}
heatmap <- df_signals %>% select(ID, TRUNC) %>% unnest(TRUNC) %>%
  select(ID, BRAIN_O2EF, MV_O2EF) %>%
  drop_na() %>%
  filter(across(everything(), ~ . >= 0)) %>%
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x))))

df_heatmap <- heatmap %>%
  unnest(data) %>%
  mutate(bin_x = cut(MV_O2EF, breaks = seq(0,100, 2), labels = seq(0,98, 2)),
         bin_y = cut(BRAIN_O2EF, breaks = seq(0,100, 2), labels = seq(0,98, 2))) %>%
  group_by(bin_x, bin_y) %>%
  summarise(sum_z = sum(percent)) %>%
  mutate(sum_z = sum_z*100/length(heatmap$ID))    # % of data for each bin divided by #patients

df_heatmap <- df_heatmap %>%
  mutate(bin_y = as.numeric(as.character(bin_y)),
         bin_y = if_else(is.na(bin_y), 0, bin_y),
         bin_x = as.numeric(as.character(bin_x)))

fig <- df_heatmap %>%
  ggplot(., aes(x = bin_x, y = bin_y, fill = sum_z)) +
  geom_tile() +
  geom_abline(slope = 1, intercept = 0, color = "black", linetype = "longdash", linewidth = 0.2) +
  xlab(expression(paste("Systemic O"[2], "EF (%)"))) +
  ylab(expression(paste("Brain O"[2], "EF (%)"))) +
  scale_x_continuous(limits = c(0,102), breaks = seq(0, 100, 20), expand = c(0,0)) +
  scale_y_continuous(limits = c(0,102), breaks = seq(0, 100, 20), expand = c(0,0)) +
  theme_pubr() +
  guides(fill = guide_colourbar(barwidth = 0.3,
                                barheight = 3,
                                ticks.colour = "black",
                                frame.colour = "black",
                                size = "legend"))  +
  scale_fill_gradientn(breaks = c(0, 0.5, 1, 1.5),
                       colours = c("white", "#F39B7F", "#E64B35"),
                       name = "Data (%)") +
  theme(plot.title = element_text(face="bold"),
        panel.spacing.x = unit(1, "lines"),
        strip.text.x = element_text(size = 12, color = "white", face = "bold.italic"),
        strip.background = element_rect(color = "white", fill = "#53585F"),
        legend.position = c(0.15, 0.82),
        legend.background = element_rect(fill="white",
                                         size=0.5, linetype="solid", 
                                         colour ="white"),
        legend.title = element_text(colour="black", size=9, 
                                    face="bold"),
        legend.text = element_text(face = "bold", size = 8),
        legend.title.align=0.5)


ggsave(filename = "../data_output/graphs/Figure 4E.pdf", fig,
       width = 4,
       height = 3,
       dpi = 1200)
```


```{r Figure 4F, fig.width=8.5, fig.height=6}
# Selecting the truncated data for when signals start to change
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

# Selecting only the oxygen extraction data with the mean arterial pressure data
df_temp <- df_temp %>% select(ID, ABP, BRAIN_O2EF, MV_O2EF) %>% drop_na() %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data) %>%
  pivot_longer(c(BRAIN_O2EF, MV_O2EF)) %>%
  mutate(Extraction = factor(name, levels = c("BRAIN_O2EF", "MV_O2EF"),
                             labels = c("Brain", "Systemic")))

# Creation of Figure 4E
fig <- df_temp %>%
  ggplot(., aes(x = ABP, y = value, group = Extraction, color = Extraction, weight = percent)) +
  geom_point(aes(x = ABP, y = value, group = Extraction)) +
  geom_rect(aes(xmin = -Inf, xmax = Inf), ymin = -Inf, ymax = Inf, fill = "white", color = "white") +
  # geom_smooth(method = lm, se = TRUE, aes(x = ABP, y = value, fill = Vessel), color = "black", inherit.aes = TRUE, size = 1.2, alpha = 0.8) +
  geom_smooth(method = loess, se = TRUE, aes(x = ABP, y = value, fill = Extraction),
              color = "black", inherit.aes = TRUE, size = 1, alpha = 0.8) +
  xlab("MAP (mmHg)") +
  ylab(expression(paste("O"[2], "EF (%)"))) +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,102), expand = c(0,0)) +
  theme_pubr() +
  scale_color_manual(breaks = c("Brain", "Systemic"),
                     values = c("#E64B35", "#4DBBD5"),
                     name = "Oxygen Extraction") +
  scale_fill_manual(breaks = c("Brain", "Systemic"),
                    values = c("#E64B35", "#4DBBD5"),
                    name = "Oxygen Extraction") +
  theme(plot.title = element_text(face="bold"),
        legend.position = c(0.22, 0.85),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="white"),
        legend.title = element_text(colour="black", size=9, 
                                      face="bold"),
        legend.text = element_text(face = "bold", size = 8),
        legend.title.align=0.5)

# Adding in the marginal density plot to the right axis
fig <- ggMarginal(fig, colour = "black", groupFill = TRUE, groupColour = TRUE, margin = "y", alpha = 0.5, size = 10)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/Figure 4F.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

### Figure 5 {-}
> **Data Processing Notes**:  
> Tau and UCH-L1 were not linear over the full dilution range (4x, 20x, 100x). We had internal discussion about whether we only include Tau and UCH-L1 data at 4x, but we decided that as ***paired*** samples were run at the same dilution and our main question whether their are changes from Pre-WLST to Post-WLST, we decided to keep all dilution levels. There is pseudocode embedded in this RMarkdown to re-run the analysis without the higher dilutions for Tau and UCH-L1 (see *Serum Proteomics* code chunk). The positives of keeping the extra dilution data is the higher sample N for comparison for paired analysis.  

```{r Serum Proteomics}
# Reading in the Quanterix HD-X data
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "serum_proteomics")

# Making an Etiology column and calculating cerebral arteriovenous gradients (Arterial - Jugular Venous)
df <- df %>%
  separate(ID, into = c("Etiology", "ID"), sep = " ") %>%
  mutate(AV = Arterial - Jugular,
         Etiology = factor(Etiology,
                           levels = c("HIBI", "Sepsis", "TBI", "ICH", "SAH"),
                           ordered = TRUE)) %>%
  # filter(Etiology == "HIBI") %>%
  pivot_longer(c(Arterial, Jugular, AV), names_to = "Vessel", values_to = "CONCENTRATION") %>%
  mutate(Vessel = factor(Vessel,
                         levels = c("Arterial", "Jugular", "AV"),
                         ordered = TRUE)) %>%
  ## If this code is run, Tau and UCH-L1 will be dropped at higher dilutions. Drop_na() will remove all data not labeled "Keep".
  # mutate(keep = case_when(
  #   Biomarker == "GFAP" ~ "Keep",
  #   Biomarker == "Nf-L" ~ "Keep",
  #   Biomarker == "Tau" & Dilution == "4x" ~ "Keep",
  #   Biomarker == "UCH-L1" & Dilution == "4x" ~ "Keep"
  # )) %>%
  pivot_wider(names_from = "Timepoint", values_from = "CONCENTRATION") %>%
  drop_na() %>%
  pivot_longer(c(Pre, Post), names_to ="Timepoint", values_to = "CONCENTRATION") %>%
  mutate(Timepoint = factor(Timepoint,
                            levels = c("Pre", "Post"),
                            labels = c("Pre", "Post"),
                            ordered = TRUE)) %>%
  group_by(Biomarker, Vessel) %>%
  nest() %>%
  mutate(model = map(data, ~rstatix::wilcox_test(data = .x, CONCENTRATION ~ Timepoint, paired = TRUE, detailed = TRUE)),
         Effect = map(data, ~rstatix::wilcox_effsize(data = .x, CONCENTRATION ~ Timepoint, paired = TRUE, detailed = TRUE))) %>%
  mutate(data = if_else(Vessel == "AV",
                        map(data, ~.x %>% mutate(Neg = if_else(CONCENTRATION < 0, "NEG", "POS"),
                                                 LOG10 = log10(abs(CONCENTRATION)),
                                                 LOG10 = if_else(Neg == "NEG", -1*LOG10, LOG10))),
                        data
  ))

# Cleaning the data frame for statistics and effect sizes using two-sided Wilcoxon Sign Rank tests
df <- df %>%
  unnest(model) %>%
  select(Biomarker, Vessel, data, n1, p, Effect) %>%
  rename(pvalue = p,
         N = n1) %>%
  unnest(Effect) %>%
  select(Biomarker:pvalue, effsize) %>%
  mutate(pvalue = signif(pvalue, digits = 2),
         effsize = signif(effsize, digits = 2))

# Stock function for Arterial and Jugular Serum Biomarker panels in Figure 5
biomarker_graph <- function(df, BIOMARKER, VESSEL, graph_color = "#E64B35", YLAB = "GFAP (pg/mL)", stats_height = 6) {
  temp <- df %>% filter(Biomarker == BIOMARKER & Vessel == VESSEL)
  fig <- temp %>%
    unnest(data) %>%
    ggplot(., aes(x = Timepoint, y = log10(CONCENTRATION))) +
    ylab(YLAB) +
    geom_boxplot(aes(group = Timepoint),
                 width = 0.2,
                 color = "black",
                 fill = graph_color,
                 position = position_nudge(x = c(-0.2, 0.2))) +
    stat_summary(fun.y = mean,
                 geom = "point",
                 size = 3,
                 shape = 23,
                 fill = "white",
                 position = position_nudge(x = c(-0.2, 0.2))) +
    geom_point(aes(shape = Etiology),
               size = 2,
               alpha = 0.5,
               position = position_nudge(x = c(0.2, -0.2))) +
    geom_text(data = temp,
              aes(x = 1.5, y = stats_height,
                  label = paste0("N = ", N,
                                 ", r = ", effsize,
                                 ", P = ", pvalue)),
              fontface = "italic",
              size = 3, vjust = 1) +
    geom_line(aes(group = ID), position = position_nudge(x = c(0.2, -0.2))) +
    scale_x_discrete(labels = c("Pre", "Post"), expand = c(0.2,0.2)) +
    theme_pubr(legend = "none") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(size = 12, face = 4),
          legend.text = element_text(size = 12, face = 4),
          legend.title = element_text(size = 13, face = 4))
}

# Stock function for Cerebral Arteriovenous Gradient panels in Figure 5
biomarker_graph_AV <- function(df, BIOMARKER, graph_color = "#8491B4", YLAB = "GFAP (pg/mL)", stats_height = 6) {
  temp <- df %>% filter(Biomarker == BIOMARKER & Vessel == "AV")
  fig <- temp %>%
    unnest(data) %>%
    ggplot(., aes(x = Timepoint, y = LOG10)) +
    geom_hline(yintercept = 0, color = "grey", linetype = "longdash", alpha = 0.5) +
    ylab(YLAB) +
    geom_boxplot(aes(group = Timepoint),
                 width = 0.2,
                 color = "black",
                 fill = graph_color,
                 position = position_nudge(x = c(-0.2, 0.2))) +
    stat_summary(fun.y = mean,
                 geom="point",
                 size = 3,
                 shape = 23,
                 fill = "white",
                 position = position_nudge(x = c(-0.2, 0.2))) +
    geom_point(aes(shape = Etiology),
               size = 2,
               alpha = 0.5,
               position = position_nudge(x = c(0.2, -0.2))) +
    geom_text(data = temp,
              aes(x = 1.5, y = stats_height,
                  label = paste0("N = ", N,
                                 ", r = ", effsize,
                                 ", P = ", pvalue)),
              fontface = "italic",
              size = 3,
              vjust = 1) +
    geom_line(aes(group = ID), position = position_nudge(x = c(0.2, -0.2))) +
    scale_x_discrete(labels = c("Pre", "Post"), expand = c(0.2,0.2)) +
    theme_pubr(legend = "none") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(size = 12, face = 4),
          legend.text = element_text(size = 12, face = 4),
          legend.title = element_text(size = 13, face = 4))
}

#### GFAP ####
# Arterial
fig_gfap_a <- biomarker_graph(df, "GFAP", "Arterial", "#E64B35", YLAB = "GFAP (pg/mL)", stats_height = 6.2) +
  scale_y_continuous(breaks = c(2, 3, 4, 5, 6),
                     labels = c(expression("10"^2),
                                expression("10"^3),
                                expression("10"^4),
                                expression("10"^5),
                                expression("10"^6)),
                     limits = c(2, 6.2),
                     expand = c(0,0)) +
  theme(axis.title.y = element_text(size = 16, face = 4),
        axis.text.x = element_blank())

# Jugular
fig_gfap_v <- biomarker_graph(df, "GFAP", "Jugular", "#4DBBD5", YLAB = "GFAP (pg/mL)", stats_height = 6.2) +
  scale_y_continuous(breaks = c(2, 3, 4, 5, 6),
                     labels = c(expression("10"^2),
                                expression("10"^3),
                                expression("10"^4),
                                expression("10"^5),
                                expression("10"^6)),
                     limits = c(2, 6.2),
                     expand = c(0,0)) +
  ylab(NULL) +
  theme(axis.text.x = element_blank())

# Cerebral A-V Gradient
fig_gfap_av <- biomarker_graph_AV(df, "GFAP", YLAB = "GFAP (pg/mL)", stats_height = 6) +
  scale_y_continuous(breaks = c(-6, -3, 0, 3, 6),
                     labels = c(expression("-10"^6),
                                expression("-10"^3),
                                0,
                                expression("10"^3),
                                expression("10"^6)),
                     limits = c(-6, 6),
                     expand = c(0,0)) +
  ylab(NULL) +
  theme(axis.text.x = element_blank())

#### Nf-L ####
# Arterial
fig_nfl_a <- biomarker_graph(df, "Nf-L", "Arterial", "#E64B35", YLAB = "Nf-L (pg/mL)", stats_height = 5) +
  scale_y_continuous(breaks = c(2, 3, 4, 5),
                     labels = c(expression("10"^2),
                                expression("10"^3),
                                expression("10"^4),
                                expression("10"^5)),
                     limits = c(1.7, 5),
                     expand = c(0,0)) +
  theme(axis.title.y = element_text(size = 16, face = 4),
        axis.text.x = element_blank())

# Jugular
fig_nfl_v <- biomarker_graph(df, "Nf-L", "Jugular", "#4DBBD5", YLAB = "Nf-L (pg/mL)", stats_height = 5) +
  scale_y_continuous(breaks = c(2, 3, 4, 5),
                     labels = c(expression("10"^2),
                                expression("10"^3),
                                expression("10"^4),
                                expression("10"^5)),
                     limits = c(1.7, 5),
                     expand = c(0,0)) +
  ylab(NULL) +
  theme(axis.text.x = element_blank())

# Cerebral A-V Gradient
fig_nfl_av <- biomarker_graph_AV(df, "Nf-L", YLAB = "Nf-L (pg/mL)", stats_height = 4.3) +
  scale_y_continuous(breaks = c(-4, -2, 0, 2, 4),
                     labels = c(expression("-10"^4),
                                expression("-10"^2),
                                0,
                                expression("10"^2),
                                expression("10"^4)),
                     limits = c(-4.3, 4.3),
                     expand = c(0,0)) +
  ylab(NULL) +
  theme(axis.text.x = element_blank())

#### Tau ####
# Arterial
fig_tau_a <- biomarker_graph(df, "Tau", "Arterial", "#E64B35", YLAB = "Tau (pg/mL)", stats_height = 5) +
  scale_y_continuous(breaks = c(0, 1, 2, 3, 4, 5),
                     labels = c(expression("10"^0),
                                expression("10"^1),
                                expression("10"^2),
                                expression("10"^3),
                                expression("10"^4),
                                expression("10"^5)),
                     limits = c(0, 5),
                     expand = c(0,0)) +
  theme(axis.title.y = element_text(size = 16, face = 4),
        axis.text.x = element_blank())

# Jugular
fig_tau_v <- biomarker_graph(df, "Tau", "Jugular", "#4DBBD5", YLAB = "Tau (pg/mL)", stats_height = 5) +
  scale_y_continuous(breaks = c(0, 1, 2, 3, 4, 5),
                     labels = c(expression("10"^0),
                                expression("10"^1),
                                expression("10"^2),
                                expression("10"^3),
                                expression("10"^4),
                                expression("10"^5)),
                     limits = c(0, 5),
                     expand = c(0,0)) +
  ylab(NULL) +
  theme(axis.text.x = element_blank())

# Cerebral A-V Gradient
fig_tau_av <- biomarker_graph_AV(df, "Tau", YLAB = "Tau (pg/mL)", stats_height = 4.3) +
  scale_y_continuous(breaks = c(-4, -2, 0, 2, 4),
                     labels = c(expression("-10"^4),
                                expression("-10"^2),
                                0,
                                expression("10"^2),
                                expression("10"^4)),
                     limits = c(-4.3, 4.3),
                     expand = c(0,0)) +
  ylab(NULL) +
  theme(axis.text.x = element_blank())

#### UCH-L1 ####
# Arterial
fig_uchl1_a <- biomarker_graph(df, "UCH-L1", "Arterial", "#E64B35", YLAB = "UCH-L1 (pg/mL)", stats_height = 4) +
  scale_y_continuous(breaks = c(1, 2, 3, 4),
                     labels = c(expression("10"^1),
                                expression("10"^2),
                                expression("10"^3),
                                expression("10"^4)),
                     limits = c(1, 4),
                     expand = c(0,0)) +
  theme(axis.title.y = element_text(size = 16, face = 4))

# Jugular
fig_uchl1_v <- biomarker_graph(df, "UCH-L1", "Jugular", "#4DBBD5", YLAB = "UCH-L1 (pg/mL)", stats_height = 4) +
  scale_y_continuous(breaks = c(1, 2, 3, 4),
                     labels = c(expression("10"^1),
                                expression("10"^2),
                                expression("10"^3),
                                expression("10"^4)),
                     limits = c(1, 4),
                     expand = c(0,0)) +
  ylab(NULL)

# Cerebral A-V Gradient
fig_uchl1_av <- biomarker_graph_AV(df, "UCH-L1", YLAB = "UCH-L1 (pg/mL)", stats_height = 4) +
  scale_y_continuous(breaks = c(-4, -2, 0, 2, 4),
                     labels = c(expression("-10"^4),
                                expression("-10"^2),
                                0,
                                expression("10"^2),
                                expression("10"^4)),
                     limits = c(-4.2, 4.2),
                     expand = c(0,0)) +
  ylab(NULL)
```

```{r fig.width=8.5, fig.height=15, fig.cap="Serum blood-based neurologic biomarker comparisons using the Quanterix Argo HT platform. Red is for arterial, blue is for jugular venous, and purple is for cerebral A-V gradients."}
fig <- ggarrange(fig_gfap_a, fig_gfap_v, fig_gfap_av,
                 fig_nfl_a, fig_nfl_v, fig_nfl_av,
                 fig_tau_a, fig_tau_v, fig_tau_av,
                 fig_uchl1_a, fig_uchl1_v, fig_uchl1_av,
                 common.legend = TRUE,
                 legend = "bottom",
                 ncol = 3, nrow = 4,
                 align = "hv",
                 labels = c("C", "D", "E",
                            "G", "H", "I",
                            "K", "L", "M",
                            "O", "P", "Q"))

fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/Figure 5 Serum.pdf",
       fig,
       width = 7.5,
       height = 10.5,
       dpi = 1200)
# Removing unneeded panels from the global environment
rm(list = str_subset(ls(), "fig_"))
```

---

```{r Plasma Proteomics}
# Reading in the Alamar NULISA NPQ data
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "plasma_proteomics")

# Filtering out the quality control data
df <- df %>% filter(!is.na(Timepoint))

# Pivoting biomarkers longer and seperating IDs into an etiology column
df <- df %>%
  pivot_longer(!(Study:Matrix), names_to = "BIOMARKER", values_to = "CONCENTRATION") %>%
  rename(TIMEPOINT = Timepoint,
         VESSEL = Vessel) %>%
  mutate(ID2 = ID) %>%
  separate(ID2, into = c("ETIOLOGY", NA), sep = " ", extra = "drop") %>%
  relocate(ETIOLOGY, ID, TIMEPOINT, VESSEL, BIOMARKER, CONCENTRATION) %>%
  select(!c(Study, Matrix))

## THEORY BEHIND DATA MANIPULATION
# Data is represented as log2 data so in order for gradient analysis to take place, data first needs to be exponentiated.
# Once data is exponentiated, it can be subtracted for cerebral gradient analysis (Arterial - Jugular venous).
# The sign of the AV analysis the tells you the direction of exchange but we can't log transform negative numbers.
# Data is thus converted to either uptake or release from the brain based on the sign for the AV gradient.
# All data is then taken as absolute values and log transformed where the negative sign is then added back depending on whether
# concentration values are greater or less than 1 as that can lead to improper direction of analysis.
df_av <- df %>% 
  rename(log2 = CONCENTRATION) %>%
  mutate(ABS = 2^log2) %>%
  select(!log2) %>%
  pivot_wider(names_from = VESSEL, values_from = ABS) %>%
  mutate(AV = if_else(!is.na(Arterial) & !is.na(Jugular), Arterial-Jugular, NA)) %>%
  pivot_longer(c(Arterial, Jugular, AV), names_to = "VESSEL", values_to = "ABS") %>%
  mutate(SIGN = if_else(VESSEL == "AV" & ABS > 0, "Uptake", NA),
         SIGN = if_else(VESSEL == "AV" & ABS < 0, "Release", SIGN),
         log2 = log2(abs(ABS)),
         log2 = if_else(SIGN == "Release" & log2 > 1, -1*log2, log2),
         log2 = if_else(is.na(SIGN), log2(abs(ABS)), log2),
         log2 = if_else(ABS == 0, 0, log2)) %>%
  filter(!is.na(ABS))

# Testing normality of distribution for data using the Shapiro-Wilkes Test
df_av <- df_av %>%
  select(!ABS) %>%
  group_by(TIMEPOINT, BIOMARKER, VESSEL) %>%
  nest() %>%
  mutate(Shapiro = map(data, ~rstatix::shapiro_test(.x$log2))) %>%
  unnest(Shapiro) %>%
  select(!c(variable, statistic)) %>%
  rename(SW = p.value)

# Depending on whether data is normally distributed or not, apply either a two-sided Unpaired T-test or a two-sided Mann Whitney U test.
df_av_temp <- df_av %>%
  filter(TIMEPOINT %in% c("Control", "Pre")) %>%
  mutate(TIMEPOINT = factor(TIMEPOINT,
                            levels = c("Control", "Pre"),
                            ordered = TRUE)) %>%
  unnest(data) %>%
  ungroup() %>%
  group_by(BIOMARKER, VESSEL) %>%
  nest() %>%
  mutate(maxSW = map(data, ~.x %>% summarize(max_value = max(SW, na.rm = TRUE)))) %>%
  unnest(maxSW) %>%
  rename(gShapiroWilks = max_value) %>%
  mutate(TEST = if_else(gShapiroWilks < 0.05, "Mann-Whitney U Test", "Unpaired T-Test")) %>%
  mutate(model = if_else(TEST == "Unpaired T-Test",
                         map(data, ~rstatix::t_test(data = .x, log2 ~ TIMEPOINT, paired = FALSE)),
                         map(data, ~rstatix::wilcox_test(data = .x, log2 ~ TIMEPOINT, paired = FALSE)))) %>%
  mutate(EffectSize = if_else(TEST == "Unpaired T-Test",
                              map(data, ~rstatix::cohens_d(data = .x, log2 ~ TIMEPOINT, var.equal = TRUE, paired = FALSE)),
                              map(data, ~rstatix::wilcox_effsize(data = .x, log2 ~ TIMEPOINT, paired = FALSE)))) %>%
  mutate(model = map(model, ~.x %>% select(p)),
         EffectSize = map(EffectSize, ~.x %>%
                            select(c(effsize, magnitude)) %>%
                            mutate(magnitude = as.character(magnitude)))) %>%
  unnest(model, EffectSize) %>%
  mutate(`Effect Size Test` = if_else(TEST == "Unpaired T-Test", "Cohen's D", "Wilcoxon effect size (r)")) %>%
  rename(pvalue = p) %>%
  select(!gShapiroWilks)

## Data Processing Note
# Do not use the AV fold change data for volcano plots or analysis as that may contain errors from crossing over zero to not represent a true fold change.
temp <- df_av_temp %>%
  mutate(FC = map(data, ~.x %>%
                    group_by(TIMEPOINT) %>%
                    summarize(mean = mean(log2)) %>%
                    pivot_wider(names_from = "TIMEPOINT", values_from = "mean") %>%
                    mutate(FC = Pre - Control) %>%
                    select(FC))) %>%
  unnest(FC)

#### eFigure 7A - Individual Responses for Arterial Controls vs Pre-WLST ####
temp_stats <- temp %>% 
  filter(VESSEL == "Arterial") %>%
  select(BIOMARKER, data, pvalue)

temp1 <- temp_stats %>% unnest(data)

efig7a <- temp1 %>%
  mutate(TIMEPOINT = factor(TIMEPOINT,
                            levels = c("Control", "Pre"),
                            labels = c("Controls", "WLST Patients"))) %>%
  rename(Cohort = TIMEPOINT) %>%
  ggplot(., aes(x = log2, y = fct_rev(BIOMARKER), color = Cohort, group = Cohort), shape = 18) +
  geom_hline(yintercept = seq(0, 130, 1), color = "grey", alpha = 0.3, linewidth = 0.5) +
  geom_point(alpha = 0.2) +
  geom_text(data = temp_stats,
            aes(x = 28, y = BIOMARKER, label = paste("P =", signif(pvalue, digits = 2))),
            inherit.aes = FALSE,
            hjust = 0,
            vjust = 0.5,
            fontface = 4,
            size = 2.8) +
  stat_summary(geom = "point", size = 2, alpha = 0.8) +
  xlab("Concentration (NPQ)") +
  scale_x_continuous(limits = c(0, 33),
                     breaks = seq(0, 30, 5),
                     expand = c(0,0)) +
  scale_y_discrete(expand = c(0,2)) +
  theme_pubr(legend = "bottom") +
  scale_color_npg() +
  theme(axis.text.y = element_text(hjust = 0, size = 8, face = "bold"),
        axis.title.y = element_blank(),
        axis.line.y = element_line(color = "black"))

#### eFigure 7B - Individual Responses for Cerebral Arteriovenous Gradients in Controls vs Pre-WLST ####
temp_stats <- temp %>% 
  filter(VESSEL == "AV") %>%
  select(BIOMARKER, data, pvalue)

temp1 <- temp_stats %>% unnest(data)

efig7b <- temp1 %>%
  mutate(TIMEPOINT = factor(TIMEPOINT,
                            levels = c("Control", "Pre"),
                            labels = c("Controls", "WLST Patients"))) %>%
  rename(Cohort = TIMEPOINT) %>%
  ggplot(., aes(x = log2, y = fct_rev(BIOMARKER), color = Cohort, group = Cohort), shape = 18) +
  geom_vline(xintercept = 0, color = "black", alpha = 0.5, linewidth = 0.5, linetype = "longdash") +
  geom_hline(yintercept = seq(0, 130, 1), color = "grey", alpha = 0.3, linewidth = 0.5) +
  geom_point(alpha = 0.2) +
  geom_text(aes(x = -15,
                y = 128,
                label = "Cerebral Release"),
            hjust = 0.5,
            vjust = 0,
            fontface = 2,
            size = 3.5,
            color = "black") +
  geom_text(aes(x = 15,
                y = 128,
                label = "Cerebral Uptake"),
            hjust = 0.5,
            vjust = 0,
            fontface = 2,
            size = 3.5,
            color = "black") +
  geom_text(data = temp_stats,
            aes(x = 23, y = BIOMARKER, label = paste("P =", signif(pvalue, digits = 2))),
            inherit.aes = FALSE,
            hjust = 0,
            vjust = 0.5,
            fontface = 4,
            size = 2.8)+
  stat_summary(geom = "point", size = 2, alpha = 0.8) +
  xlab("Concentration (NPQ)") +
  scale_x_continuous(limits = c(-26, 26),
                     breaks = seq(-25, 25, 5),
                     expand = c(0.1,0.1)) +
  scale_y_discrete(expand = c(0,2)) +
  theme_pubr(legend = "bottom") +
  scale_color_npg() +
  theme(axis.text.y = element_text(hjust = 0, size = 8, face = "bold"),
        axis.title.y = element_blank(),
        axis.line.y = element_line(color = "black"))

# Volcano Plot Code for Figure 6S
temp <- temp %>%
  select(!data) %>%
  arrange(pvalue) %>%
  group_by(VESSEL) %>%
  nest() %>%
  ## P-value adjustment is for the False Discovery Rate by arranging pvalues in order and then using their index number for correction
  mutate(data = map(data, ~.x %>% mutate(p.adj = pvalue*(length(pvalue)/row_number(pvalue))))) %>%
  unnest(data) %>%
  mutate(effsize = abs(effsize),
         p.adj = if_else(p.adj > 1, 1, p.adj))

# Figure 5S - Arterial Plasma Proteomics Volcano Plot for Controls vs Pre-WLST
fig5s <- temp %>%
  filter(VESSEL == "Arterial") %>%
  ggplot(., aes(x = FC, y = -log10(p.adj), shape = TEST, color = effsize)) +
  geom_vline(xintercept = c(-1,1), linetype = "dashed", color = "grey", linewidth = 0.3) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey", linewidth = 0.3) +
  geom_point(data = . %>% filter(p.adj < 0.05), size = 2) +
  geom_point(data = . %>% filter(p.adj > 0.05 | (FC <= 1 & FC >= -1)), color = "grey", size = 2) +
  geom_text_repel(data = . %>% filter(p.adj < 0.05) %>% filter(FC > 1 | FC < -1),
                  aes(label = BIOMARKER),
                  size = 3,
                  # family = "Times New Roman",
                  color = "black") +
  xlab(expression(paste("Fold-Change (log"[2], ")"))) +
  ylab(expression(paste("Significance -log"[10], " (P-value)"))) +
  scale_x_continuous(limits = c(-3, 11),
                     breaks = seq(-2,10,2),
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 15),
                     breaks = seq(0, 15, 3),
                     expand = c(0,0.3)) +
  scale_color_gradientn(breaks = c(1,3,5),
                        colors = inferno(100)) +
  guides(shape = guide_legend(title = NULL, order = 1, override.aes = list(color = "black")),
         color = guide_colourbar(barwidth = 5,
                                 barheight = 0.5,
                                 ticks.colour = "black",
                                 frame.colour = "black",
                                 title = "Effect Size")) +
  theme_pubr(legend = "bottom") +
  theme(plot.title = element_text(face="bold"),
        strip.background = element_rect(color = "white", fill = "#53585F"),
        legend.margin = unit(0.6, "cm"),
        legend.background = element_rect(fill=NA,
                                         size=0.5, linetype="solid",
                                         colour =NA),
        legend.title = element_text(colour="black", size=9,
                                    face="bold"),
        legend.text = element_text(face = "bold.italic", size = 8),
        legend.title.align=0.5)

# Overwriting the previous dataframe to analyze the difference between Pre-WLST to Post-WLST samples
df_av_temp <- df_av %>%
  filter(TIMEPOINT %in% c("Pre", "Post")) %>%
  filter(VESSEL == "Arterial") %>%
  mutate(TIMEPOINT = factor(TIMEPOINT,
                            levels = c("Pre", "Post"),
                            ordered = TRUE)) %>%
  unnest(data) %>%
  ## Have to exclude HIBI 25 because it does not have paired samples for this analysis
  filter(ID != "HIBI 25") %>%
  ungroup() %>%
  group_by(BIOMARKER, VESSEL) %>%
  nest() %>%
  mutate(maxSW = map(data, ~.x %>% summarize(max_value = max(SW, na.rm = TRUE)))) %>%
  unnest(maxSW) %>%
  rename(gShapiroWilks = max_value) %>%
  mutate(TEST = if_else(gShapiroWilks < 0.05, "Wilcoxon Signed-Rank Test", "Paired T-Test")) %>%
  mutate(model = if_else(TEST == "Paired T-Test",
                         map(data, ~t_test(data = .x, log2 ~ TIMEPOINT, paired = TRUE)),
                         map(data, ~wilcox_test(data = .x, log2 ~ TIMEPOINT, paired = TRUE)))) %>%
  mutate(EffectSize = if_else(TEST == "Paired T-Test",
                              map(data, ~cohens_d(data = .x, log2 ~ TIMEPOINT, var.equal = TRUE, paired = TRUE)),
                              map(data, ~wilcox_effsize(data = .x, log2 ~ TIMEPOINT, paired = TRUE)))) %>%
  mutate(model = map(model, ~.x %>% select(p)),
         EffectSize = map(EffectSize, ~.x %>% select(c(effsize, magnitude)) %>% mutate(magnitude = as.character(magnitude)))) %>%
  unnest(model, EffectSize) %>%
  mutate(`Effect Size Test` = if_else(TEST == "Paired T-Test", "Cohen's D", "Wilcoxon effect size (r)")) %>%
  rename(pvalue = p) %>%
  select(!gShapiroWilks)

# Creating fold change data for the arterial plasma proteome from Pre-WLST to Post-WLST
temp <- df_av_temp %>%
  mutate(FC = map(data, ~.x %>%
                    group_by(TIMEPOINT) %>%
                    summarize(mean = mean(log2)) %>%
                    pivot_wider(names_from = "TIMEPOINT", values_from = "mean") %>%
                    mutate(FC = Post - Pre) %>%
                    select(FC))) %>%
  unnest(FC)

# Creating the statistics data frame that will be used in making  eFigure 7C
temp_stats <- temp %>% 
  filter(VESSEL == "Arterial") %>%
  select(BIOMARKER, data, pvalue)

temp1 <- temp_stats %>% unnest(data)

efig7c <- temp1 %>%
  mutate(TIMEPOINT = factor(TIMEPOINT,
                            levels = c("Pre", "Post"),
                            labels = c("Pre-WLST", "SBP <60 mmHg"))) %>%
  rename(Timepoint = TIMEPOINT) %>%
  ggplot(., aes(x = log2, y = fct_rev(BIOMARKER), color = Timepoint, group = Timepoint), shape = 18) +
  geom_hline(yintercept = seq(0, 130, 1), color = "grey", alpha = 0.3, linewidth = 0.5) +
  geom_point(alpha = 0.2) +
  geom_text(data = temp_stats,
            aes(x = 28, y = BIOMARKER, label = paste("P =", signif(pvalue, digits = 2))),
            inherit.aes = FALSE,
            hjust = 0,
            vjust = 0.5,
            fontface = 4,
            size = 2.8) +
  stat_summary(geom = "point", size = 2, alpha = 0.8) +
  xlab("Concentration (NPQ)") +
  scale_x_continuous(limits = c(0, 33),
                     breaks = seq(0, 30, 5),
                     expand = c(0.1,0.1)) +
  scale_y_discrete(expand = c(0,2)) +
  theme_pubr(legend = "bottom") +
  scale_color_npg() +
  theme(axis.text.y = element_text(hjust = 0, size = 8, face = "bold"),
        axis.title.y = element_blank(),
        axis.line.y = element_line(color = "black"))

# Calculating the false discovery rate (FDR) of the Pre-WLST to Post-WLST biomarker data
temp <- temp %>%
  select(!data) %>%
  arrange(pvalue) %>%
  group_by(VESSEL) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(p.adj = pvalue*(length(pvalue)/row_number(pvalue))))) %>%
  unnest(data) %>%
  mutate(effsize = abs(effsize),
         p.adj = if_else(p.adj > 1, 1, p.adj))

# Figure 5T - Arterial Plasma Proteomics Volcano Plot for Pre-WLST vs Post-WLST
fig5t <- temp %>%
  ggplot(., aes(x = FC, y = -log10(pvalue), shape = TEST)) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey", linewidth = 0.3) +
  geom_point(data = . %>% filter(pvalue > 0.05 | (FC <= 1 & FC >= -1)), color = "grey", size = 2) +
  geom_point(data = . %>% filter(pvalue < 0.05), size = 2, color = "black") +
  geom_text_repel(data = . %>% filter(pvalue < 0.05),
                  aes(label = BIOMARKER),
                  size = 4,
                  # family = "Times New Roman",
                  color = "black") +
  xlab(expression(paste("Fold-Change (log"[2], ")"))) +
  ylab(expression(paste("Significance -log"[10], " (P-value)"))) +
  scale_x_continuous(limits = c(-0.8, 0.8),
                     breaks = seq(-0.8, 0.8, 0.2),
                     labels = seq(-0.8, 0.8, 0.2),
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 2.5),
                     breaks = seq(0, 2.5, 0.5),
                     expand = c(0,0)) +
  scale_color_gradientn(breaks = c(1,3,5),
                        colors = inferno(100)) +
  guides(shape = guide_legend(title = NULL,
                              order = 1,
                              # direction = "vertical",
                              override.aes = list(color = "black")),
         color = guide_colourbar(barwidth = 5,
                                 barheight = 0.5,
                                 ticks.colour = "black",
                                 frame.colour = "black",
                                 title = "Effect Size")) +
  theme_pubr(legend = "bottom") +
  theme(plot.title = element_text(face="bold"),
        strip.background = element_rect(color = "white", fill = "#53585F"),
        axis.text = element_text(size = 9),
        # legend.position = c(0.16, 0.68),
        # legend.spacing.y = unit(0, "lines"),
        legend.margin = unit(0.6, "cm"),
        legend.background = element_rect(fill=NA,
                                         size=0.5, linetype="solid",
                                         colour =NA),
        legend.title = element_text(colour="black", size=9,
                                    face="bold"),
        legend.text = element_text(face = "bold.italic", size = 8),
        legend.title.align=0.5)

# Figure 5T - Arterial Plasma Proteomics Volcano Plot for Pre-WLST vs Post-WLST with FDR applied
fig5t_2 <- temp %>%
  ggplot(., aes(x = FC, y = -log10(p.adj), shape = TEST)) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey", linewidth = 0.3) +
  geom_point(data = . %>% filter(p.adj > 0.05 | (FC <= 1 & FC >= -1)), color = "grey", size = 2) +
  geom_point(data = . %>% filter(p.adj < 0.05), size = 2, color = "black") +
  geom_text_repel(data = . %>% filter(p.adj < 0.05),
                  aes(label = BIOMARKER),
                  size = 4,
                  # family = "Times New Roman",
                  color = "black") +
  xlab(expression(paste("Fold-Change (log"[2], ")"))) +
  ylab(expression(paste("Significance -log"[10], " (P-value)"))) +
  scale_x_continuous(limits = c(-0.8, 0.8),
                     breaks = seq(-0.8, 0.8, 0.2),
                     labels = seq(-0.8, 0.8, 0.2),
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 1.5),
                     breaks = seq(0, 1.5, 0.3),
                     expand = c(0,0)) +
  scale_color_gradientn(breaks = c(1,3,5),
                        colors = inferno(100)) +
  guides(shape = guide_legend(title = NULL,
                              order = 1,
                              # direction = "vertical",
                              override.aes = list(color = "black")),
         color = guide_colourbar(barwidth = 5,
                                 barheight = 0.5,
                                 ticks.colour = "black",
                                 frame.colour = "black",
                                 title = "Effect Size")) +
  theme_pubr(legend = "bottom") +
  theme(plot.title = element_text(face="bold"),
        strip.background = element_rect(color = "white", fill = "#53585F"),
        axis.text = element_text(size = 9),
        legend.margin = unit(0.6, "cm"),
        legend.background = element_rect(fill=NA,
                                         size=0.5, linetype="solid",
                                         colour =NA),
        legend.title = element_text(colour="black", size=9,
                                    face="bold"),
        legend.text = element_text(face = "bold.italic", size = 8),
        legend.title.align=0.5)
```

```{r Figure 5S - Controls vs Pre-WLST Arterial Volcano Plot, fig.height=7, fig.width=8.5, fig.cap="**Figure 5S.** Arterial plasma proteomic comparisons between healthy control participants and critically ill patients prior to withdrawal of life-sustaining treatment."}
ggsave(filename = "../data_output/graphs/Figure 5S.pdf", fig5s, width = 6, height = 5, dpi = 900)
fig5s
```

```{r Figure 5T - Pre-WLST vs Post-WLST Arterial Volcano Plot, fig.height=7, fig.width=8.5, fig.cap="**Figure 5T.** Arterial plasma proteomic comparisons between critically ill patients prior to withdrawal of life-sustaining treatment and immediately after systolic blood pressure dropped below 60 mmHg."}
ggsave(filename = "../data_output/graphs/Figure 5T.pdf", fig5t, width = 6, height = 4.5, dpi = 900)
fig5t + ggtitle("T")

fig5t_2 + ggtitle("With False Detection Rate Applied")
```


### Figure 6 {-}
```{r fig.height=8, fig.width=12, fig.cap="**Figure 6.** Physiologic responses to the last agonal breath during the dying process in critically ill humans"}
# Reading in the agonal breathing data
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "agonal_breathing",
                 skip = 1)

# Adding in extra metrics
df <- df %>%
  mutate(rSO2 = rowMeans(select(., RSO2_L, RSO2_R), na.rm = TRUE),
         across(everything(), ~ ifelse(is.nan(.), NA, .)),
         across(everything(), ~ ifelse(. == -0.0092, 0, .)),
         PP = SBP - DBP)    # Replaces all the non-reading TCD values with 0

# Only use data that is from the 3 seconds before gasping to the 10 seconds after gasping
df <- df %>% filter(REL_TIME >= -3 & REL_TIME <= 10)

# Pivoting all variables longer
df <- df %>% 
  pivot_longer(!c(ID,REL_TIME), names_to = "VARIABLE", values_to = "value") %>%
  group_by(ID, VARIABLE) %>%
  nest()

# Getting the max value from the gasping period
df <- df %>%
  mutate(max = map(data, ~.x %>% filter(REL_TIME > 0) %>%
                     filter(value == max(value)) %>% rename(MAX = value)))

# If you don't have a max value, then don't report a max value
df <- df %>% mutate(count = map(max, ~.x %>% nrow())) %>%
  mutate(max = if_else(
    count <= 1,
    max,
    map(max, ~.x %>% slice(0)
    ))) %>%
  select(!count)

# Get the average baseline value from the -3 to 0 time bins
df <- df %>% mutate(BL = map(data, ~.x %>%
                               filter(REL_TIME<=0) %>%
                               select(!REL_TIME) %>%
                               get_summary_stats(type = "mean") %>%
                               select(mean) %>%
                               rename(BL_mean = mean)))

# Unnesting data frames but not removing data but scoring it as NA so that it can be used in the figures
df <- df %>% unnest(c(BL, max), keep_empty = T) %>% rename(peak_time = REL_TIME)

# Unnesting the rest of the data
df <- df %>% unnest(data)

# Creating a column that is the relative change from baseline
df <- df %>% mutate(rel_value = value - BL_mean)

# Get the relative max instead of the global max
df <- df %>%
  mutate(rel_MAX = if_else(value == MAX, rel_value, NA))

# Running the statistics to go on the figure panels
stats <- df %>% select(ID, VARIABLE, MAX, BL_mean) %>% distinct() %>%
  mutate(MAX = if_else(!is.na(BL_mean) & is.na(MAX), BL_mean, MAX)) %>%
  drop_na() %>%
  pivot_longer(c(MAX, BL_mean), names_to = "Timepoint", values_to = "value") %>%
  group_by(VARIABLE) %>%
  nest() %>%
  mutate(TTEST = map(data, ~t_test(data = .x, value ~ Timepoint,
                                   paired = TRUE,
                                   alternative = "two.sided"))) %>%
  mutate(TTEST = map(TTEST, ~.x %>% select(p))) %>%
  unnest(TTEST) %>%
  mutate(p = signif(p, digits = 2))

# A for loop to iterate through the data and create each individual panel
for (i in unique(df$VARIABLE)) {
  # Selecting data in turn to be used in making a panel
  df_temp <- df %>% filter(VARIABLE == i)
  
  # This is the stock graph to be used for Figure 6. This could be a function, but I don't think it is versatile enough for that.
  fig <- df_temp %>%
    ggplot(., aes(x = REL_TIME, y = rel_value)) +
    geom_vline(xintercept = 0, color = "grey", linetype = "longdash", linewidth = 0.5) +
    annotate("segment", x = 0, y = 0, xend = 10, yend = 0, color = "black", linewidth = 0.5) +
    geom_rug(data = df_temp %>% select(ID, VARIABLE, peak_time, rel_MAX) %>% distinct() %>% drop_na(),
             aes(x = peak_time, y = rel_MAX),
             color = "#B24745",
             position = "jitter",
             alpha = 1,
             linewidth = 0.3,
             sides = "tr") +
    geom_smooth(aes(group = ID),
                color = "#00A1d550",
                linewidth = 0.5,
                alpha = 0.4,
                se = F) +
    geom_smooth(color = "black", se = FALSE, na.rm = TRUE) +
    xlab("Time from gasp (s)") +
    # The X-scaling is consistent throughout so only the scale_y_continuous data needs to change on an individual basis
    scale_x_continuous(limits = c(-3, 10.5),
                       breaks = seq(-3, 10, 1),
                       expand = c(0,0)) +
    theme_pubr() +
    theme(plot.title = element_text(face="bold"),
          axis.text.x = element_text(size = 9, color = "black", face = "bold"),
          axis.text.y = element_text(size = 9, color = "black", face = "bold"))
  
  # Assigning each panel a unique identifier so that all panels are still in the work space without being overwritten
  assign(paste0("agonal_", i), fig)
}

#### Cleaned Agonal Breathing Panels ####
# Arterial Blood Pressure
agonal_ABP <- agonal_ABP +
  ylab("MAP (mmHg)") +
  scale_y_continuous(limits = c(-20, 20),
                     breaks = seq(-20, 20, 5),
                     expand = c(0,0))

# Brain Oxygen Extraction Fraction
agonal_BRAIN_O2EF <- agonal_BRAIN_O2EF +
  ylab(expression(paste("Brain O"[2], "EF (%)"))) +
  scale_y_continuous(limits = c(-6, 8),
                     breaks = seq(-10, 10, 2),
                     expand = c(0,0))

# Central Venous Pressure
agonal_CVP <- agonal_CVP +
  ylab("CVP (mmHg)") +
  scale_y_continuous(limits = c(-1, 7.5),
                     breaks = seq(-1, 7, 1),
                     expand = c(0,0))

# Diastolic Blood Pressure
agonal_DBP <- agonal_DBP +
  ylab("DBP (mmHg)") +
  scale_y_continuous(limits = c(-20, 20),
                     breaks = seq(-20, 20, 5),
                     expand = c(0,0))

# Heart rate (Did not use in Figure 6)
agonal_HR <- agonal_HR +
  ylab("HR (bpm)")

# Middle Cerebral Artery Blood Velocities
agonal_MCA <- agonal_MCA +
  ylab("MCAv (cm/s)") +
  scale_y_continuous(limits = c(-20, 32),
                     breaks = seq(-20, 30, 5),
                     expand = c(0,1)) 

# Mean Pulmonary Artery Pressures
agonal_PAPm <- agonal_PAPm +
  ylab("PAP (mmHg)") +
  scale_y_continuous(limits = c(-1, 7.5),
                     breaks = seq(-1, 7, 1),
                     expand = c(0,0))

# Posterior Cerebral Artery Blood Velocities
agonal_PCA <- agonal_PCA +
  ylab("PCAv (cm/s)") +
  scale_y_continuous(limits = c(-20, 32),
                     breaks = seq(-20, 30, 5),
                     expand = c(0,1))

# Radial Pulse Pressure
agonal_PP <- agonal_PP +
  ylab("PP (mmHg)") +
  scale_y_continuous(limits = c(-10, 15),
                     breaks = seq(-10, 14, 2),
                     expand = c(0,0))

# Regional Cerebral Oxygen Saturation
agonal_rSO2 <- agonal_rSO2 +
  ylab(expression(paste("rSO"[2], " (%)"))) +
  scale_y_continuous(limits = c(-2.5, 7),
                     breaks = seq(-2, 7, 1),
                     expand = c(0,0))

# Systolic Blood Pressure
agonal_SBP <- agonal_SBP +
  ylab("SBP (mmHg)") +
  scale_y_continuous(limits = c(-20, 20),
                     breaks = seq(-20, 20, 5),
                     expand = c(0,0))

# Jugular Venous Bulb Oxygen Saturation
agonal_SJVO2 <- agonal_SJVO2 +
  ylab(expression(paste("S"[jv], "O"[2], " (%)"))) +
  scale_y_continuous(limits = c(-3.2, 3.2),
                     breaks = seq(-3, 3, 1),
                     expand = c(0,0))

# Peripheral Oxygen Saturation
agonal_SPO2 <- agonal_SPO2 +
  ylab(expression(paste("S"[p], "O"[2], " (%)"))) +
  scale_y_continuous(limits = c(-4, 10),
                     breaks = seq(-4, 10, 2),
                     expand = c(0,0))

# Central Mixed Venous Oxygen Saturation
agonal_SVO2 <- agonal_SVO2 +
  ylab(expression(paste("S"[v], "O"[2], " (%)"))) +
  scale_y_continuous(limits = c(-3.2, 3.2),
                     breaks = seq(-3, 3, 1),
                     expand = c(0,0))

# Systemic Oxygen Extraction Fraction
agonal_SYS_O2EF <- agonal_SYS_O2EF +
  ylab(expression(paste("Systemic O"[2], "EF (%)"))) +
  scale_y_continuous(limits = c(-5, 21),
                     breaks = seq(-5, 20, 5),
                     expand = c(0,0))

fig <- ggarrange(agonal_PAPm, agonal_CVP, agonal_ABP, agonal_PP,
                 agonal_MCA, agonal_PCA, agonal_SJVO2, agonal_SVO2,
                 agonal_SPO2, agonal_rSO2, agonal_BRAIN_O2EF, agonal_SYS_O2EF,
                 labels = c("C", "D", "E", "F",
                            "G", "H", "I", "J",
                            "K", "L", "M", "N"),
                 nrow = 3, ncol = 4, align = "hv")


# Saving each panel to an Agonal Breathing folder
ggsave(filename = "../data_output/graphs/Figure 6.pdf",
       fig,
       width = 12,
       height = 7.5,
       dpi = 1200)

fig

# Removing all the variables from the global environment that have agonal in them
rm(list = str_subset(ls(), "agonal_"))
```

## TABLES {- .tabset}

### Timing Data {-}
```{r}
# Individual Data - Time differences between Patients
timing %>% select(ID, WLST_to_MCA, WLST_to_PCA, WLST_to_PEA, MCA_to_PEA, PCA_to_PEA) %>%
  mutate(`MCA to PEA (s)` = as.integer(seconds(MCA_to_PEA)),
         `PCA to PEA (s)` = as.integer(seconds(PCA_to_PEA))) %>%
  rename(`WLST to MCA` = WLST_to_MCA,
         `WLST to PCA` = WLST_to_PCA,
         `WLST to PEA` = WLST_to_PEA) %>%
  select(!c(MCA_to_PEA, PCA_to_PEA)) %>%
  kable(., caption = "Time from WLST to Cessation of Cerebral Blood Velocities and Pulseless Electrical Activity") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = c(1,2), valign = "top") %>%
  scroll_box(width = "100%", height = "300px") %>%
  print()

# Group Summary Data for Timing Variables
timing %>%
  filter(!is.na(ID)) %>%
  mutate(ID2 = ID) %>%
  separate(ID2, into = c("ETIOLOGY", NA), sep = " ", extra = "drop") %>%
  filter(ETIOLOGY == "HIBI") %>%
  filter(ID != "HIBI 32") %>%
  select(ID, WLST_to_MCA, WLST_to_PCA, WLST_to_PEA, WLST_to_EA, WLST_to_SBP60,
         MCA_to_PEA, PCA_to_PEA,
         MCA_to_EA, PCA_to_EA) %>%
  mutate(`WLST to MCA (s)` = as.integer(seconds(WLST_to_MCA)),
         `WLST to PCA (s)` = as.integer(seconds(WLST_to_PCA)),
         `WLST to PEA (s)` = as.integer(seconds(WLST_to_PEA)),
         `WLST to EA (s)` = as.integer(seconds(WLST_to_EA)),
         `WLST to SBP 60 (s)` = as.integer(seconds(WLST_to_SBP60)),
         `MCA to PEA (s)` = as.integer(seconds(MCA_to_PEA)),
         `PCA to PEA (s)` = as.integer(seconds(PCA_to_PEA)),
         `MCA to EA (s)` = as.integer(seconds(MCA_to_EA)),
         `PCA to EA (s)` = as.integer(seconds(PCA_to_EA))
  ) %>%
  select(!(WLST_to_MCA:PCA_to_EA)) %>%
  get_summary_stats(type = "full") %>%
  kable(., caption = "Group Summary Data - Seconds") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  add_footnote(c(paste0("The average time it took for WLST to PEA <5 mmHg was: ",
                        round(mean(seconds(timing$WLST_to_PEA), na.rm = TRUE)/60, 0),
                        " minutes."),
                 paste0("The average time it took for WLST to no MCA signal was: ",
                        round(mean(seconds(timing$WLST_to_MCA), na.rm = TRUE)/60, 0),
                        " minutes."),
                 paste0("The average time it took for WLST to no PCA signal was: ",
                        round(mean(seconds(timing$WLST_to_PCA), na.rm = TRUE)/60, 0),
                        " minutes."))
  ) %>%
  print()
```

### Brain pathology {-}
> **Data Processing Notes**:  
> The pathology data is scored as ranked categories which presents some challenges when there are a limited number of brain autopsies to analyze. As such, for this initial manuscript, the brain autopsy data was binary classified as either the presence of pathology or absence of pathology. The chronic neuropathology is classified as None, Mild, Moderate, and Severe while the acute inflammation neuropathology is classified as None, Very Mild, Mild, Moderate, and Severe. An alternative approach to analysis in the future would be using Kruskal-Wallis comparisons with a Dunn's test post hoc to determine if there are differences between different levels of pathology present.  

```{r}
# Reading in the brain autopsy data tab
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "autopsy_brain",
                 skip = 1)

# SUMMARY - Ranked Category Summary of Acute Inflammation Neuropathology
df %>% drop_na() %>% group_by(acute_inflammation) %>% summarize(n = n())

# SUMMARY - Ranked Category Summary of Chronic Neuropathology
df %>% drop_na() %>% group_by(chronic_severity) %>% summarize(n = n())

# Creating a pathology binary on whether acute or chronic pathology are present
df <- df %>%
  mutate(acute = if_else(acute_inflammation == "None", "No", "Yes"),
         acute = if_else(is.na(acute_inflammation), NA, acute),
         chronic = if_else(chronic_severity == "None", "No", "Yes"),
         chronic = if_else(is.na(chronic_severity), NA, chronic))

# SUMMARY - Weight of brain autopsies 
df %>%
  group_by(Cohort) %>%
  mutate(Cohort = if_else(Cohort == 1, "Critically Ill Patient Cohort", "Medical Assistance in Dying")) %>%
  select(weight) %>%
  get_summary_stats(type = "full")

# SUMMARY - Number of Autopsies performed
df %>% drop_na() %>% nrow()

# SUMMARY - Number of Autopsies with acute neuropathology
df %>% drop_na() %>% group_by(acute) %>% summarize(n = n())

# SUMMARY - Number of Autopsies with chronic neuropathology
df %>% drop_na() %>% group_by(chronic) %>% summarize(n = n())

# STATISTICS - Fisher's Exact Test for whether Acute and Chronic Pathology are related
fisher_test(table(df$acute, df$chronic), detailed = TRUE)
chisq_test(df$acute, df$chronic)

temp <- df %>% select(ID, acute, chronic) %>% pivot_longer(!ID, names_to = "PATH", values_to = "BINARY")

# 1. Relationship between Timing & Brain Pathology ------------------------------
df <- timing %>% select(ID, WLST_to_SBP60:last_col()) %>%
  pivot_longer(!ID, names_to = "Duration") %>%
  mutate(value = as.integer(seconds(value))) %>%
  merge(temp, all = TRUE) %>%
  relocate(ID, PATH, Duration, BINARY, value) %>%
  arrange(PATH, Duration) %>%
  drop_na() %>%
  group_by(PATH, Duration) %>%
  nest() %>%
  mutate(model = map(data, ~rstatix::wilcox_test(data = .x, value ~ BINARY, paired = FALSE)),
         model = map(model, ~.x %>% select(p))) %>%
  unnest(model)

# Summary Data Table Output
df %>%
  rename(Pathology = PATH,
         `P-Value` = p) %>%
  mutate(Pathology = if_else(Pathology == "acute",
                             "Acute Inflammation Neuropathology",
                             "Chronic Neuropathology")) %>%
  select(!data) %>%
  arrange(`P-Value`) %>%
  kable(., caption = "Relationships between the presence of brain neuropathology and various time intervals during the dying process.") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  print()

# 2. Relationship between Blood-Based Neurologic Biomarkers & Brain Pathology --------------------------
df <- read_excel(path = DATA_REPOSITORY_PATH, sheet = "serum_proteomics") %>%
  filter(Timepoint == "Pre") %>%
  select(ID, Biomarker, Arterial, Jugular) %>%
  pivot_longer(c(Arterial, Jugular), names_to = "Vessel", values_to = "conc") %>%
  filter(!str_detect(ID, "EVALUATE")) %>%
  merge(temp, all = TRUE) %>%
  drop_na() %>%
  relocate(ID, PATH, Biomarker, Vessel, BINARY, conc) %>%
  arrange(PATH, Vessel, Biomarker) %>%
  group_by(PATH, Vessel, Biomarker) %>%
  nest() %>%
  mutate(model = map(data, ~rstatix::wilcox_test(data = .x, conc ~ BINARY, paired = FALSE)),
         model = map(model, ~.x %>% select(p))) %>%
  unnest(model)

# Summary Data Table Output
df %>%
  rename(Pathology = PATH,
         `P-Value` = p) %>%
  mutate(Pathology = if_else(Pathology == "acute",
                             "Acute Inflammation Neuropathology",
                             "Chronic Neuropathology")) %>%
  select(!data) %>%
  arrange(`P-Value`) %>%
  kable(., caption = "Relationships between the presence of brain neuropathology and Blood-Based Neurologic Biomarkers.") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  print()
```

### Heart pathology {-}
```{r}
# Reading in the heart autopsy data tab
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "autopsy_heart",
                 skip = 1)

# SUMMARY - Weight of brain autopsies 
df %>%
  select(weight) %>%
  get_summary_stats(type = "full")

# Removing weight data so we are only looking on if defects are present
df <- df %>% select(!weight)

# Identifying if coronary artery stenosis is present in one of the coronary arteries
df <- df %>%
  mutate(CAD = if_else((LAD == "No" & RCA == "No" & Circumflex == "No"), "No", "Yes"),
         VENTRICLE = if_else(RV == "No" & LV == "No", "No", "Yes"),
         ATRIUM = if_else(RA == "No" & LA == "No", "No", "Yes"))

# Pivoting longer on whether a conidition is present and binary outcome
df <- df %>%
  pivot_longer(!ID, names_to = "CONDITION", values_to = "BINARY")

# Timing data to merge with heart autopsy data on whether these factors are related
df1 <- timing %>%
  select(ID, WLST_to_MCA, WLST_to_PCA, WLST_to_PEA, WLST_to_EA) %>%
  pivot_longer(!ID) %>%
  mutate(value = as.integer(seconds(value)))

# Merging the dataframe
df <- df %>%
  merge(df1, all = TRUE) %>%
  drop_na() %>%
  group_by(CONDITION, name) %>%
  nest() 

# Excluding pulmonary artery and conduction systems from this analysis because there is no groupwise comparison
df <- df %>%
  filter(!(CONDITION %in% c("PA", "ConducSys")))

# Running the Mann Whitney U test for two-sided unpaired non-parametric comparison
df <- df %>%
  mutate(WSR_test = map(data, ~rstatix::wilcox_test(data = .x,
                                                    value~BINARY,
                                                    paired = FALSE,
                                                    alternative = "two.sided"))) %>%
  unnest(WSR_test) %>%
  arrange(p)

# Summary data for heart autopsies
df %>% select(CONDITION, name, group1:last_col()) %>%
  mutate(CONDITION = case_when(
    CONDITION == "CAD" ~ "Coronary Artery Stenosis",
    CONDITION == "LAD" ~ "Left Anterior Descending Artery Stenosis",
    CONDITION == "RCA" ~ "Right Coronary Artery Stenosis",
    CONDITION == "LV" ~ "Left Ventricle Pathology",
    CONDITION == "RV" ~ "Right Ventricle Pathology",
    CONDITION == "VENTRICLE" ~ "Ventricular Pathology",
    CONDITION == "RA" ~ "Right Atrium Pathology",
    CONDITION == "LA" ~ "Left Atrium Pathology",
    CONDITION == "ATRIUM" ~ "Atrial Pathology",
    CONDITION == "Myocardium" ~ "Myocardial Pathology",
    CONDITION == "Circumflex" ~ "Circumflex Stenosis"
  )) %>%
  rename(`Time Interval` = name) %>%
  kable(., caption = "Relationships between time intervals during the dying process and presence of heart pathology") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  print()
```

### Baseline Data Prior to WLST {-}
```{r}
df_signals %>% select(ID, data) %>%
  mutate(BL = map(data, ~.x %>% slice(1:(which(.x$Comment == "WLST")+6)))) %>%
  select(!data) %>%
  unnest(BL) %>%
  select(ID, ABP:ETCO2) %>%
  select(!c(PETCO2, ETCO2)) %>%
  mutate(rSO2 = (RSO2_L + RSO2_R)/2) %>%
  group_by(ID) %>%
  get_summary_stats(type = "mean_sd") %>%
  mutate(variable = case_when(
    variable == "ABP" ~ "Mean Arterial Pressure",
    variable == "SJVO2" ~ "Jugular Venous Oxygen Saturation",
    variable == "SPO2" ~ "Peripheral Oxygen Saturation",
    variable == "BRAIN_O2EF" ~ "Brain Oxygen Extraction Fraction",
    variable == "PCA" ~ "Posterior Cerebral Artery Blood Velocity",
    variable == "MCA" ~ "Middle Cerebral Artery Blood Velocity",
    variable == "SBP" ~ "Systolic Blood Pressure",
    variable == "DBP" ~ "Diastolic Blood Pressure",
    variable == "RSO2_R" ~ "Right Regional Cerebral Oxygen Sat",
    variable == "RSO2_L" ~ "Left Regional Cerebral Oxygen Sat",
    variable == "rSO2" ~ "Avg Regional Cerebral Oxygen Sat",
    variable == "CVP" ~ "Central Venous Pressure",
    variable == "SVO2" ~ "Central Mixed Venous Oxygen Saturation",
    variable == "MV_O2EF" ~ "Whole Body Oxygen Extraction Fraction"
  )) %>%
  select(!c(n, sd)) %>%
  pivot_wider(names_from = variable, values_from = mean) %>%
  get_summary_stats(type = "full") %>%
  kable(., caption = "Baseline variables prior to withdrawal of life sustaining treatments ") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  print()
```

---

# Extended Display Items

## FIGURES {- .tabset}

### eFigure 1 {-}
```{r, fig.width=10, fig.height=3, fig.cap="**eFigure 1.** Feasibility of data collection in critically ill and medical assistance in dying patient cohorts."}
# Reading in the feasibility data
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "feasibility",
                 skip = 1)

# Organizing the feasibility data in the order we want to present it
df <- df %>%
  pivot_longer(ECG:last_col(), names_to = "columns") %>%
  mutate(columns = factor(columns,
                          levels = c("ECG", "A-Line", "MCAv", "PCAv",
                                     "SjvO2", "NIRS", "Biomarkers",
                                     "Brain Autopsy", "Heart Autopsy", "PAC"),
                          ordered = TRUE),
         ID = factor(ID, levels = c("Sepsis 1", "HIBI 2", "HIBI 3", "HIBI 4", "HIBI 5",
                                    "TBI 6", "HIBI 7", "HIBI 8", "Sepsis 9", "HIBI 10",
                                    "HIBI 11", "HIBI 12", "ICH 13", "Sepsis 14", "TBI 15",
                                    "HIBI 16", "ICH 17", "TBI 18", "Sepsis 19", "ICH 20",
                                    "HIBI 21", "Sepsis 22", "SAH 23", "HIBI 24", "HIBI 25",
                                    "ICH 26", "TBI 27", "TBI 28", "HIBI 29", "TBI 30",
                                    "Sepsis 31", "HIBI 32", "MAID 1", "MAID 2", "MAID 3")))

# Creating the feasibility panel
fig <- df %>%
  ggplot(., aes(x = ID, y = columns, fill = factor(value, levels = c(0, 1), labels = c("Missing", "Collected")))) +
  geom_tile(color = "#374e55") +
  scale_fill_jama() +
  scale_x_discrete(position = "bottom") +
  scale_y_discrete(labels = c(expression(bold("Electrocardiogram")),
                              expression(bold("Radial arterial line")),
                              expression(bold("Transcranial Doppler (MCAv)")),
                              expression(bold("Transcranial Doppler (PCAv)")),
                              expression(bold(paste("Jugular bulb catheter (S"[jv], "O"[2], ")"))), 
                              expression(bold(paste("Near-infrared spectroscopy (rSO"[2], ")"))), 
                              expression(bold("Blood-Based Biomarkers")),
                              expression(bold("Brain Autopsy")),
                              expression(bold("Heart Autopsy")),
                              expression(bold("Pulmonary artery catheter*"))),
                   expand=c(0,0)) +
  labs(fill = "Data") +
  theme_pubr(legend = "right") +
  theme(axis.title = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 8, face="bold"),
        axis.text.y = element_text(hjust = 0, size = 8, face = "bold"),
        legend.title = element_text(colour="black", size=8, 
                                    face="bold"),
        legend.text = element_text(size = 7),
        legend.background = element_rect(fill=NA),
        legend.title.align=0.5
  )

# Saving the feasibility figure to the output file
ggsave(filename = "../data_output/graphs/eFigure 1F.pdf",
       fig,
       width = 10,
       height = 1.8,
       dpi = 900)

# Displaying the feasibility figure
fig + ggtitle("F")
```

### eFigure 2 {-}
```{r}
# Reading in the timing of physiology data tab
df <- read_csv(file = DATA_TIMING_PATH) %>%
  filter(Cohort == 1)

df <- df %>%
  select(ID, WLST_to_MCA:last_col()) %>%
  pivot_longer(WLST_to_MCA:last_col()) %>%
  mutate(value = as.integer(seconds(value))) %>%
  pivot_wider(names_from = "name", values_from = "value")

# Computing when the cessation of CBv occurred by comparing MCAv and PCAv cessations then selecting the later one
df <- df %>%
  mutate(WLST_to_CBv = if_else(WLST_to_MCA >= WLST_to_PCA, WLST_to_MCA, WLST_to_PCA),
         WLST_to_CBv = if_else(is.na(WLST_to_PCA) , WLST_to_MCA, WLST_to_CBv),
         CBv_to_PEA = if_else(MCA_to_PEA >= PCA_to_PEA, PCA_to_PEA, MCA_to_PEA),
         CBv_to_PEA = if_else(CBv_to_PEA < 0, 0, CBv_to_PEA),
         CBv_to_PEA = if_else(is.na(PCA_to_PEA), MCA_to_PEA, CBv_to_PEA),
         CBv_to_EA = if_else(MCA_to_EA >= PCA_to_EA, PCA_to_EA, MCA_to_EA),
         CBv_to_EA = if_else(CBv_to_EA < 0, 0, CBv_to_EA),
         CBv_to_EA = if_else(is.na(PCA_to_EA), MCA_to_EA, CBv_to_EA))

# Reading in the medication adminstration data
df1 <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "demographics",
                 skip = 1) %>%
  filter(Cohort == 1) %>%
  select(ID, Midazolam_bolus, Hydromorphone_bolus)

# Merging the drug administration and timing data together
df <- df %>% merge(df1, all = TRUE)

# Making a nested dataframe that is easy to make figure out of
df <- df %>%
  pivot_longer(Midazolam_bolus:Hydromorphone_bolus, names_to = "DRUG", values_to = "conc") %>%
  pivot_longer(WLST_to_MCA:CBv_to_EA, names_to = "TIME", values_to = "Length") %>%
  group_by(DRUG, TIME) %>%
  drop_na() %>%
  nest() %>%
  mutate(CORR = map(data, ~cor.test(x = .x$conc,
                                    y = .x$Length,
                                    method = "spearman",
                                    alternative = "two.sided")),
         CORR = map(CORR, tidy),
         N = map(data, ~.x %>% nrow()))

# Making a cleaned correlation function that can be added on top of figures
cleanCORR <- function(temp) {
  temp <- temp %>%
    select(CORR, N) %>%
    unnest(CORR) %>%
    rename(rs = estimate,
           P = p.value) %>%
    mutate(rs = round(rs, 2),
           P = if_else(P >= 0.01, round(P, 2), round(P, 3)))
  return(temp)
}

#### eFigure 2A - Midazolam vs WLST to CBv cessation ####
temp <- df %>% filter(DRUG == "Midazolam_bolus" & TIME == "WLST_to_CBv")
CORR <- cleanCORR(temp)

efig2a <- temp %>%
  select(!CORR) %>%
  unnest(data) %>%
  ggplot(., aes(x = Length,
                y = conc)) +
  geom_point(size = 2.5, alpha = 0.65, color = "black", fill = "black", shape = 23) +
  geom_text(data = CORR,
            aes(x = 5*60*60, y = 10,
                label = paste("N = ", N,
                              "\nrho = ", rs,
                              "\nP = ", P),
                hjust = 0,
                vjust = 1)) +
  xlab("WLST to CBv (hr)") +
  ylab("Total Dose Midazolam (mg)") +
  scale_x_continuous(breaks = c(0, 60*60, 120*60, 180*60, 240*60, 300*60, 360*60),
                     labels = seq(0, 6, 1),
                     limits = c(0,60*60*7), expand = c(0.1,0.1)) +
  theme_pubr(legend = "bottom") +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"))

#### eFigure 2B - Midazolam vs CBv cessation to PEA ####
temp <- df %>% filter(DRUG == "Midazolam_bolus" & TIME == "CBv_to_PEA")
CORR <- cleanCORR(temp)

efig2b <- temp %>%
  select(!CORR) %>%
  unnest(data) %>%
  ggplot(., aes(x = Length,
                y = conc)) +
  geom_point(size = 2.5, alpha = 0.65, color = "black", fill = "black", shape = 23) +
  geom_text(data = CORR,
            aes(x = 25*60, y = 10,
                label = paste("N = ", N,
                              "\nrho = ", rs,
                              "\nP = ", P),
                hjust = 0,
                vjust = 1)) +
  xlab("CBv to PEA (min)") +
  ylab("Total Dose Midazolam (mg)") +
  scale_x_continuous(breaks = seq(0, 35*60, 5*60),
                     labels = seq(0, 35, 5),
                     limits = c(0,36*60), expand = c(0,0)) +
  theme_pubr(legend = "bottom") +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"))

#### eFigure 2C - Midazolam vs CBv cessation to EA ####
temp <- df %>% filter(DRUG == "Midazolam_bolus" & TIME == "CBv_to_EA")
CORR <- cleanCORR(temp)

efig2c <- temp %>%
  select(!CORR) %>%
  unnest(data) %>%
  ggplot(., aes(x = Length,
                y = conc)) +
  geom_point(size = 2.5, alpha = 0.65, color = "black", fill = "black", shape = 23) +
  geom_text(data = CORR,
            aes(x = 30*60, y = 10,
                label = paste("N = ", N,
                              "\nrho = ", rs,
                              "\nP = ", P),
                hjust = 0,
                vjust = 1)) +
  xlab("CBv to electrical asystole (min)") +
  ylab("Total Dose Midazolam (mg)") +
  scale_x_continuous(breaks = seq(0, 40*60, 5*60),
                     labels = seq(0, 40, 5),
                     limits = c(0,41*60), expand = c(0,0)) +
  theme_pubr(legend = "bottom") +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"))

#### eFigure 2D - Hydromorphone vs WLST to CBv cessation ####
temp <- df %>% filter(DRUG == "Hydromorphone_bolus" & TIME == "WLST_to_CBv")
CORR <- cleanCORR(temp)

efig2d <- temp %>%
  select(!CORR) %>%
  unnest(data) %>%
  ggplot(., aes(x = Length,
                y = conc)) +
  geom_point(size = 2.5, alpha = 0.65, color = "black", fill = "black", shape = 23) +
  geom_text(data = CORR,
            aes(x = 5*60*60, y = 5,
                label = paste("N = ", N,
                              "\nrho = ", rs,
                              "\nP = ", P),
                hjust = 0,
                vjust = 1)) +
  xlab("WLST to CBv (hr)") +
  ylab("Total Dose Hydromorphone (mg)") +
  scale_x_continuous(breaks = c(0, 60*60, 120*60, 180*60, 240*60, 300*60, 360*60),
                     labels = seq(0, 6, 1),
                     limits = c(0,60*60*7), expand = c(0,0)) +
  theme_pubr(legend = "bottom") +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"))

#### eFigure 2E - Hydromorphone vs CBv cessation to PEA ####
temp <- df %>% filter(DRUG == "Hydromorphone_bolus" & TIME == "CBv_to_PEA")
CORR <- cleanCORR(temp)

efig2e <- temp %>%
  select(!CORR) %>%
  unnest(data) %>%
  ggplot(., aes(x = Length,
                y = conc)) +
  geom_point(size = 2.5, alpha = 0.65, color = "black", fill = "black", shape = 23) +
  geom_text(data = CORR,
            aes(x = 25*60, y = 5,
                label = paste("N = ", N,
                              "\nrho = ", rs,
                              "\nP = ", P),
                hjust = 0,
                vjust = 1)) +
  xlab("CBv to PEA (min)") +
  ylab("Total Dose Hydromorphone (mg)") +
  scale_x_continuous(breaks = seq(0, 35*60, 5*60),
                     labels = seq(0, 35, 5),
                     limits = c(0,36*60), expand = c(0,0)) +
  theme_pubr(legend = "bottom") +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"))

#### eFigure 2F - Hydromorphone vs CBv cessation to EA ####
temp <- df %>% filter(DRUG == "Hydromorphone_bolus" & TIME == "CBv_to_EA")
CORR <- cleanCORR(temp)

efig2f <- temp %>%
  select(!CORR) %>%
  unnest(data) %>%
  ggplot(., aes(x = Length,
                y = conc)) +
  geom_point(size = 2.5, alpha = 0.65, color = "black", fill = "black", shape = 23) +
  geom_text(data = CORR,
            aes(x = 30*60, y = 5,
                label = paste("N = ", N,
                              "\nrho = ", rs,
                              "\nP = ", P),
                hjust = 0,
                vjust = 1)) +
  xlab("CBv to electrical asystole (min)") +
  ylab("Total Dose Hydromorphone (mg)") +
  scale_x_continuous(breaks = seq(0, 40*60, 5*60),
                     labels = seq(0, 40, 5),
                     limits = c(0,41*60), expand = c(0,0)) +
  theme_pubr(legend = "bottom") +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"))
```

```{r fig.width=10, fig.height=6, fig.cap="**eFigure 2.** Relationships between sedative administration during the dying process and teh resultant length of dying process."}
eFigure2 <- ggarrange(efig2a, efig2b, efig2c,
                      efig2d, efig2e, efig2f,
                      labels = c("A", "B", "C", "D", "E", "F"),
                      ncol = 3, nrow = 2,
                      align = "hv")

# Displaying eFigure 2 in RMarkdown
eFigure2

# Saving the figure to the output folder in graphs
ggsave(filename = "../data_output/graphs/eFigure 2.pdf",
       eFigure2,
       width = 12,
       height = 7,
       dpi = 1200)

# Removing the graphical objects and unneeded variables/function from the R environment once it has been saved to conserve memory
rm(temp, CORR, cleanCORR, efig2a, efig2b, efig2c, efig2d, efig2e, efig2f,eFigure2)
```

### eFigure 3 {-}
```{r}
# Mean Arterial Pressure
df_temp <- df_signals %>% select(!data) %>% unnest(WLST)

df_temp <- df_temp %>% select(ID, ABP, Norm_Time, RowN) %>% drop_na() %>%
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

fig <- df_temp %>%
  ggplot(., aes(x = Norm_Time, y = ABP, weight = percent)) +
  geom_point(aes(x = Norm_Time, y = ABP, fill = NA, color = NA)) +
  geom_rect(aes(xmin = -0, xmax = 1), ymin = 0, ymax = 160, fill = "white", color = "white") +
  geom_smooth(method = "loess", se = FALSE, aes(x = Norm_Time, y = ABP, group = ID),
              color = "grey",
              inherit.aes = FALSE, size = 0.3, alpha = 0.4) +
  geom_smooth(method = "loess", se = TRUE, aes(x = Norm_Time, y = ABP),
              color = "black",
              inherit.aes = FALSE, size = 1, alpha = 0.8) +
  xlab("Normalized Time") +
  ylab("MAP (mmHg)") +
  scale_y_continuous(breaks = seq(0, 150, 30),
                     limits = c(0, 155),
                     expand = c(0,0)) +
  scale_x_continuous(breaks = c(0,1), limits = c(0,1),
                     labels = c("WLST", expression("PP <5")),
                     expand = c(0,0)) +
  theme_pubr(legend = "none") +
  theme(plot.title = element_text(face="bold"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank())

efig3a <- ggMarginal(fig, colour = "black", groupFill = TRUE, margin = "y", alpha = 0.5, size = 10)

# Peripheral Oxygen Saturation
df_temp <- df_signals %>% select(!data) %>% unnest(WLST)

df_temp <- df_temp %>% select(ID, SPO2, Norm_Time, RowN) %>% drop_na() %>%
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

fig <- df_temp %>%
  ggplot(., aes(x = Norm_Time, y = SPO2, weight = percent)) +
  geom_point(aes(x = Norm_Time, y = SPO2, fill = NA, color = NA)) +
  geom_rect(aes(xmin = 0, xmax = 1), ymin = 0, ymax = 160, fill = "white", color = "white") +
  geom_smooth(method = "loess", se = FALSE, aes(x = Norm_Time, y = SPO2, group = ID),
              color = "grey",
              inherit.aes = FALSE, size = 0.4, alpha = 0.4) +
  geom_smooth(method = "loess", se = TRUE, aes(x = Norm_Time, y = SPO2),
              color = "black",
              inherit.aes = FALSE, size = 1, alpha = 0.8) +
  xlab("Normalized Time") +
  ylab(expression(paste("S"[p], "O"[2], " (%)"))) +
  scale_y_continuous(breaks = seq(0, 100, 20),
                     limits = c(0, 105),
                     expand = c(0,0)) +
  scale_x_continuous(breaks = c(0,1), limits = c(0,1),
                     labels = c("WLST", expression("PP <5")),
                     expand = c(0,0)) +
  theme_pubr(legend = "none") +
  theme(plot.title = element_text(face="bold"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank())

efig3d <- ggMarginal(fig, colour = "black", groupFill = TRUE, margin = "y", alpha = 0.5, size = 10)

# Middle Cerebral Artery Blood Velocities
df_temp <- df_signals %>% select(!data) %>% unnest(WLST)

df_temp <- df_temp %>% select(ID, MCA, Norm_Time, RowN) %>% drop_na() %>%
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

fig <- df_temp %>%
  ggplot(., aes(x = Norm_Time, y = MCA, weight = percent)) +
  geom_point(aes(x = Norm_Time, y = MCA, fill = NA, color = NA)) +
  geom_rect(aes(xmin = 0, xmax = 1), ymin = 0, ymax = 160, fill = "white", color = "white") +
  geom_smooth(method = "loess", se = FALSE, aes(x = Norm_Time, y = MCA, group = ID),
              color = "grey",
              inherit.aes = FALSE, size = 0.4, alpha = 0.4) +
  geom_smooth(method = "loess", se = TRUE, aes(x = Norm_Time, y = MCA),
              color = "black",
              inherit.aes = FALSE, size = 1, alpha = 0.8) +
  xlab("Normalized Time") +
  ylab(expression(paste("MCAv", " (cm/s)"))) +
  scale_y_continuous(breaks = seq(0, 100, 20),
                     limits = c(0, 105),
                     expand = c(0,0)) +
  scale_x_continuous(breaks = c(0,1), limits = c(0,1),
                     labels = c("WLST", expression("PP <5")),
                     expand = c(0,0)) +
  theme_pubr(legend = "none") +
  theme(plot.title = element_text(face="bold"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank())

efig3b <- ggMarginal(fig, colour = "black", groupFill = TRUE, margin = "y", alpha = 0.5, size = 10)

# Posterior Cerebral Artery Blood Velocities
df_temp <- df_signals %>% select(!data) %>% unnest(WLST)

df_temp <- df_temp %>% select(ID, PCA, Norm_Time, RowN) %>% drop_na() %>%
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

fig <- df_temp %>%
  ggplot(., aes(x = Norm_Time, y = PCA, weight = percent)) +
  geom_point(aes(x = Norm_Time, y = PCA, fill = NA, color = NA)) +
  geom_rect(aes(xmin = 0, xmax = 1), ymin = 0, ymax = 160, fill = "white", color = "white") +
  geom_smooth(method = "loess", se = FALSE, aes(x = Norm_Time, y = PCA, group = ID),
              color = "grey",
              inherit.aes = FALSE, size = 0.4, alpha = 0.4) +
  geom_smooth(method = "loess", se = TRUE, aes(x = Norm_Time, y = PCA),
              color = "black",
              inherit.aes = FALSE, size = 1, alpha = 0.8) +
  xlab("Normalized Time") +
  ylab(expression(paste("PCAv", " (cm/s)"))) +
  scale_y_continuous(breaks = seq(0, 100, 20),
                     limits = c(0, 105),
                     expand = c(0,0)) +
  scale_x_continuous(breaks = c(0,1), limits = c(0,1),
                     labels = c("WLST", expression("PP <5")),
                     expand = c(0,0)) +
  theme_pubr(legend = "none") +
  theme(plot.title = element_text(face="bold"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank())

efig3c <- ggMarginal(fig, colour = "black", groupFill = TRUE, margin = "y", alpha = 0.5, size = 10)

# Jugular Venous Oxygen Saturation
df_temp <- df_signals %>% select(!data) %>% unnest(WLST)

df_temp <- df_temp %>% select(ID, SJVO2, Norm_Time, RowN) %>% drop_na() %>%
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

fig <- df_temp %>%
  ggplot(., aes(x = Norm_Time, y = SJVO2, weight = percent)) +
  geom_point(aes(x = Norm_Time, y = SJVO2, fill = NA, color = NA)) +
  geom_rect(aes(xmin = 0, xmax = 1), ymin = 0, ymax = 160, fill = "white", color = "white") +
  geom_smooth(method = "loess", se = FALSE, aes(x = Norm_Time, y = SJVO2, group = ID),
              color = "grey",
              inherit.aes = FALSE, size = 0.4, alpha = 0.4) +
  geom_smooth(method = "loess", se = TRUE, aes(x = Norm_Time, y = SJVO2),
              color = "black",
              inherit.aes = FALSE, size = 1, alpha = 0.8) +
  xlab("Normalized Time") +
  ylab(expression(paste("S"[jv], "O"[2], " (%)"))) +
  scale_y_continuous(breaks = seq(0, 100, 20),
                     limits = c(0, 105),
                     expand = c(0,0)) +
  scale_x_continuous(breaks = c(0,1), limits = c(0,1),
                     labels = c("WLST", expression("PP <5")),
                     expand = c(0,0)) +
  theme_pubr(legend = "none") +
  theme(plot.title = element_text(face="bold"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank())

efig3e <- ggMarginal(fig, colour = "black", groupFill = TRUE, margin = "y", alpha = 0.5, size = 10)

# Bilateral Near-Infrared Spectroscopy - Regional Cerebral Oxygen Saturation
df_temp <- df_signals %>% select(!data) %>% unnest(WLST)

df_temp <- df_temp %>% select(ID, RSO2_L, RSO2_R, Norm_Time, RowN) %>% drop_na() %>%
  mutate(RSO2 = (RSO2_L + RSO2_R)/2) %>%
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

fig <- df_temp %>%
  ggplot(., aes(x = Norm_Time, y = RSO2, weight = percent)) +
  geom_point(aes(x = Norm_Time, y = RSO2, fill = NA, color = NA)) +
  geom_rect(aes(xmin = 0, xmax = 1), ymin = 0, ymax = 160, fill = "white", color = "white") +
  geom_smooth(method = "loess", se = FALSE, aes(x = Norm_Time, y = RSO2, group = ID),
              color = "grey",
              inherit.aes = FALSE, size = 0.4, alpha = 0.4) +
  geom_smooth(method = "loess", se = TRUE, aes(x = Norm_Time, y = RSO2),
              color = "black",
              inherit.aes = FALSE, size = 1, alpha = 0.8) +
  xlab("Normalized Time") +
  ylab(expression(paste("rSO"[2], " (%)"))) +
  scale_y_continuous(breaks = seq(0, 100, 20),
                     limits = c(0, 105),
                     expand = c(0,0)) +
  scale_x_continuous(breaks = c(0,1), limits = c(0,1),
                     labels = c("WLST", expression("PP <5")),
                     expand = c(0,0)) +
  theme_pubr(legend = "none") +
  theme(plot.title = element_text(face="bold"))

efig3g <- ggMarginal(fig, colour = "black", groupFill = TRUE, margin = "y", alpha = 0.5, size = 10)

# Brain Oxygen Extraction Fraction
df_temp <- df_signals %>% select(!data) %>% unnest(WLST)

df_temp <- df_temp %>% select(ID, BRAIN_O2EF, Norm_Time, RowN) %>% drop_na() %>%
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

fig <- df_temp %>%
  ggplot(., aes(x = Norm_Time, y = BRAIN_O2EF, weight = percent)) +
  geom_point(aes(x = Norm_Time, y = BRAIN_O2EF, fill = NA, color = NA)) +
  geom_rect(aes(xmin = 0, xmax = 1), ymin = 0, ymax = 160, fill = "white", color = "white") +
  geom_smooth(method = "loess", se = FALSE, aes(x = Norm_Time, y = BRAIN_O2EF, group = ID),
              color = "grey",
              inherit.aes = FALSE, size = 0.4, alpha = 0.4) +
  geom_smooth(method = "loess", se = TRUE, aes(x = Norm_Time, y = BRAIN_O2EF),
              color = "black",
              inherit.aes = FALSE, size = 1, alpha = 0.8) +
  xlab("Normalized Time") +
  ylab(expression(paste("Brain O"[2], "EF (%)"))) +
  scale_y_continuous(breaks = seq(0, 100, 20),
                     limits = c(0, 105),
                     expand = c(0,0)) +
  scale_x_continuous(breaks = c(0,1), limits = c(0,1),
                     labels = c("WLST", expression("PP <5")),
                     expand = c(0,0)) +
  theme_pubr(legend = "none") +
  theme(plot.title = element_text(face="bold"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank())

efig3f <- ggMarginal(fig, colour = "black", groupFill = TRUE, margin = "y", alpha = 0.5, size = 10)
```

```{r eFigure 3, fig.width=8.5, fig.height=20, fig.cap="**eFigure 3.** Normalized timing signals to demonstrate trajectories throughout the dying process."}
# Making eFigure 3
fig <- ggarrange(plot_grid(efig3a, efig3b, efig3c,
                           efig3d, efig3e, efig3f, efig3g,
                           nrow = 7,
                           labels = c("A", "B", "C", "D", "E", "F", "G")),
                 align = "hv", legend = "none")

fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/eFigure 3.pdf",
       fig,
       width = 6.5,
       height = 14,
       dpi = 1200)

# Removing unneeded panels from the global environment
rm(list = str_subset(ls(), "efig3"))
```

### eFigure 4 {-}
```{r eFigure 4A - MCAv vs SpO2}
# Selected the truncated data
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

df_temp <- df_temp %>% select(ID, SPO2, MCA) %>% drop_na() %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

#### Selecting linear mixed effects model ####
# Random intercept
MODEL1 <- df_temp %>%
  lmer(MCA ~ SPO2 + (1 | ID), REML = TRUE, data = .)
# Random slope
MODEL2 <- df_temp %>%
  lmer(MCA ~ SPO2 + (0 + SPO2 | ID), REML = TRUE, data = .)
# Random slopes, random intercept
MODEL3 <- df_temp %>%
  lmer(MCA ~ SPO2 + (1 + SPO2 | ID), REML = TRUE, data = .)
output <- anova(MODEL1, MODEL2, MODEL3)

# The selected linear mixed model
LMM <- df_temp %>%
  ungroup() %>%
  nest() %>%
  mutate(model = map(data, ~lmer(MCA ~ SPO2 + (1 + SPO2 | ID), REML = TRUE, data = .x, weight = percent)),
         anova = map(model, anova),
         anova = map(anova, tidy),
         glance = map(model, tidy),
         augment = map(model, broom.mixed::augment)
  )

# Creation of eFigure 4A
fig <- LMM %>% select(augment) %>% unnest(augment) %>%
  ggplot(., aes(x = SPO2, y = MCA)) +
  geom_point(size = 0.2, alpha = 0.1, show.legend = FALSE) +
  geom_line(aes(x = SPO2, y = .fitted, group = ID), inherit.aes = FALSE, size = 1, alpha = 0.3, color = "#374e55") +
  geom_smooth(method = lm, se = FALSE, aes(x = SPO2, y = .fixed), color = "black", inherit.aes = FALSE, size = 1.5, alpha = 0.8) +
  xlab(expression(paste("SpO"[2], " (%)"))) +
  ylab("MCAv (cm/s)") +
  scale_x_reverse(breaks = c(0, 20, 40, 60, 80, 100), limits = c(105,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,105), expand = c(0,0)) +
  theme_pubr() +
  scale_color_jama() + 
  theme(plot.title = element_text(face="bold"))

# Adding in the marginal density plot to the right axis
fig <- ggMarginal(fig, colour = "black", fill = "#00A1d5", alpha = 0.8, size = 10)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/eFigure 4A.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

```{r eFigure 4B - PCAv vs SpO2}
# Selected the truncated data
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

df_temp <- df_temp %>% select(ID, SPO2, PCA) %>% drop_na() %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

#### Selecting linear mixed effects model ####
# Random intercept
MODEL1 <- df_temp %>%
  lmer(PCA ~ SPO2 + (1 | ID), REML = TRUE, data = .)
# Random slope
MODEL2 <- df_temp %>%
  lmer(PCA ~ SPO2 + (0 + SPO2 | ID), REML = TRUE, data = .)
# Random slopes, random intercept
MODEL3 <- df_temp %>%
  lmer(PCA ~ SPO2 + (1 + SPO2 | ID), REML = TRUE, data = .)
output <- anova(MODEL1, MODEL2, MODEL3)

# The selected linear mixed model
LMM <- df_temp %>%
  ungroup() %>%
  nest() %>%
  mutate(model = map(data, ~lmer(PCA ~ SPO2 + (1 + SPO2 | ID), REML = TRUE, data = .x, weight = percent)),
         anova = map(model, anova),
         anova = map(anova, tidy),
         glance = map(model, tidy),
         augment = map(model, broom.mixed::augment)
  )

# Creation of eFigure 4B
fig <- LMM %>% select(augment) %>% unnest(augment) %>%
  ggplot(., aes(x = SPO2, y = PCA)) +
  geom_point(size = 0.2, alpha = 0.1, show.legend = FALSE) +
  geom_line(aes(x = SPO2, y = .fitted, group = ID),
            inherit.aes = FALSE, size = 1, alpha = 0.3, color = "#374e55") +
  geom_smooth(method = lm, se = FALSE, aes(x = SPO2, y = .fixed), color = "black", inherit.aes = FALSE, size = 1.5, alpha = 0.8) +
  xlab(expression(paste("SpO"[2], " (%)"))) +
  ylab("PCAv (cm/s)") +
  scale_x_reverse(breaks = c(0, 20, 40, 60, 80, 100), limits = c(105,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,105), expand = c(0,0)) +
  theme_pubr() +
  scale_color_jama() + 
  theme(plot.title = element_text(face="bold"))

# Adding in the marginal density plot to the right axis
fig <- ggMarginal(fig, colour = "black", fill = "#00A1d5", alpha = 0.8, size = 10)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/eFigure 4B.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

```{r eFigure 4C - SjvO2 vs SpO2}
# Selected the truncated data
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

df_temp <- df_temp %>% select(ID, SPO2, SJVO2) %>% drop_na() %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

#### Selecting linear mixed effects model ####
# Random intercept
MODEL1 <- df_temp %>%
  lmer(SJVO2 ~ SPO2 + (1 | ID), REML = TRUE, data = .)
# Random slope
MODEL2 <- df_temp %>%
  lmer(SJVO2 ~ SPO2 + (0 + SPO2 | ID), REML = TRUE, data = .)
# Random slopes, random intercept
MODEL3 <- df_temp %>%
  lmer(SJVO2 ~ SPO2 + (1 + SPO2 | ID), REML = TRUE, data = .)
output <- anova(MODEL1, MODEL2, MODEL3)

# The selected linear mixed model
LMM <- df_temp %>%
  ungroup() %>%
  nest() %>%
  mutate(model = map(data, ~lmer(SJVO2 ~ SPO2 + (1 + SPO2 | ID), REML = TRUE, data = .x, weight = percent)),
         anova = map(model, anova),
         anova = map(anova, tidy),
         glance = map(model, tidy),
         augment = map(model, broom.mixed::augment)
  )

# Creation of eFigure 4C
fig <- LMM %>% select(augment) %>% unnest(augment) %>%
  ggplot(., aes(x = SPO2, y = SJVO2)) +
  geom_point(size = 0.2, alpha = 0.1, show.legend = FALSE) +
  geom_line(aes(x = SPO2, y = .fitted, group = ID),
            inherit.aes = FALSE, size = 1, alpha = 0.3, color = "#374e55") +
  geom_smooth(method = lm, se = FALSE, aes(x = SPO2, y = .fixed), color = "black", inherit.aes = FALSE, size = 1.5, alpha = 0.8) +
  xlab(expression(paste("SpO"[2], " (%)"))) +
  ylab(expression(paste("S"[jv], "O"[2], " (%)"))) +
  scale_x_reverse(breaks = c(0, 20, 40, 60, 80, 100), limits = c(105,0), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 100, 20), limits = c(0,105), expand = c(0,0)) +
  theme_pubr() +
  scale_color_jama() + 
  theme(plot.title = element_text(face="bold"))

# Adding in the marginal density plot to the right axis
fig <- ggMarginal(fig, colour = "black", fill = "#00A1d5", alpha = 0.8, size = 10)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/eFigure 4C.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

```{r eFigure 4D - rSO2 vs SpO2}
# Selected the truncated data
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

df_temp <- df_temp %>% select(ID, SPO2, RSO2_R, RSO2_L) %>% drop_na() %>%
  mutate(rSO2 = (RSO2_R + RSO2_L)/2) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data)

#### Selecting linear mixed effects model ####
# Random intercept
MODEL1 <- df_temp %>%
  lmer(rSO2 ~ SPO2 + (1 | ID), REML = TRUE, data = .)
# Random slope
MODEL2 <- df_temp %>%
  lmer(rSO2 ~ SPO2 + (0 + SPO2 | ID), REML = TRUE, data = .)
# Random slopes, random intercept
MODEL3 <- df_temp %>%
  lmer(rSO2 ~ SPO2 + (1 + SPO2 | ID), REML = TRUE, data = .)
output <- anova(MODEL1, MODEL2, MODEL3)

# The selected linear mixed model
LMM <- df_temp %>%
  ungroup() %>%
  nest() %>%
  mutate(model = map(data, ~lmer(rSO2 ~ SPO2 + (1 + SPO2 | ID), REML = TRUE, data = .x, weight = percent)),
         anova = map(model, anova),
         anova = map(anova, tidy),
         glance = map(model, tidy),
         augment = map(model, broom.mixed::augment)
  )

# Creation of eFigure 4D
fig <- LMM %>% select(augment) %>% unnest(augment) %>%
  ggplot(., aes(x = SPO2, y = rSO2)) +
  geom_point(size = 0.2, alpha = 0.1, show.legend = FALSE) +
  geom_line(aes(x = SPO2, y = .fitted, group = ID),
            inherit.aes = FALSE, size = 1, alpha = 0.3, color = "#374e55") +
  geom_smooth(method = lm, se = FALSE, aes(x = SPO2, y = .fixed), color = "black", inherit.aes = FALSE, size = 1.5, alpha = 0.8) +
  xlab(expression(paste("SpO"[2], " (%)"))) +
  ylab(expression(paste("rSO"[2], " (%)"))) +
  scale_x_reverse(breaks = c(0, 20, 40, 60, 80, 100), limits = c(105,0), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0, 100, 20), limits = c(0,105), expand = c(0,0)) +
  theme_pubr() +
  scale_color_jama() + 
  theme(plot.title = element_text(face="bold"))

# Adding in the marginal density plot to the right axis
fig <- ggMarginal(fig, colour = "black", fill = "#00A1d5", alpha = 0.8, size = 10)

# Printing the figure to RMarkdown
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/eFigure 4D.pdf",
       fig,
       width = 4,
       height = 3,
       dpi = 1200)
```

### eFigure 5 {-}
```{r Individual O2EF vs MAP Comparisons, fig.width=8.5, fig.height=8}
# Whole body vs brain specific oxygen extraction fraction
df_temp <- df_signals %>% select(ID, TRUNC) %>% unnest(TRUNC) %>%
  select(ID, ABP, BRAIN_O2EF, MV_O2EF) %>%
  drop_na() %>%
  group_by(ID) %>% nest() %>%
  mutate(model = map(data, ~cor.test(x = .x$MV_O2EF,
                                     y = .x$BRAIN_O2EF,
                                     alternative = "two.sided",
                                     method = "pearson")),
         model = map(model, tidy))

# Calculating the Pearson R data
pearson <- df_temp %>%
  select(ID, model) %>%
  unnest(model) %>%
  select(ID, estimate, p.value) %>%
  rename(r = estimate) %>%
  mutate(r = round(r, 2))

#### Brain + Systemic O2EF vs MAP - Individual
fig <- df_signals %>% select(ID, TRUNC) %>% unnest(TRUNC) %>%
  mutate(ID = factor(ID,
                     levels = c("HIBI 11", "HIBI 12", "HIBI 21", "ICH 20",
                                "HIBI 24", "HIBI 29", "HIBI 32", "ICH 26",
                                "Sepsis 14", "Sepsis 19", "Sepsis 31", "SAH 23",
                                "TBI 15", "TBI 18", "TBI 27", "TBI 28"),
                     labels = c("HIBI 11, Male", "HIBI 12, Male", "HIBI 21, Male", "ICH 20, Female",
                                "HIBI 24, Male", "HIBI 29, Female", "HIBI 32, Male", "ICH 26, Male",
                                "Sepsis 14, Male", "Sepsis 19, Male", "Sepsis 31, Male", "SAH 23, Female",
                                "TBI 15, Male", "TBI 18, Male", "TBI 27, Male", "TBI 28, Male"))) %>%
  select(ID, ABP, BRAIN_O2EF, MV_O2EF) %>%
  drop_na() %>%
  pivot_longer(BRAIN_O2EF:MV_O2EF) %>%
  mutate(Extraction = factor(name, levels = c("BRAIN_O2EF", "MV_O2EF"),
                             labels = c("Brain", "Systemic"))) %>%
  ggplot(., aes(x = ABP, y = value, group = name, color = Extraction)) +
  ## Overlay the individual data points that the LOESS curve is fit through.
  geom_point(size = 0.1, alpha = 0.3) +
  geom_smooth(method = "loess", se = FALSE) +
  xlab("MAP (mmHg)") +
  ylab(expression(paste("O"[2], "EF (%)"))) +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,100), expand = c(0,0)) +
  facet_wrap(~ID, ncol = 4, scales = "free") +
  theme_pubr(legend = "none") +
  scale_color_manual(breaks = c("Brain", "Systemic"),
                     values = c("#E64B35", "#4DBBD5")) +
  scale_fill_manual(breaks = c("Brain", "Systemic"),
                    values = c("#E64B35", "#4DBBD5")) +
  theme(plot.title = element_text(face="bold"),
        panel.spacing.x = unit(0.3, "lines"),
        strip.text.x = element_text(size = 13, color = "white", face = "bold.italic"),
        strip.background = element_rect(color = "white", fill = "black"))

# Display eFigure 5
fig

# Saving the figure in the data_output graph folder
ggsave(filename = "../data_output/graphs/eFigure 5.pdf",
       fig,
       width = 12,
       height = 6,
       dpi = 1200)
```

### eFigure 6 {-}
```{r Control Data for Biomarkers, fig.width=2.5, fig.height=10.5}
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "biomarker_control")

# Creating the statistics for the comparison between pre (prior to WLST) and post (SBP <60 mmHg)
temp <- df %>%
  mutate(Timepoint = factor(Timepoint,
                            levels = c("Pre", "Post"),
                            ordered = TRUE)) %>%
  group_by(Variable) %>%
  nest() %>%
  mutate(ttest = map(data, ~t_test(data = .x,
                                   value ~ Timepoint,
                                   comparisons = NULL,
                                   ref.group = NULL,
                                   paired = TRUE,
                                   var.equal = TRUE,
                                   alternative = "two.sided",
                                   conf.level = 0.95,
                                   detailed = TRUE)),
         effect = map(data, ~cohens_d(data = .x,
                                      value ~ Timepoint,
                                      comparisons = NULL,
                                      ref.group = NULL,
                                      var.equal = TRUE
         ))) %>%
  mutate(ttest = map(ttest, ~.x %>% select(n1, p) %>% rename(N = n1,
                                                             pvalue = p) %>% mutate(pvalue = signif(pvalue, digits = 2))),
         effect = map(effect, ~.x %>% select(effsize) %>% mutate(effsize = signif(effsize, digits = 2)))) %>%
  unnest(c(ttest, effect))

# Creating the stock function for making the control figures
control_graph <- function(df, variable, YLAB, stat_height) {
  temp <- df %>% filter(Variable == variable)
  fig <- temp %>%
    unnest(data) %>%
    ggplot(., aes(x = Timepoint, y = value)) +
    ylab(YLAB) +
    geom_boxplot(aes(group = Timepoint),
                 width = 0.2,
                 color = "black",
                 fill = "#F39B7F",
                 position = position_nudge(x = c(-0.2, 0.2))) +
    stat_summary(fun.y = mean,
                 geom="point",
                 size = 3,
                 shape = 23,
                 fill = "white",
                 position = position_nudge(x = c(-0.2, 0.2))) +
    geom_point(aes(shape = Etiology),
               size = 2,
               alpha = 0.5,
               position = position_nudge(x = c(0.2, -0.2))) +
    geom_text(data = temp,
              aes(x = 1.5, y = stat_height,
                  label = paste0("N = ", N,
                                 ", d = ", effsize,
                                 ", P = ", pvalue)),
              fontface = "italic",
              size = 3, vjust = 1) +
    geom_line(aes(group = ID), position = position_nudge(x = c(0.2, -0.2))) +
    scale_x_discrete(labels = c("Pre", "Post"), expand = c(0.2,0.2)) +
    theme_pubr(legend = "none") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(size = 12, face = 4))
}

# Mean Arterial Pressure Figure for Control Data
fig_map <- control_graph(df = temp, variable = "ABP", YLAB = "MAP (mmHg)", 125) +
  scale_y_continuous(breaks = seq(20, 120, 20),
                     limits = c(10, 125),
                     expand = c(0,0)) +
  theme(axis.title.y = element_text(size = 16, face = 4),
        axis.text.x = element_blank())

# Peripheral Saturation of Oxygen Figure for Control Data
fig_spo2 <- control_graph(df = temp, variable = "SPO2", YLAB = "SpO2", 107) +
  scale_y_continuous(breaks = seq(0, 100, 20),
                     limits = c(0, 107),
                     expand = c(0,0)) +
  ylab(expression(bolditalic(paste("S"[p], "O"[2], " (%)")))) +
  theme(axis.title.y = element_text(size = 16, face = 4),
        axis.text.x = element_blank())

# Middle Cerebral Artery Blood Velocity Figure for Control Data
fig_mca <- control_graph(df = temp, variable = "MCA", YLAB = "MCAv (cm/s)", 125) +
  scale_y_continuous(breaks = seq(00, 120, 20),
                     limits = c(0, 125),
                     expand = c(0,0)) +
  theme(axis.title.y = element_text(size = 16, face = 4),
        axis.text.x = element_blank())

# Posterior Cerebral Artery Blood Velocity Figure for Control Data
fig_pca <- control_graph(df = temp, variable = "PCA", YLAB = "PCAv (cm/s)", 125) +
  scale_y_continuous(breaks = seq(00, 120, 20),
                     limits = c(0, 125),
                     expand = c(0,0)) +
  theme(axis.title.y = element_text(size = 16, face = 4))

# Control Panel
fig <- ggarrange(fig_map,
                 fig_spo2,
                 fig_mca,
                 fig_pca,
                 common.legend = TRUE,
                 legend = "bottom",
                 ncol = 1, nrow = 4,
                 align = "hv",
                 labels = c("A", "B", "C", "D"))

# Saving the figure to the graph output
ggsave(filename = "../data_output/graphs/eFigure 6A-D.pdf",
       fig,
       width = 2.5,
       height = 10.5,
       dpi = 1200)

# Displaying the figure in the RMarkdown
fig
```

```{r}
library(smplot2)
#### MAP 65 THRESHOLD ####
df_temp <- df_signals %>% select(!c(data, TRUNC)) %>% unnest(WLST)

# Linear interpolation without doing the first and last row.
df_temp <- df_temp %>% 
  select(ID, ABP, Rel_Time) %>%
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(ABP_itp = ABP,
                                         ABP_itp = zoo::na.approx(ABP, na.rm = FALSE)))) %>%
  unnest()

# Dropping the rows of data that are NA after interpolation
df_temp <- df_temp %>% select(ID, ABP_itp, Rel_Time) %>% drop_na() %>%
  mutate(THRESHOLD = if_else(ABP_itp <= 65, 65, 0))

df_AUC <- df_temp %>%
  filter(ABP_itp <= 65) %>%
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>%
                      mutate(group = if_else(Rel_Time - lag(Rel_Time) == 10, 0, 1),   # Tagging data to find discontinuous data
                             group = if_else(is.na(group), 0, group),   #cumsum can't handle NAs so converting all column values to numeric
                             csum = cumsum(group)))) %>%  # Denoting the different groups that need to be integrated
  unnest() %>%
  select(!group) %>%
  group_by(ID, csum) %>% # Grouping based on patient and then their discontinuous groups for AUC
  nest() %>%
  mutate(AUC_raw = map(data, ~sm_auc(.x$Rel_Time, .x$ABP_itp)),
         AUC_threshold = map(data, ~sm_auc(.x$Rel_Time, .x$THRESHOLD))) %>% # Calculating AUCs
  mutate(AUC_raw = as.numeric(AUC_raw),
         AUC_threshold = as.numeric(AUC_threshold),
         AUC_diff = AUC_threshold - AUC_raw) %>%
  filter(AUC_diff != 0)

df_AUC_MAP65 <- df_AUC %>%
  group_by(ID) %>%
  summarize(AUC_diff = sum(AUC_diff)) %>%
  arrange(AUC_diff) 

df_AUC_MAP65 %>%
  kable(., caption = "Individual AUCs (mmHg s) of hypotensive burden for MAP < 65") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  add_footnote("The largely different values is based on both the time and severity of injury") %>%
  collapse_rows(columns = c(1,2), valign = "top") %>%
  scroll_box(width = "100%", height = "300px") %>%
  print()

#### MAP 50 THRESHOLD ####
df_temp <- df_temp %>% select(ID, ABP_itp, Rel_Time) %>% drop_na()

df_AUC <- df_temp %>%
  filter(ABP_itp <= 50) %>%   # Condition for threshold
  group_by(ID) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>%
                      mutate(group = if_else(Rel_Time - lag(Rel_Time) == 10, 0, 1),   # Tagging data to find discontinuous data
                             group = if_else(is.na(group), 0, group),   #cumsum can't handle NAs so converting all column values to numeric
                             csum = cumsum(group)))) %>%  # Denoting the different groups that need to be integrated
  unnest() %>%
  select(!group) %>%
  group_by(ID, csum) %>% # Grouping based on patient and then their discontinuous groups for AUC
  nest() %>%
  mutate(AUC = map(data, ~sm_auc(.x$Rel_Time, .x$ABP_itp))) %>% # Calculating AUCs
  mutate(AUC = as.numeric(AUC)) %>%
  filter(AUC != 0) # Individual data points can't be integrated so they get an AUC of 0 so I threw them out.

df_AUC %>%
  group_by(ID) %>%
  summarize(AUC = sum(AUC)) %>%
  arrange(AUC) %>%
  kable(., caption = "Individual AUCs (mmHg s) of hypotensive burden for MAP < 50") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, bold = T) %>%
  add_footnote("The largely different values is based on both the time and severity of injury") %>%
  collapse_rows(columns = c(1,2), valign = "top") %>%
  scroll_box(width = "100%", height = "300px") %>%
  print()
```

```{r, include=FALSE}
#### MAP 50 Thresholds - Individual ####
unique(df_temp$ID)
for (i in unique(df_temp$ID)) {
  # Temporarily only using data for individual patients
  df_temp2 <- df_temp %>%
    filter(ID == i)
  
  # Making a figure as a visual for the amount of time and severity of hypotensive injury. This can be replicated for whichever threshold you wish
  fig <- df_temp2 %>%
    ggplot(., aes(x = Rel_Time, y = ABP_itp)) +
    geom_point(size = 0.2, alpha = 0.1, show.legend = FALSE) +
    annotate("rect", xmin = min(df_temp2$Rel_Time), xmax = max(df_temp2$Rel_Time), ymin = 0, ymax = 50, alpha = 0.5, fill = "red", color = NA) +
    geom_area(color = "black", fill = "white") +
    ggtitle(i) +
    xlab("Relative Time") +
    ylab("MAP (mmHg)") +
    scale_y_continuous(expand = c(0,1)) +
    scale_x_continuous(expand = c(0,0), breaks = c(0.05*max(df_temp2$Rel_Time), 0.95*max(df_temp2$Rel_Time)), labels = c("WLST", "Asystole")) +
    theme_pubr() +
    scale_color_jama() +
    scale_fill_jama() +
    theme(plot.title = element_text(face="bold"),
          axis.ticks.x = element_blank())
  
  # Saving each of the files to the output file
  ggsave(filename = paste0("../data_output/AUC_individual/MAP50_", i, ".pdf"), fig,
         width = 6,
         height = 4,
         dpi = 600)
}
```


```{r Change in cerebral AV biomarkers and AUCs of hypotensive or hypoxemic burden, fig.width=8.5, fig.height=15, fig.cap="**eFigure 6E-L.** The relationship between area under the curve for hypotensive or hypoxemic burden and change in cerebral gradient biomarkers of the neurovascular unit."}
# Only select columns that we want for our analysis
df_signals2 <- df_signals %>%
  select(ID, WLST) %>%
  unnest(WLST) %>%
  select(ID, ABP, SPO2, PCA, MCA, SBP, DBP, RowN:last_col())

# Linear interpolation without doing the first and last row.
df_temp <- df_signals2 %>%
  pivot_longer(ABP:DBP, names_to = "VARIABLE", values_to = "VALUE") %>%
  group_by(ID, VARIABLE) %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(VALUE_interpolate = VALUE,
                                         VALUE_interpolate = zoo::na.approx(VALUE, na.rm = FALSE))))

# This is a QA where you can go into each nested dataframe and see that things were interpolated properly for each 

# Dropping the rows of data that are NA after interpolation
df_temp <- df_temp %>% unnest(data) %>% select(!VALUE) %>% drop_na()

# Sort by variables that we will use for thresholds
df_MAP <- df_temp %>% filter(VARIABLE == "ABP") %>% pivot_wider(names_from = "VARIABLE", values_from = "VALUE_interpolate") %>% rename(VALUE = ABP)
df_SBP <- df_temp %>% filter(VARIABLE == "SBP") %>% pivot_wider(names_from = "VARIABLE", values_from = "VALUE_interpolate") %>% rename(VALUE = SBP)
df_DBP <- df_temp %>% filter(VARIABLE == "DBP") %>% pivot_wider(names_from = "VARIABLE", values_from = "VALUE_interpolate") %>% rename(VALUE = DBP)
df_SPO2 <- df_temp %>% filter(VARIABLE == "SPO2") %>% pivot_wider(names_from = "VARIABLE", values_from = "VALUE_interpolate") %>% rename(VALUE = SPO2)

# To achieve this quicker, we will use this function so that it is more modular
AUC_groupings <- function(df, threshold = 70){
  df <- df %>%
    mutate(THRESHOLD = if_else(VALUE <= threshold, threshold, 0)) %>%
    filter(VALUE <= threshold) %>%
    group_by(ID) %>%
    nest() %>%
    mutate(data = map(data, ~.x %>%
                        mutate(group = if_else(Rel_Time - lag(Rel_Time) == 10, 0, 1),   # Tagging data to find discontinuous data
                               group = if_else(is.na(group), 0, group),   #cumsum can't handle NAs so converting all column values to numeric
                               csum = cumsum(group)))) %>%  # Denoting the different groups that need to be integrated
    unnest(data) %>%
    select(!group) %>%
    group_by(ID, csum) %>% # Grouping based on patient and then their discontinuous groups for AUC
    nest() %>%
    mutate(AUC_raw = map(data, ~sm_auc(.x$Rel_Time, .x$VALUE)),
           AUC_threshold = map(data, ~sm_auc(.x$Rel_Time, .x$THRESHOLD))) %>% # Calculating AUCs
    mutate(AUC_raw = as.numeric(AUC_raw),
           AUC_threshold = as.numeric(AUC_threshold),
           AUC_diff = AUC_threshold - AUC_raw) %>%
    filter(AUC_diff != 0)
  
  df <- df %>%
    group_by(ID) %>%
    summarize(AUC_diff = sum(AUC_diff)) %>%
    arrange(AUC_diff) 
  
  return(df)
}

MAP65 <- AUC_groupings(df_MAP, 65) %>% rename(MAP65_AUC = AUC_diff)
MAP60 <- AUC_groupings(df_MAP, 60) %>% rename(MAP60_AUC = AUC_diff)
MAP50 <- AUC_groupings(df_MAP, 50) %>% rename(MAP50_AUC = AUC_diff)

SBP60 <- AUC_groupings(df_SBP, 60) %>% rename(SBP60_AUC = AUC_diff)
SBP50 <- AUC_groupings(df_SBP, 50) %>% rename(SBP50_AUC = AUC_diff)

SPO2_90 <- AUC_groupings(df_SPO2, 90) %>% rename(SPO2_90_AUC = AUC_diff)
SPO2_80 <- AUC_groupings(df_SPO2, 80) %>% rename(SPO2_80_AUC = AUC_diff)
SPO2_70 <- AUC_groupings(df_SPO2, 70) %>% rename(SPO2_70_AUC = AUC_diff)

# Merging all dataframes together so that you have an AUC spreadsheet
AUCs <- merge(MAP65, MAP60, all = T) %>%
  merge(MAP50, all = T) %>%
  merge(SBP60, all = T) %>%
  merge(SBP50, all = T) %>%
  merge(SPO2_90, all = T) %>%
  merge(SPO2_80, all = T) %>%
  merge(SPO2_70, all = T) %>%
  pivot_longer(MAP65_AUC:last_col()) %>%
  mutate(value = as.numeric(value)) %>%
  pivot_wider(names_from = name, values_from = value)

# Writing our AUC data to an output folder so that we can use it
write_csv(AUCs, file = "../data_output/data/AUCs_Thresholds.csv")

# Reading in the Quanterix HD-X data
df <- read_excel(path = DATA_REPOSITORY_PATH,
                 sheet = "serum_proteomics")

# Making an Etiology column and calculating cerebral arteriovenous gradients (Arterial - Jugular Venous)
df <- df %>%
  mutate(AV = Arterial - Jugular) %>%
  rename(Art = Arterial,
         JV = Jugular) %>%
  pivot_wider(names_from = Timepoint, values_from = c(Art, JV, AV)) %>%
  pivot_longer(Art_Pre:last_col(), names_to = "Variable", values_to = "Value") %>%
  mutate(Variable = factor(Variable,
                           levels = c("Art_Pre", "Art_Post", "JV_Pre", "JV_Post", "AV_Pre", "AV_Post"),
                           labels = c("Art_Pre", "Art_Post",
                                      "JV_Pre", "JV_Post",
                                      "AV_Pre", "AV_Post"),
                           ordered = TRUE))

# Removing data for final paper analysis and proper statistics.
df_bio <- df %>% 
  filter(ID != "ICH 13") %>%
  filter(ID != "HIBI 25") %>%
  mutate(keep = if_else(Biomarker == "Tau" & Dilution == "4x", 1,NA),
         keep = if_else(Biomarker == "UCH-L1" & Dilution == "4x", 1, keep),
         keep = if_else(Biomarker == "GFAP" | Biomarker == "Nf-L", 1, keep)) %>%
  filter(!is.na(keep)) %>%
  select(!c(keep))

df_AUC <- df_bio %>% separate(Variable, into = c("Vessel", "Timepoint"), sep = "_") %>%
  pivot_wider(names_from = "Timepoint", values_from = "Value") %>%
  mutate(Delta_time = Post - Pre) %>%
  merge(AUCs, all = T) %>%
  pivot_longer(Pre:Delta_time, names_to = "Timepoint", values_to = "Value") %>%
  pivot_longer(MAP65_AUC:SPO2_70_AUC, names_to = "AUC Metric", values_to = "AUC") %>%
  group_by(Biomarker, Vessel, Timepoint, `AUC Metric`) %>%
  nest() %>%
  filter(!is.na(Biomarker)) %>%
  mutate(CORR = map(data, ~cor.test(x = .x$AUC, y = .x$Value, method = "spearman", alternative = "two.sided")),
         CORR = map(CORR, tidy))

# GFAP MAP 65 AUC
MAP65_GFAP <- df_AUC %>% select(!CORR) %>%
  filter(Vessel == "AV" & `AUC Metric` == "MAP65_AUC" & Timepoint == "Delta_time" & Biomarker == "GFAP") %>%
  unnest(data) %>%
  ggplot(., aes(x = AUC, y = Value)) +
  geom_hline(yintercept = 0, color = "grey", linetype = "longdash", alpha = 0.5) +
  geom_point(size = 3, alpha = 0.7, shape = 23, color = "#374e55", fill = "#374e55") +
  xlab(expression(bold(paste("AUC MAP"["<65"], " (mmHg·s)")))) +
  ylab("Δa-v GFAP (pg/mL)") +
  geom_text(aes(x = 150000, y = 100000, label = paste0("P = 0.95")), fontface = "italic", color = "black") +
  scale_x_continuous(breaks = seq(0, 150000, 50000),
                     labels = c(expression("0"),
                                expression("0.5×10"^5),
                                expression("1×10"^5),
                                expression("1.5×10"^5)),
                      limits = c(0, 180000),
                      expand = c(0,50)) +
  scale_y_continuous(breaks = seq(-300000, 100000, 100000),
                     labels = c(expression("-3×10"^5),
                                expression("-2×10"^5),
                                expression("-1×10"^5),
                                expression("0"),
                                expression("1×10"^5)),
                     limits = c(-300000, 130000),
                     expand = c(0,0)) +
  theme_pubr() +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"),
        axis.title.y = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = c(0.8, 0.9),
        legend.spacing.y = unit(0, "cm"),
        legend.title = element_text(colour="black", size=10, 
                                    face="bold"),
        legend.text = element_text(size = 8, face="bold.italic"),
        legend.title.align=0.5,
        legend.key.size = unit(.4, "cm"))

# Nf-L MAP 65 AUC Graph
MAP65_NFL <- df_AUC %>% select(!CORR) %>%
  filter(Vessel == "AV" & `AUC Metric` == "MAP65_AUC" & Timepoint == "Delta_time" & Biomarker == "Nf-L") %>%
  unnest(data) %>%
  ggplot(., aes(x = AUC, y = Value)) +
  geom_hline(yintercept = 0, color = "grey", linetype = "longdash", alpha = 0.5) +
  geom_point(size = 3, alpha = 0.7, shape = 23, color = "#374e55", fill = "#374e55") +
  xlab(expression(bold(paste("AUC MAP"["<65"], " (mmHg·s)")))) +
  ylab("Δa-v Nf-L (pg/mL)") +
  geom_text(aes(x = 150000, y = 1500, label = paste0("P = 0.93")), fontface = "italic", color = "black") +
  scale_x_continuous(breaks = seq(0, 150000, 50000),
                     labels = c(expression("0"),
                                expression("0.5×10"^5),
                                expression("1×10"^5),
                                expression("1.5×10"^5)),
                      limits = c(0, 180000),
                      expand = c(0,50)) +
    scale_y_continuous(breaks = seq(-8000, 2000, 2000),
                     # labels = c(expression("-3×10"^5),
                     #            expression("-2×10"^5),
                     #            expression("-1×10"^5),
                     #            expression("0"),
                     #            expression("1×10"^5)),
                     limits = c(-8000, 2000),
                     expand = c(0,0)) +
  theme_pubr() +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"),
        axis.title.y = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = c(0.8, 0.9),
        legend.spacing.y = unit(0, "cm"),
        legend.title = element_text(colour="black", size=10, 
                                    face="bold"),
        legend.text = element_text(size = 8, face="bold.italic"),
        legend.title.align=0.5,
        legend.key.size = unit(.4, "cm"))

# Tau MAP <65 AUC
MAP65_TAU <- df_AUC %>% select(!CORR) %>%
  filter(Vessel == "AV" & `AUC Metric` == "MAP65_AUC" & Timepoint == "Delta_time" & Biomarker == "Tau") %>%
  unnest(data) %>%
  ggplot(., aes(x = AUC, y = Value)) +
  geom_hline(yintercept = 0, color = "grey", linetype = "longdash", alpha = 0.5) +
  geom_point(size = 3, alpha = 0.7, shape = 23, color = "#374e55", fill = "#374e55") +
  xlab(expression(bold(paste("AUC MAP"["<65"], " (mmHg·s)")))) +
  ylab("Δa-v Tau (pg/mL)") +
  geom_text(aes(x = 150000, y = 100, label = paste0("P = 0.68")), fontface = "italic", color = "black") +
  scale_x_continuous(breaks = seq(0, 150000, 50000),
                     labels = c(expression("0"),
                                expression("0.5×10"^5),
                                expression("1×10"^5),
                                expression("1.5×10"^5)),
                      limits = c(0, 180000),
                      expand = c(0,50)) +
  scale_y_continuous(breaks = seq(-300, 100, 100),
                     # labels = c(expression("-3×10"^5),
                     #            expression("-2×10"^5),
                     #            expression("-1×10"^5),
                     #            expression("0"),
                     #            expression("1×10"^5)),
                     limits = c(-350, 150),
                     expand = c(0,0)) +
  theme_pubr() +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"),
        axis.title.y = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = c(0.8, 0.9),
        legend.spacing.y = unit(0, "cm"),
        legend.title = element_text(colour="black", size=10, 
                                    face="bold"),
        legend.text = element_text(size = 8, face="bold.italic"),
        legend.title.align=0.5,
        legend.key.size = unit(.4, "cm"))

# UCH-L1 MAP 65 AUC
MAP65_UCHL1 <- df_AUC %>% select(!CORR) %>%
  filter(Vessel == "AV" & `AUC Metric` == "MAP65_AUC" & Timepoint == "Delta_time" & Biomarker == "UCH-L1") %>%
  unnest(data) %>%
  ggplot(., aes(x = AUC, y = Value)) +
  geom_hline(yintercept = 0, color = "grey", linetype = "longdash", alpha = 0.5) +
  geom_point(size = 3, alpha = 0.7, shape = 23, color = "#374e55", fill = "#374e55") +
  xlab(expression(bold(paste("AUC MAP"["<65"], " (mmHg·s)")))) +
  ylab("Δa-v UCH-L1 (pg/mL)") +
  geom_text(aes(x = 150000, y = 90, label = paste0("P = 0.48")), fontface = "italic", color = "black") +
  scale_x_continuous(breaks = seq(0, 150000, 50000),
                     labels = c(expression("0"),
                                expression("0.5×10"^5),
                                expression("1×10"^5),
                                expression("1.5×10"^5)),
                      limits = c(0, 180000),
                      expand = c(0,50)) +
  scale_y_continuous(breaks = seq(-100, 100, 50),
                     # labels = c(expression("-3×10"^5),
                     #            expression("-2×10"^5),
                     #            expression("-1×10"^5),
                     #            expression("0"),
                     #            expression("1×10"^5)),
                     limits = c(-100, 100),
                     expand = c(0,0)) +
  theme_pubr() +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"),
        axis.title.y = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = c(0.8, 0.9),
        legend.spacing.y = unit(0, "cm"),
        legend.title = element_text(colour="black", size=10, 
                                    face="bold"),
        legend.text = element_text(size = 8, face="bold.italic"),
        legend.title.align=0.5,
        legend.key.size = unit(.4, "cm"))

# GFAP SpO2 AUC
SPO2_90_GFAP <- df_AUC %>% select(!CORR) %>%
  filter(Vessel == "AV" & `AUC Metric` == "SPO2_90_AUC" & Timepoint == "Delta_time" & Biomarker == "GFAP") %>%
  unnest(data) %>%
  ggplot(., aes(x = AUC, y = Value)) +
  geom_hline(yintercept = 0, color = "grey", linetype = "longdash", alpha = 0.5) +
  geom_point(size = 3, alpha = 0.7, shape = 23, color = "#374e55", fill = "#374e55") +
  xlab(expression(bold(paste("AUC SpO"["2, <90"], " (%·s)")))) +
  ylab("Δa-v GFAP (pg/mL)") +
  geom_text(aes(x = 350000, y = 100000, label = paste0("P = 0.64")), fontface = "italic", color = "black") +
  scale_x_continuous(breaks = seq(0, 400000, 100000),
                     labels = c(expression("0"),
                                expression("1×10"^5),
                                expression("2×10"^5),
                                expression("3×10"^5),
                                expression("4×10"^5)),
                      limits = c(0, 430000),
                      expand = c(0,50)) +
  scale_y_continuous(breaks = seq(-300000, 100000, 100000),
                     labels = c(expression("-3×10"^5),
                                expression("-2×10"^5),
                                expression("-1×10"^5),
                                expression("0"),
                                expression("1×10"^5)),
                     limits = c(-300000, 130000),
                     expand = c(0,0)) +
  theme_pubr() +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"),
        axis.title.y = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = c(0.8, 0.9),
        legend.spacing.y = unit(0, "cm"),
        legend.title = element_text(colour="black", size=10, 
                                    face="bold"),
        legend.text = element_text(size = 8, face="bold.italic"),
        legend.title.align=0.5,
        legend.key.size = unit(.4, "cm"))

# Nf-L SpO2 90 AUC
SPO2_90_NFL <- df_AUC %>% select(!CORR) %>%
  filter(Vessel == "AV" & `AUC Metric` == "SPO2_90_AUC" & Timepoint == "Delta_time" & Biomarker == "Nf-L") %>%
  unnest(data) %>%
  ggplot(., aes(x = AUC, y = Value)) +
  geom_hline(yintercept = 0, color = "grey", linetype = "longdash", alpha = 0.5) +
  geom_point(size = 3, alpha = 0.7, shape = 23, color = "#374e55", fill = "#374e55") +
  xlab(expression(bold(paste("AUC SpO"["2, <90"], " (%·s)")))) +
  ylab("Δa-v Nf-L (pg/mL)") +
  geom_text(aes(x = 350000, y = 1500, label = paste0("P = 0.10")), fontface = "italic", color = "black") +
  scale_x_continuous(breaks = seq(0, 400000, 100000),
                     labels = c(expression("0"),
                                expression("1×10"^5),
                                expression("2×10"^5),
                                expression("3×10"^5),
                                expression("4×10"^5)),
                      limits = c(0, 430000),
                      expand = c(0,50)) +
  scale_y_continuous(breaks = seq(-8000, 2000, 2000),
                     # labels = c(expression("-3×10"^5),
                     #            expression("-2×10"^5),
                     #            expression("-1×10"^5),
                     #            expression("0"),
                     #            expression("1×10"^5)),
                     limits = c(-8000, 2000),
                     expand = c(0,0)) +
  theme_pubr() +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"),
        axis.title.y = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = c(0.8, 0.9),
        legend.spacing.y = unit(0, "cm"),
        legend.title = element_text(colour="black", size=10, 
                                    face="bold"),
        legend.text = element_text(size = 8, face="bold.italic"),
        legend.title.align=0.5,
        legend.key.size = unit(.4, "cm"))

# Tau SpO2 90 AUC
SPO2_90_TAU <- df_AUC %>% select(!CORR) %>%
  filter(Vessel == "AV" & `AUC Metric` == "SPO2_90_AUC" & Timepoint == "Delta_time" & Biomarker == "Tau") %>%
  unnest(data) %>%
  ggplot(., aes(x = AUC, y = Value)) +
  geom_hline(yintercept = 0, color = "grey", linetype = "longdash", alpha = 0.5) +
  geom_point(size = 3, alpha = 0.7, shape = 23, color = "#374e55", fill = "#374e55") +
  xlab(expression(bold(paste("AUC SpO"["2, <90"], " (%·s)")))) +
  ylab("Δa-v Tau (pg/mL)") +
  geom_text(aes(x = 350000, y = 100, label = paste0("P = 0.47")), fontface = "italic", color = "black") +
  scale_x_continuous(breaks = seq(0, 400000, 100000),
                     labels = c(expression("0"),
                                expression("1×10"^5),
                                expression("2×10"^5),
                                expression("3×10"^5),
                                expression("4×10"^5)),
                      limits = c(0, 430000),
                      expand = c(0,50)) +
  scale_y_continuous(breaks = seq(-300, 100, 100),
                     # labels = c(expression("-3×10"^5),
                     #            expression("-2×10"^5),
                     #            expression("-1×10"^5),
                     #            expression("0"),
                     #            expression("1×10"^5)),
                     limits = c(-350, 150),
                     expand = c(0,0)) +
  theme_pubr() +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"),
        axis.title.y = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = c(0.8, 0.9),
        legend.spacing.y = unit(0, "cm"),
        legend.title = element_text(colour="black", size=10, 
                                    face="bold"),
        legend.text = element_text(size = 8, face="bold.italic"),
        legend.title.align=0.5,
        legend.key.size = unit(.4, "cm"))

# UCH-L1 SpO2 <90 AUC
SPO2_90_UCHL1 <- df_AUC %>% select(!CORR) %>%
  filter(Vessel == "AV" & `AUC Metric` == "SPO2_90_AUC" & Timepoint == "Delta_time" & Biomarker == "UCH-L1") %>%
  unnest(data) %>%
  ggplot(., aes(x = AUC, y = Value)) +
  geom_hline(yintercept = 0, color = "grey", linetype = "longdash", alpha = 0.5) +
  geom_point(size = 3, alpha = 0.7, shape = 23, color = "#374e55", fill = "#374e55") +
  xlab(expression(bold(paste("AUC SpO"["2, <90"], " (%·s)")))) +
  ylab("Δa-v UCH-L1 (pg/mL)") +
  geom_text(aes(x = 350000, y = 90, label = paste0("P = 0.59")), fontface = "italic", color = "black") +
  scale_x_continuous(breaks = seq(0, 400000, 100000),
                     labels = c(expression("0"),
                                expression("1×10"^5),
                                expression("2×10"^5),
                                expression("3×10"^5),
                                expression("4×10"^5)),
                      limits = c(0, 430000),
                      expand = c(0,50)) +
  scale_y_continuous(breaks = seq(-100, 100, 50),
                     # labels = c(expression("-3×10"^5),
                     #            expression("-2×10"^5),
                     #            expression("-1×10"^5),
                     #            expression("0"),
                     #            expression("1×10"^5)),
                     limits = c(-100, 100),
                     expand = c(0,0)) +
  theme_pubr() +
  theme(plot.title = element_text(size = 12, color = "black", face = "bold"),
        axis.title.y = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = c(0.8, 0.9),
        legend.spacing.y = unit(0, "cm"),
        legend.title = element_text(colour="black", size=10, 
                                    face="bold"),
        legend.text = element_text(size = 8, face="bold.italic"),
        legend.title.align=0.5,
        legend.key.size = unit(.4, "cm"))

# MAP and SpO2 Area under the Curve verses changes in cerebral arteriovenous gradients of biomarkers
fig <- ggarrange(MAP65_GFAP, SPO2_90_GFAP,
                 MAP65_NFL, SPO2_90_NFL,
                 MAP65_TAU, SPO2_90_TAU,
                 MAP65_UCHL1, SPO2_90_UCHL1,
                 labels = c("E", "F",
                            "G", "H",
                            "I", "J",
                            "K", "L"),
                 align = "hv",
                 nrow = 4, ncol = 2)

# Saving the figure to the graph output
ggsave(filename = "../data_output/graphs/eFigure 6E-L.jpg",
       fig,
       width = 8.5,
       height = 15,
       dpi = 1200)

# Displaying the figure in the RMarkdown
fig
```


### eFigure 7 {-}
> **Data Processing Notes**:  
> The alamar NULISA data is a *relative* concentration which is normally expressed as log2 data. In order to perform data manipulations such as cerebral gradient analysis (AV; Arterial - Jugular venous concentrations), the data needs to be exponentiated, subtracted, then log transformed back into log2 data. You'll note that individual AV data looks like nothing is close to zero and somewhat polarized on the x-axis. This is normal as the log2 changes, detectable differences, and some level of measurement error will make it very hard to get values basically right on zero so there will be some stochastic noise there.  
>  
> The other issue with AV analysis is that it is not easily expressed as a log2 difference for volcano plots which is why the AV data is only presented in eFigure 7 as an exploratory analysis. Regardless, it is a way to determine what might being taken up by the brain or removed from the brain compared to control data which we feel can be an interesting future avenue for exploration.  

```{r Arterial Plasma Proteomics between Healthy Controls and Pre-WLST, fig.width=8.5, fig.height=20, fig.cap="**eFigure 7A.** Individual arterial plasma proteomic relationships between healthy control participants and patients prior to withdrawal of life-sustaining treatment."}
efig7a + ggtitle("A")
```

```{r Cerebral AV Gradient Proteomics between Healthy Controls and Pre-WLST, fig.width=8.5, fig.height=20, fig.cap="**eFigure 7B.** Individual cerebral arterial-to-jugular venous gradient plasma proteomic relationships between healthy control participants and patients prior to withdrawal of life-sustaining treatment."}
efig7b + ggtitle("B")
```

> These cerebral arterial-to-jugular venous gradients are an *instantaneous* release of biomarkers and will not represent bulk fluxes over time. Consequently, while statistics are one part of the story, they do not give a *rate* of release for biomarkers over time. To get at rate of release of biomarkers, more timepoints are needed in a short time frame to see how biomarkers are changing over a period of time/period of physiologic stress.  

```{r Arterial Plasma Proteomics between Pre-WLST and Post-WLST, , fig.width=8.5, fig.height=20, fig.cap="**eFigure 7C.** Individual arterial plasma proteomic relationships between patients prior to withdrawal of life-sustaining treatment and immediately after systolic blood pressure of <60 mmHg."}
efig7c + ggtitle("C")
```

```{r}
eFigure7 <- ggarrange(efig7a, efig7b, efig7c,
                 nrow = 1, ncol = 3,
                 labels = c("A", "B", "C"),
                 align = "hv")

ggsave(filename = "../data_output/graphs/eFigure 7.pdf",
       eFigure7,
       width = 15,
       height = 16,
       dpi = 1200)
```

## TABLES {- .tabset}

---

# Extra Individual Data Plots

## Individual Data Plots {-}

### CBv vs MAP {-}
```{r Individual CBv vs MAP Plots, fig.width=8.5, fig.height=20}
df_temp <- df_signals %>% select(!data) %>% unnest(TRUNC)

df_temp <- df_temp %>% select(ID, ABP, MCA, PCA) %>% 
  pivot_longer(c(MCA, PCA)) %>%
  drop_na() %>%
  nest() %>%
  mutate(data = map(data, ~.x %>% mutate(percent = 1/nrow(.x)))) %>%
  unnest(data) %>%
  mutate(Vessel = factor(name, levels = c("MCA", "PCA"), labels = c("MCAv", "PCAv")))

# Individual Relationships between Cerebral Blood Velocities and Mean Arterial Pressure
fig <- df_temp %>%
  ggplot(., aes(x = ABP, y = value, group = Vessel, color = Vessel)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, aes(x = ABP,
                                           y = value,
                                           fill = Vessel,
                                           color = Vessel), inherit.aes = TRUE, size = 0.7, alpha = 0.5) +
  xlab("MAP (mmHg)") +
  ylab("CBv (cm/s)") +
  scale_x_reverse(breaks = seq(0, 150, 30), limits = c(155,0), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100), limits = c(0,105), expand = c(0,0)) +
  theme_pubr(legend = "bottom") +
  scale_color_manual(breaks = c("MCAv", "PCAv"),
                     values = c("#DF8F44", "#53585F")) +
  facet_wrap(~ID, ncol = 3) +
  theme(plot.title = element_text(face="bold"),
        panel.spacing.x = unit(1, "lines"),
        strip.text.x = element_text(size = 12, color = "white", face = "bold.italic"),
        strip.background = element_rect(color = "white", fill = "#53585F"),
        # legend.background = element_rect(fill="lightgrey",
        #                                  size=0.5, linetype="solid", 
        #                                  colour ="black"),
        legend.title = element_text(colour="black", size=10, 
                                    face="bold"),
        legend.title.align=0.5)

fig
```

### Time Series Saturation Trends {-}
```{r, fig.width=8.5, fig.height=12, fig.cap="T_0 denotes WLST, T_1 denotes PEA."}
# Selecting the full range of data from WLST to PEA
df_temp <- df_signals %>% select(!data) %>% unnest(WLST)

# Calculation of average rSO2 valaue from bilateral near-infrared spectroscopy
df_temp <- df_temp %>% select(ID, Norm_Time, SJVO2, SPO2, RSO2_R, RSO2_L) %>%
  drop_na() %>%
  mutate(RSO2 = (RSO2_R + RSO2_L)/2) %>%
  select(!c("RSO2_R", "RSO2_L")) %>%
  pivot_longer(SJVO2:last_col(), names_to = "O2", values_to = "value") %>%
  filter(ID != "ICH 17", ID != "HIBI 29")

# Seeing how SpO2, rSO2, and SjvO2 trend throughout the dying process.
fig <- df_temp %>%
  ggplot(., aes(x = Norm_Time, y = value, group = O2, color = O2, alpha = 0.5)) +
  geom_smooth(method = "loess", se = F,
              size = 1, alpha = 0.5) +
  xlab("Normalized Time") +
  ylab("Oxygen Saturation (%)") +
  scale_y_continuous(breaks = seq(0, 100, 20),
                     limits = c(0, 110),
                     expand = c(0,3)) +
  scale_x_continuous(breaks = c(0,1), limits = c(0,1),
                     labels = c(expression("T"[0]), expression("T"[1])),
                     expand = c(0,0.01)) +
  theme_pubr(legend = "bottom") +
  scale_color_manual(breaks = c("SPO2", "RSO2",  "SJVO2"),
                     labels = c(expression(paste("S"[P], "O"[2])),
                                expression(paste("rSO"[2])),
                                expression(paste("S"[jv], "O"[2]))),
                     values = c("#B24745", "#6A6599",  "#00A1d5"),
                     name = expression(bolditalic(paste("O"[2], " Saturation")))) +
  facet_wrap(~ID, ncol = 2) +
  theme(plot.title = element_text(face="bold"),
        panel.spacing.x = unit(1, "lines"),
        strip.text.x = element_text(size = 10, color = "white", face = "bold.italic"),
        strip.background = element_rect(color = "white", fill = "#53585F"),
        legend.title = element_text(colour="black", size=10, 
                                    face="bold"),
        legend.title.align=0.5)

# Display figure
fig
```

---

# *Appendix & Resources* {-}

## Abbreviation Library {-}
|Metrics| Full Name|
|:-|:-|
|$ABP$          |Arterial blood pressure|
|$CBF$          |Cerebral blood flow|
|$CPP$          |Cerebral perfusion pressure|
|$CVC$          |Cerebrovascular conductance|
|$DBP$          |Diastolic blood pressure |
|$HIBI$         |Hypoxic ischemic brain injury|
|$HR$           |Heart rate|
|$ICP$          |Intracranial pressure|
|$MAP$          |Mean arterial pressure|
|$MCAv$         |Medial cerebral artery velocity|
|$O_2EF$        |Oxygen extraction fraction|
|$P_{ET}CO_2$   |Partial pressure of end-tidal carbon dioxide |
|$P_aCO_2$      |Arterial partial pressure of carbon dioxide|
|$P_{bt}O_2$    |Intraparenchymal pressure of oxygen|
|$PCAv$         |Posterior cerebral artery velocity|
|$rSO_2$        |Regional cerebral oxygen saturation|
|$S_{jv}O_2$    |Jugular venous oxygen saturation|
|$S_pO_2$       |Pulse oxygen saturation|

|Biomarkers| Full Name|
|:-|:-|
|$GFAP$         |Glial fibrillary acidic protein|
|$UCH-L1$       |Ubiquitin carboxy-terminal hydorlase L1|
|$Nf-L$         |Neurofilament-light|